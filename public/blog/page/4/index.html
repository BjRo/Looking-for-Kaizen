
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Dude, where's my Kaizen?</title>
  <meta name="author" content="BjÃ¶rn Rochel">

  
  <meta name="description" content="Castle.DynamicProxy is one of those really cool libraries with reallypoor documentation. Today I stumbled over Krysztof Kozmics blog, whichhas a &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.bjoernrochel.de/blog/page/4/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Dude, where's my Kaizen?" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

</head>

<body   >
  <header role="banner"><div id="logo">
	<img src="/images/kaizen.png" alt="Kaizen" title="Kaizen" />
</div>
<hgroup>
  <h1><a href="/">Dude, where's my Kaizen?</a></h1>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.bjoernrochel.de" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/07/28/a-good-resource-for-learning-castledynamicproxy/">A Good Resource for Learning Castle.DynamicProxy</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2009-07-28T21:19:37+02:00" pubdate  data-updated="true" >Jul 28<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Castle.DynamicProxy is one of those really cool libraries with really
poor documentation. Today I stumbled over Krysztof Kozmics blog, which
has a really, really good tutorial for Castle.DynamicProxy.</p>

<p>The tutorial covers most of its features. If you&#8217;re interested, give it a try. You
won&#8217;t regret it &#8230;</p>

<p>Here&#8217;s the link: <a href="http://kozmic.pl/category/23.aspx">http://kozmic.pl/category/23.aspx</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/07/24/cutting-the-fluff-from-service-registration-or-how-to-do-funky-stuff-with-coc-castledynamicproxy-structuremap/">Cutting the Fluff From Service Registration (or How to Do Funky Stuff With CoC, Castle.DynamicProxy & StructureMap)</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2009-07-24T18:46:07+02:00" pubdate  data-updated="true" >Jul 24<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The more I play around with Convention over Configuration in combination
with StructureMap the more I&#8217;m amazed about what you can do with it and
how much it reduces the amount of code you need in order to configure
and wire stuff together. Today I implemented this convention for our
current prototype:</p>

<blockquote><p>Every class whose class name ends with &#8216;Service&#8217; and who implements a
service interface ( &#8216;I&#8217; + ServiceName) is automatically registered as
a Singleton and proxied</p></blockquote>

<p>The reasoning behind this convention is that I&#8217;d like to remove a lot of
the common, redundant instrumentation code from Services in our
application. This includes for instance a lot of the logging, caching or
maybe argument validation aspects. It&#8217;s currently implemented using
Castle.DynamicProxy2 although the actual service call interceptors
haven&#8217;t been implemented so far. So let&#8217;s walk through the code and see
what is necessary in order to realize this.</p>

<p>First of all you need to implement the <code>ITypeScanner</code> interface. Its basic
purpose is to inspect every type which has been picked up in the
scanning process of StructureMap and do container registration with it
in case the type meets the expected criteria. The interface looks like
this.</p>

<figure class='code'><figcaption><span>StuctureMaps TypeScanner</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">ITypeScanner</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">void</span> <span class="nf">Process</span><span class="p">(</span><span class="n">Type</span> <span class="n">type</span><span class="p">,</span> <span class="n">PluginGraph</span> <span class="n">graph</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>StructureMap contains a handy base class which contains a lot of helper
methods for implementing a convention, the <code>TypeRules</code> class. The basic
code for my convention looks like this:</p>

<figure class='code'><figcaption><span>My convention </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ServicesAreSingletonsAndProxies</span> <span class="p">:</span> <span class="n">TypeRules</span><span class="p">,</span> <span class="n">ITypeScanner</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="cp">#region ITypeScanner Members </span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">Process</span><span class="p">(</span><span class="n">Type</span> <span class="n">type</span><span class="p">,</span> <span class="n">PluginGraph</span> <span class="n">graph</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(!</span><span class="n">IsConcrete</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">||</span> <span class="p">!</span><span class="n">IsService</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">||</span> <span class="p">!</span><span class="n">Constructor</span><span class="p">.</span><span class="n">HasConstructors</span><span class="p">(</span><span class="n">type</span><span class="p">))</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">var</span> <span class="n">pluginType</span> <span class="p">=</span> <span class="n">FindPluginType</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">pluginType</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">var</span> <span class="n">family</span> <span class="p">=</span> <span class="n">GetFamiliy</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">pluginType</span><span class="p">);</span>
</span><span class='line'>    <span class="n">var</span> <span class="n">instance</span> <span class="p">=</span> <span class="n">CreateInstance</span><span class="p">(</span><span class="n">pluginType</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">family</span><span class="p">.</span><span class="n">AddInstance</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
</span><span class='line'>    <span class="n">family</span><span class="p">.</span><span class="n">SetScopeTo</span><span class="p">(</span><span class="n">InstanceScope</span><span class="p">.</span><span class="n">Singleton</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="cp">#endregion </span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>When my convention inspects a type, it first checks whether the type is
concrete, the type name ends with <code>Service</code> and whether the type has a
public constructor. If any of this criteria is not satisfied the type is
ignored. Then it tries to find the primary interface for the concrete
type. In case an interface has been found a bit StructureMap magic is
applied which configures the DynamicProxy integration and the plugin
family to be scoped as Singletons.</p>

<p>In order to integrate DynamicProxy the registration has to be done a bit
differently compared to how I&#8217;ve described it in previous posts. Instead
of using <code>PluginGraph.AddType()</code> I&#8217;m using
<code>PluginGraph.AddInstance(IInstance)</code>. This gives you some more options for
configuration, including adding <code>InstanceInterceptors</code> which are called
when an instance is resolved via StructureMap. That&#8217;s the extension
point I&#8217;ve used. The configuration looks like this &#8230;</p>

<figure class='code'><figcaption><span>Configuring an interceptor</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="n">Instance</span> <span class="nf">CreateInstance</span><span class="p">(</span><span class="n">Type</span> <span class="n">pluginType</span><span class="p">,</span> <span class="n">Type</span> <span class="n">concreteType</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nf">ConfiguredInstance</span><span class="p">(</span><span class="n">concreteType</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">Interceptor</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DynamicProxyInterceptor</span><span class="p">(</span><span class="n">pluginType</span><span class="p">)</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>&#8230; and the code for the interceptor looks like this &#8230;</p>

<figure class='code'><figcaption><span>An Castle.DynamicProxy interceptor</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">DynamicProxyInterceptor</span> <span class="p">:</span> <span class="n">InstanceInterceptor</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">ProxyGenerator</span> <span class="n">ProxyGenerator</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ProxyGenerator</span><span class="p">();</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">Type</span> <span class="n">_pluginType</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="nf">DynamicProxyInterceptor</span><span class="p">(</span><span class="n">Type</span> <span class="n">pluginType</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">_pluginType</span> <span class="p">=</span> <span class="n">pluginType</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="cp">#region InstanceInterceptor Members </span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="kt">object</span> <span class="nf">Process</span><span class="p">(</span><span class="kt">object</span> <span class="n">target</span><span class="p">,</span> <span class="n">IContext</span> <span class="n">context</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">ProxyGenerator</span><span class="p">.</span><span class="n">CreateInterfaceProxyWithTargetInterface</span><span class="p">(</span>
</span><span class='line'>              <span class="n">_pluginType</span><span class="p">,</span>
</span><span class='line'>              <span class="n">target</span><span class="p">,</span>
</span><span class='line'>              <span class="k">new</span> <span class="nf">LoggingInterceptor</span><span class="p">());</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="cp">#endregion </span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&#8217;m using proxy creation over interfaces here. I prefer this over the
proxy over classes approach, because it doesn&#8217;t force implementation
constraints like having to make every public method virtual or the need
to inherit from <code>MarshalByRef</code> onto the service classes.</p>

<p>That&#8217;s basically it. The best of it: The whole rule can be easily tested
in a unit test. The following code uses xUnit.BDDExtensions for this.</p>

<figure class='code'><figcaption><span>Testing the convention with xUnit.BDDExtensions</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="na">[Concern(typeof (ServicesAreSingletonsAndProxies))]</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">When_applying_the__ServicesAreSingletonsAndProxies__convention</span> <span class="p">:</span> <span class="n">StaticContextSpecification</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="n">Container</span> <span class="n">_container</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Because</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">_container</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Container</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Scan</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="n">s</span><span class="p">.</span><span class="n">AssemblyContainingType</span><span class="p">&lt;</span><span class="n">IGuitarPlayerService</span><span class="p">&gt;();</span>
</span><span class='line'>      <span class="n">s</span><span class="p">.</span><span class="n">With</span><span class="p">&lt;</span><span class="n">ServicesAreSingletonsAndProxies</span><span class="p">&gt;();</span>
</span><span class='line'>    <span class="p">}));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="na">  </span>
</span><span class='line'><span class="na">  [Observation]</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">Should_register_all_classes_ending_with__Service__which_also_have_a_contract_interface</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">_container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IGuitarPlayerService</span><span class="p">&gt;().</span><span class="n">ShouldNotBeNull</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="na">  </span>
</span><span class='line'><span class="na">  [Observation]</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">Should_register_services_as_singletons_by_default</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">_container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IGuitarPlayerService</span><span class="p">&gt;().</span><span class="n">ShouldBeEqualTo</span><span class="p">(</span><span class="n">_container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">());</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">  [Observation]</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">Should_wrapp_a_service_in_a_dynamic_proxy_in_order_to_perform_AOPish_stuff</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">var</span> <span class="n">instance</span> <span class="p">=</span> <span class="n">_container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IGuitarPlayerService</span><span class="p">&gt;();</span>
</span><span class='line'>    <span class="n">instance</span><span class="p">.</span><span class="n">GetType</span><span class="p">().</span><span class="n">ShouldNotBeEqualTo</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">GuitarPlayerService</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#region Test helpers </span>
</span><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IGuitarPlayerService</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">GuitarPlayerService</span> <span class="p">:</span> <span class="n">IGuitarPlayerService</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'><span class="cp">#endregion </span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is the full code for this convention. Feel free to play with it / use it. That&#8217;s all for today.</p>

<p>Read you soon &#8230;</p>

<figure class='code'><figcaption><span>The full convention</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ServicesAreSingletonsAndProxies</span> <span class="p">:</span> <span class="n">TypeRules</span><span class="p">,</span> <span class="n">ITypeScanner</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="cp">#region ITypeScanner Members</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Process</span><span class="p">(</span><span class="n">Type</span> <span class="n">type</span><span class="p">,</span> <span class="n">PluginGraph</span> <span class="n">graph</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(!</span><span class="n">IsConcrete</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">||</span> <span class="p">!</span><span class="n">IsService</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">||</span> <span class="p">!</span><span class="n">Constructor</span><span class="p">.</span><span class="n">HasConstructors</span><span class="p">(</span><span class="n">type</span><span class="p">))</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">var</span> <span class="n">pluginType</span> <span class="p">=</span> <span class="n">FindPluginType</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">pluginType</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">var</span> <span class="n">family</span> <span class="p">=</span> <span class="n">GetFamiliy</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">pluginType</span><span class="p">);</span>
</span><span class='line'>        <span class="n">var</span> <span class="n">instance</span> <span class="p">=</span> <span class="n">CreateInstance</span><span class="p">(</span><span class="n">pluginType</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">family</span><span class="p">.</span><span class="n">AddInstance</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
</span><span class='line'>        <span class="n">family</span><span class="p">.</span><span class="n">SetScopeTo</span><span class="p">(</span><span class="n">InstanceScope</span><span class="p">.</span><span class="n">Singleton</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#endregion</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">static</span> <span class="n">Instance</span> <span class="nf">CreateInstance</span><span class="p">(</span><span class="n">Type</span> <span class="n">pluginType</span><span class="p">,</span> <span class="n">Type</span> <span class="n">concreteType</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">ConfiguredInstance</span><span class="p">(</span><span class="n">concreteType</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">Interceptor</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DynamicProxyInterceptor</span><span class="p">(</span><span class="n">pluginType</span><span class="p">)</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">static</span> <span class="n">PluginFamily</span> <span class="nf">GetFamiliy</span><span class="p">(</span><span class="n">PluginGraph</span> <span class="n">graph</span><span class="p">,</span> <span class="n">Type</span> <span class="n">pluginType</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(!</span><span class="n">graph</span><span class="p">.</span><span class="n">ContainsFamily</span><span class="p">(</span><span class="n">pluginType</span><span class="p">))</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">graph</span><span class="p">.</span><span class="n">CreateFamily</span><span class="p">(</span><span class="n">pluginType</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">graph</span><span class="p">.</span><span class="n">FindFamily</span><span class="p">(</span><span class="n">pluginType</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">IsService</span><span class="p">(</span><span class="n">Type</span> <span class="n">type</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">type</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="n">EndsWith</span><span class="p">(</span><span class="s">&quot;Service&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">static</span> <span class="n">Type</span> <span class="nf">FindPluginType</span><span class="p">(</span><span class="n">Type</span> <span class="n">concreteType</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">var</span> <span class="n">interfaceName</span> <span class="p">=</span> <span class="s">&quot;I&quot;</span> <span class="p">+</span> <span class="n">concreteType</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">concreteType</span>
</span><span class='line'>            <span class="p">.</span><span class="n">GetInterfaces</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="kt">string</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">interfaceName</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">Ordinal</span><span class="p">))</span>
</span><span class='line'>            <span class="p">.</span><span class="n">FirstOrDefault</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">DynamicProxyInterceptor</span> <span class="p">:</span> <span class="n">InstanceInterceptor</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">ProxyGenerator</span> <span class="n">ProxyGenerator</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ProxyGenerator</span><span class="p">();</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Type</span> <span class="n">_pluginType</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">DynamicProxyInterceptor</span><span class="p">(</span><span class="n">Type</span> <span class="n">pluginType</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">_pluginType</span> <span class="p">=</span> <span class="n">pluginType</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#region InstanceInterceptor Members</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">object</span> <span class="nf">Process</span><span class="p">(</span><span class="kt">object</span> <span class="n">target</span><span class="p">,</span> <span class="n">IContext</span> <span class="n">context</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">ProxyGenerator</span><span class="p">.</span><span class="n">CreateInterfaceProxyWithTargetInterface</span><span class="p">(</span>
</span><span class='line'>            <span class="n">_pluginType</span><span class="p">,</span>
</span><span class='line'>            <span class="n">target</span><span class="p">,</span>
</span><span class='line'>            <span class="k">new</span> <span class="nf">LoggingInterceptor</span><span class="p">());</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#endregion</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">[Concern(typeof (ServicesAreSingletonsAndProxies))]</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">When_applying_the__ServicesAreSingletonsAndProxies__convention_for_a_particular_interface</span> <span class="p">:</span> <span class="n">StaticContextSpecification</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="n">Container</span> <span class="n">_container</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Because</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">_container</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Container</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Scan</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">s</span><span class="p">.</span><span class="n">AssemblyContainingType</span><span class="p">&lt;</span><span class="n">IGuitarPlayerService</span><span class="p">&gt;();</span>
</span><span class='line'>            <span class="n">s</span><span class="p">.</span><span class="n">With</span><span class="p">&lt;</span><span class="n">ServicesAreSingletonsAndProxies</span><span class="p">&gt;();</span>
</span><span class='line'>        <span class="p">}));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">    [Observation]</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Should_register_all_classes_ending_with__Service__which_also_have_a_contract_interface</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">_container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IGuitarPlayerService</span><span class="p">&gt;().</span><span class="n">ShouldNotBeNull</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">    [Observation]</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Should_register_services_as_singletons_by_default</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">_container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IGuitarPlayerService</span><span class="p">&gt;().</span><span class="n">ShouldBeEqualTo</span><span class="p">(</span><span class="n">_container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IGuitarPlayerService</span><span class="p">&gt;());</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">    [Observation]</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Should_wrapp_a_service_in_a_dynamic_proxy_in_order_to_perform_AOPish_stuff</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">var</span> <span class="n">instance</span> <span class="p">=</span> <span class="n">_container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IGuitarPlayerService</span><span class="p">&gt;();</span>
</span><span class='line'>        <span class="n">instance</span><span class="p">.</span><span class="n">GetType</span><span class="p">().</span><span class="n">ShouldNotBeEqualTo</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">GuitarPlayerService</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#region Test helpers</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IGuitarPlayerService</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">GuitarPlayerService</span> <span class="p">:</span> <span class="n">IGuitarPlayerService</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#endregion</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/07/20/diving-into-the-storyteller-trunk-part-5-the-eventaggregator/">Diving Into the StoryTeller Trunk, Part 5: The EventAggregator</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2009-07-20T21:19:11+02:00" pubdate  data-updated="true" >Jul 20<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&#8217;ve spend some time with the Pub / Sub topic on my own in the past. Although I
still like my own implementation, even a year after I&#8217;ve originally
written it (yes, rare but sometimes that happens), I really like how
Jeremy implemented it. The <code>EventAggregator</code> in StoryTeller is one of
those examples of how much you can achieve with only a few lines of
code. So let&#8217;s go diving again ;-)</p>

<p>A type who is interested in recieving messages from the EventAggregator
in StoryTeller has to implement the <code>IListener&lt;T&gt;</code> interface where T
specifies the concrete message / event. A container extension is used
for automatic registration of instances at the <code>EventAggregator</code> after
instances have been created in the container (more on this later in the
post).</p>

<figure class='code'><figcaption><span>The listener interface </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IListener</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">void</span> <span class="nf">Handle</span><span class="p">(</span><span class="n">T</span> <span class="n">message</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The interface to the <code>EventAggregator</code> looks like this.</p>

<figure class='code'><figcaption><span>The EventAggregator interface </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IEventAggregator</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">void</span> <span class="n">SendMessage</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">action</span><span class="p">)</span> <span class="n">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">class</span><span class="p">;</span>
</span><span class='line'>  <span class="k">void</span> <span class="n">SendMessage</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">T</span> <span class="n">message</span><span class="p">);</span>
</span><span class='line'>  <span class="k">void</span> <span class="nf">AddListener</span><span class="p">(</span><span class="kt">object</span> <span class="n">listener</span><span class="p">);</span>
</span><span class='line'>  <span class="k">void</span> <span class="nf">RemoveListener</span><span class="p">(</span><span class="kt">object</span> <span class="n">listener</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Most of the interface looks familiar to me, except the
<code>SendMessage&lt;T&gt;(Action&lt;T&gt; action)</code> method. The <code>EventAggregator</code>
implementation in StoryTeller adds a interesting feature to the topic:
Using delegates instead of explicit event classes. One of the things
Jeremy mentioned in his NDC &#8220;Presentation Patterns&#8221; talk is that
sometimes creating event classes for events felt a bit tedious to him,
especially when those events only have signal character and don&#8217;t carry
any data with them around. IIRIC the varation with delegates instead of
event classes implemented in StoryTeller came up in discussion with
Glenn Block and the Prism team. However it didn&#8217;t make it into Prism in
the end. See the difference in usage for yourself:</p>

<figure class='code'><figcaption><span>Classic vs. delegate based messaging</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="c1">//Using message objects </span>
</span><span class='line'><span class="n">aggregator</span><span class="p">.</span><span class="n">SendMessage</span><span class="p">(</span><span class="k">new</span> <span class="n">ScreenClosingMessage</span><span class="p">(</span><span class="n">screen</span><span class="p">));</span>
</span><span class='line'><span class="c1">//Using delegates as messages</span>
</span><span class='line'><span class="n">aggregator</span><span class="p">.</span><span class="n">SendMessage</span><span class="p">&lt;</span><span class="n">IWantToKnowWhenAScreenClosed</span><span class="p">&gt;(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">ScreenHasClosed</span><span class="p">(</span><span class="n">screen</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>Below is the code for the <code>EventAggregator</code>. There are some interesting things to notice.</p>

<ul>
<li>First of all, the <code>EventBroker</code> doesn&#8217;t know about subscriptions for a
particular type. It only knows listener objects. Compatible
listeners are found on the fly when the event / message is published
by iterating over all known listener objects and calling the CallOn
extension method. I&#8217;ll spare the code for this extension method
because all it does is executing an <code>Action&lt;T&gt;</code> only when an object
can be cast to the type specified by <code>T</code>.</li>
<li>Automatic thread-synchronization to the main-thread is applied by
using the <code>SynchronizationContext</code> class. Imho, one of the gems in the
.NET 2.0 release that more people should be aware of. I think this
class is a really great feature for freeing client code from dealing
with callback synchronization issues. Just let the framework handle
the <code>InvokeRequired</code> stuff for you. No one likes to write that stuff
anyway.</li>
<li>Jeremy likes it functional ;-). I think this is an interesting
example how C# 3.0 code can actually differ from an 1.0
implementation. The shown code is really, really dense and focussed
by using a lot of the C# 2.0 and 3.0 features like lamda
expressions, extension methods and of course generics. Personally I
really like this coding style, however a lot of my colleagues don&#8217;t.
The debugging story differs a lot from the one using classic if and
for loops, which isn&#8217;t such a problem for the test-first or
test-parallel guys, but I can see where this might feel a bit
awkward when you&#8217;ve relied on the debugger for most of your
developing efforts in the past. In my opinion it&#8217;s just a matter of
personal taste. Just give it a try and make your own opinion &#8230;</li>
</ul>


<figure class='code'><figcaption><span>The EventAggregator as implemented in StoryTeller</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">EventAggregator</span> <span class="p">:</span> <span class="n">IEventAggregator</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">SynchronizationContext</span> <span class="n">_context</span><span class="p">;</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span> <span class="n">_listeners</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;();</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="kt">object</span> <span class="n">_locker</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">object</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="nf">EventAggregator</span><span class="p">(</span><span class="n">SynchronizationContext</span> <span class="n">context</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">_context</span> <span class="p">=</span> <span class="n">context</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="cp">#region IEventAggregator Members </span>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="n">SendMessage</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">action</span><span class="p">)</span> <span class="n">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span>
</span><span class='line'>  <span class="err">{ </span>
</span><span class='line'>    <span class="n">sendAction</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">all</span><span class="p">().</span><span class="n">Each</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">CallOn</span><span class="p">(</span><span class="n">action</span><span class="p">)));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="n">SendMessage</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">T</span> <span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">sendAction</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">all</span><span class="p">().</span><span class="n">CallOnEach</span><span class="p">&gt;(</span><span class="n">x</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="n">x</span><span class="p">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">AddListener</span><span class="p">(</span><span class="kt">object</span> <span class="n">listener</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">withinLock</span><span class="p">(()</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">_listeners</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">listener</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">_listeners</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">listener</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">RemoveListener</span><span class="p">(</span><span class="kt">object</span> <span class="n">listener</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">withinLock</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">_listeners</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">listener</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="cp">#endregion </span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">AddListeners</span><span class="p">(</span><span class="k">params</span> <span class="kt">object</span><span class="p">[]</span> <span class="n">listeners</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">foreach</span> <span class="p">(</span><span class="kt">object</span> <span class="n">listener</span> <span class="k">in</span> <span class="n">listeners</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="n">AddListener</span><span class="p">(</span><span class="n">listener</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="kt">bool</span> <span class="nf">HasListener</span><span class="p">(</span><span class="kt">object</span> <span class="n">listener</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">_listeners</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">listener</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">RemoveAllListeners</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">_listeners</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">protected</span> <span class="k">virtual</span> <span class="k">void</span> <span class="nf">sendAction</span><span class="p">(</span><span class="n">Action</span> <span class="n">action</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">_context</span><span class="p">.</span><span class="n">Send</span><span class="p">(</span><span class="n">state</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="n">action</span><span class="p">();</span> <span class="p">},</span> <span class="k">null</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">private</span> <span class="kt">object</span><span class="p">[]</span> <span class="nf">all</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">lock</span> <span class="p">(</span><span class="n">_locker</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">_listeners</span><span class="p">.</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">private</span> <span class="k">void</span> <span class="nf">withinLock</span><span class="p">(</span><span class="n">Action</span> <span class="n">action</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">lock</span><span class="p">(</span><span class="n">_locker</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="n">action</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As I said earlier in this post, instances are registered after they&#8217;ve been
created by the container. The functionality for this is provided by a
TypeInterceptor class. This class is part of the StructureMap API. Once
it has been registered every created instances is passed through this
interceptor after it has been resolved. If the instance is identified as
relevant for the <code>EventAggregator</code> it is automatically registered.</p>

<figure class='code'><figcaption><span>Integrating the EventAggregator into StructureMap</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">EventAggregatorInterceptor</span> <span class="p">:</span> <span class="n">TypeInterceptor</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="cp">#region TypeInterceptor Members </span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="kt">object</span> <span class="nf">Process</span><span class="p">(</span><span class="kt">object</span> <span class="n">target</span><span class="p">,</span> <span class="n">IContext</span> <span class="n">context</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">context</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IEventAggregator</span><span class="p">&gt;().</span><span class="n">AddListener</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">target</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="kt">bool</span> <span class="nf">MatchesType</span><span class="p">(</span><span class="n">Type</span> <span class="n">type</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">type</span><span class="p">.</span><span class="n">ImplementsInterfaceTemplate</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IListener</span><span class="p">&lt;&gt;))</span> <span class="p">||</span>
</span><span class='line'>      <span class="n">type</span><span class="p">.</span><span class="n">CanBeCastTo</span><span class="p">(</span><span class="k">typeof</span> <span class="p">(</span><span class="n">ITestListener</span><span class="p">))</span> <span class="p">||</span>
</span><span class='line'>      <span class="n">type</span><span class="p">.</span><span class="n">CanBeCastTo</span><span class="p">(</span><span class="k">typeof</span> <span class="p">(</span><span class="n">ICloseable</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="cp">#endregion </span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Conclusion</h2>

<p>EventAggregation is one of the standard patterns in modern enterprise
applications. I like the elegant way how Jeremy implemented this.
However having spend some time with this in the past, I miss a
functional part in his implementation: Type based subscriptions. Type
based subscriptions can be really handy when you&#8217;re implementing
PageFlows or state-ful MessageHandlers. Once a message is recieved the
type is resolved by the container and the related handler method is
called on the newly created type. I had them in my last application and
liked them a lot. Maybe StoryTeller goes alternative routes to achive a
similar effect. We&#8217;ll see as we proceed in the code &#8230;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/07/17/diving-into-the-storyteller-trunk-part-4-registration-of-generics/">Diving Into the StoryTeller Trunk, Part 4: Registration of Generics</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2009-07-17T22:36:55+02:00" pubdate  data-updated="true" >Jul 17<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I really like the way StructureMap automates the container registration.
Part 1 already showed a lot of the convention based container
registration mechanism. Today I would like to touch an aspect of
registration which doesn&#8217;t really fit under the term &#8220;convention over
configuration&#8221;, but is a really cool functionality non the less. For
this post I would like to take a look at what you can do with generic
types in StructureMap (taking you of course through some code parts of
StoryTeller).</p>

<p>Let&#8217;s start with a look at the <code>IScreenSubject</code> interface in the
StoryTeller trunk. This interface plays a very important role in the UI
layer of StoryTeller. Its basic responsibility is the creation and the
identification of a single screen. The whole topic will be part of later
posts, so don&#8217;t be mad with me, if I don&#8217;t go into full detail here.
What matters for the context of this post is that there is also an
<code>IScreenSubject&lt;T&gt;</code> marker interface.</p>

<figure class='code'><figcaption><span>The IScreenSubject interfaces</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IScreenSubject</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">bool</span> <span class="nf">Matches</span><span class="p">(</span><span class="n">IScreen</span> <span class="n">screen</span><span class="p">);</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">IScreen</span> <span class="nf">CreateScreen</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">//Marker interface </span>
</span><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IScreenSubject</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IScreenSubject</span> <span class="p">{</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you take a look at StoryTellers <code>UserInterfaceRegistry</code> class, the class containing all the StructureMap
configuration, you&#8217;ll notice a method on the configuration expression with the name
<code>ConnectImplementationsToTypesClosing</code> which takes a single open generic type as the parameter (The <code>IScreenSubject&lt;&gt;</code> type in
the following snippet).</p>

<figure class='code'><figcaption><span>ConnectImplmentationsToTypesClosing</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">UserInterfaceRegistry</span> <span class="p">:</span> <span class="n">Registry</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="nf">UserInterfaceRegistry</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="p">.</span> <span class="p">.</span> <span class="p">.</span>
</span><span class='line'>      <span class="n">Scan</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">x</span><span class="p">.</span><span class="n">TheCallingAssembly</span><span class="p">();</span>
</span><span class='line'>          <span class="n">x</span><span class="p">.</span><span class="n">WithDefaultConventions</span><span class="p">();</span>
</span><span class='line'>          <span class="n">x</span><span class="p">.</span><span class="n">ConnectImplementationsToTypesClosing</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IScreenSubject</span><span class="p">&lt;&gt;));</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>      <span class="p">.</span> <span class="p">.</span> <span class="p">.</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>For those of you who haven&#8217;t heard of open and closed generic types:
An open generic type is a generic type which doesn&#8217;t have his type parameters specified
(for instance <code>typeof(IListener&lt;&gt;)</code>), while a closed generic type is a generic type which has his type parameters
specified (for example <code>typeof(IListener&lt;string&gt;)</code>).</p>

<p>So what&#8217;s the deal with those types? StoryTeller has several
implementations of the <code>IScreenSubject&lt;T&gt;</code> interface. The following
snippet shows one of them. It has been a bit simplified for this post.
What&#8217;s important here is that because this type closes the <code>IScreenSubject&lt;T&gt;</code> type with the TestScreen type, it is automatically
registered in the container if it resides in one of the assemblies
scanned by StructureMap.</p>

<figure class='code'><figcaption><span>An test implementation of IScreenSubject<T></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">TestScreenSubject</span> <span class="p">:</span> <span class="n">IScreenSubject</span><span class="p">&lt;</span><span class="n">TestScreen</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">IContainer</span> <span class="n">_container</span><span class="p">;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="nf">ScreenSubject</span><span class="p">(</span><span class="n">IContainer</span> <span class="n">container</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">_container</span> <span class="p">=</span> <span class="n">container</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="cp">#region IScreenSubject Members </span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Matches</span><span class="p">(</span><span class="n">IScreen</span> <span class="n">screen</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">screen</span> <span class="k">is</span> <span class="n">TestScreen</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="n">IScreen</span> <span class="nf">CreateScreen</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">_container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">TestScreen</span><span class="p">&gt;();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="cp">#endregion </span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Client code can access this instance after registration via</p>

<figure class='code'><figcaption><span>Accessing our TestScreenSubject implementation</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IScreenSubject</span><span class="p">&lt;</span><span class="n">TestScreen</span><span class="p">&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<p>What we&#8217;ve seen so far is how instances can be automatically registered for closed generic interfaces
by StructureMap. However if we take a look at the <code>TestScreenSubject</code> class, isn&#8217;t there something which can be generalized and reused? In
fact you can find the <code>ScreenSubject&lt;SCREEN&gt;</code> class in the StoryTeller which looks like a generalized version of it.</p>

<figure class='code'><figcaption><span>A generic IScreenSubject<T> implementation</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ScreenSubject</span><span class="p">&lt;</span><span class="n">SCREEN</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IScreenSubject</span> <span class="n">where</span> <span class="n">SCREEN</span> <span class="p">:</span> <span class="n">IScreen</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">IContainer</span> <span class="n">_container</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="nf">ScreenSubject</span><span class="p">(</span><span class="n">IContainer</span> <span class="n">container</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">_container</span> <span class="p">=</span> <span class="n">container</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="cp">#region IScreenSubject Members</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Matches</span><span class="p">(</span><span class="n">IScreen</span> <span class="n">screen</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">screen</span> <span class="k">is</span> <span class="n">SCREEN</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="n">IScreen</span> <span class="nf">CreateScreen</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">_container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">SCREEN</span><span class="p">&gt;();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="cp">#endregion</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This class however isn&#8217;t automatically picked up by auto
registration or one of the conventions. Besides that, notice that this
is not an abstract class. So, using it as a base class in order to fit
in the <code>ConnectImplementationsToTypesClosing</code> scheme is probably not
really the main usage scenario for this class (although you could of
course do it). What we can do instead is register this class as the
default implementation for the <code>IScreenSubject&lt;T&gt;</code> interface. (SIDENOTE:
StoryTeller doesn&#8217;t really use this so the rest of the post is more or
less a StructureMap feature demo ;-))</p>

<figure class='code'><figcaption><span>Configuring the generic bits</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">UserInterfaceRegistry</span> <span class="p">:</span> <span class="n">Registry</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="nf">UserInterfaceRegistry</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="p">.</span> <span class="p">.</span> <span class="p">.</span>
</span><span class='line'>      <span class="n">For</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IScreenSubject</span><span class="p">&lt;&gt;)).</span><span class="n">TheDefaultIsConcreteType</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">ScreenSubject</span><span class="p">&lt;&gt;));</span>
</span><span class='line'>      <span class="p">.</span> <span class="p">.</span> <span class="p">.</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Looks strange at first, but it&#8217;s a really handy thing
once you&#8217;ve got used to it. Here&#8217;s an example how the container behaves
after both <code>TestScreenSubject</code> (implicitly by <code>ConnectAllTypeClosing</code>) and
<code>ScreenSubject&lt;T&gt;</code> (explicitly by <code>For</code>) have been registered.</p>

<figure class='code'><figcaption><span>How this is resolved from a client perspective</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="c1">//This will return an instance of the type TestScreenSubject </span>
</span><span class='line'><span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IScreenSubject</span><span class="p">&lt;</span><span class="n">TestScreen</span><span class="p">&gt;&gt;();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//This will return an instance of the ScreenSubject </span>
</span><span class='line'><span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IScreenSubject</span><span class="p">&lt;</span><span class="n">SomeOtherScreen</span><span class="p">&gt;&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<p>The container basically does this: If the requested closed generic type is
directly implemented by a registered type (<code>TestScreenSubject</code> here) this
type is resolved. On the other hand when the requested generic type is
not directly implemented by any registered type, but an open generic
type implementing the open version of the interface is registered
(<code>ScreenSubject&lt;&gt;</code> here) the container will close that type and return an
instance for it. AFAIK this is called &#8220;generic specialization&#8221;.</p>

<p>A simple example where generic specialization is really handy: You want to
implement validation. Therefore you create an <code>IValidator&lt;T&gt;</code> interface
and an standard implementation <code>Validator&lt;T&gt;</code> for it which validates
static rules based on attributes (string length, not null, etc). For one
particular type you realize that this is not sufficient, because maybe
you need some sort of catalog in order to validate correctly. With
generic specialization you&#8217;re able to introduce this special case for
the particular type very, very easily. Just follow the steps described
in this post. From a clients perspective nothing changes &#8230;</p>

<h2>Conclusion</h2>

<p>Generic specialization is one of the things I really love when using an
IoC. It&#8217;s one of those areas where IoC imho really shines. To be fair,
this ability is not StructureMap exclusive. Most of the other containers
have it, too. However, I&#8217;m amazed how much fluff (or ceremony as Jeremy
likes to say) can be cut from registration by StructureMap &#8230;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/07/15/diving-into-the-storyteller-trunk-part-3-the-ineedbuildup-convention/">Diving Into the StoryTeller Trunk, Part 3: The INeedBuildUp Convention</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2009-07-15T23:11:18+02:00" pubdate  data-updated="true" >Jul 15<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Another day in the trunk, another convention found. After all startable
instances have been started in the bootstrapping process, there is very
similar looking convention which acts upon the <code>INeedBuildUp</code> interface, a
marker interface. The code for it looks like this:</p>

<figure class='code'><figcaption><span>The INeedBuildUp convention </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">ObjectFactory</span><span class="p">.</span><span class="n">Model</span><span class="p">.</span><span class="n">PluginTypes</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">Implements</span><span class="p">&lt;</span><span class="n">INeedBuildUp</span><span class="p">&gt;())</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">To</span><span class="p">&lt;</span><span class="n">INeedBuildUp</span><span class="p">&gt;())</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Each</span><span class="p">(</span><span class="n">ObjectFactory</span><span class="p">.</span><span class="n">BuildUp</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>For each contract type which is assignable to the <code>INeedBuildUp</code> type, it
first resolves the contract type (via <code>ObjectFactory.GetInstance(Type)</code>)
and then performs a build up (via <code>ObjectFactory.BuildUp(object)</code>) on the
created instance.</p>

<p>When I initially saw this my first reaction was like &#8220;Hm, aren&#8217;t those
two methods doing more or less the same thing?&#8221; (new vs. existing
instances) Why should you chain them?</p>

<p>As it turns out there&#8217;s something wrong with my initial assessment. When
you take a look at the instances marked with the <code>INeedBuildUp</code> interface
you recognize some similarities between them:</p>

<ol>
<li>The marked classes are mostly WPF controls.</li>
<li>They&#8217;re explicitly registered with their contract type at the
container after they have been created.</li>
<li>They&#8217;ve got at least a single writable property marked with the
SetterPropertyAttribute. (Property injection is not implicitly
performed in StructureMap, it needs to be explicitly configured)</li>
</ol>


<p>What I&#8217;ve missed in the first run is that you can of course register
existing instances for a contract type in the container. When calling
<code>ObjectFactory.GetInstance</code> for the particular contract type, then you
simply obtain a reference to the configured, already existing instance.
So chaining <code>ObjectFactory.GetInstance</code> and <code>ObjectFactory.BuildUp</code> makes
sense for inserting dependencies into an instance which was not created
by the IoC in the first place. Is this the case here?</p>

<p>WPF Controls need to have a parameterless constructor in order to work
properly with the XAML engine and the WPF-designer. Mh, is
WPF-Design-Time-support the origin of this convention? Seems to be, but
I&#8217;m not 100% sure. Besides that, is this something a convention should
be defined for? To be honest, I&#8217;m undetermined &#8230;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/07/14/diving-into-the-storyteller-trunk-part-2-the-istartable-convention/">Diving Into the StoryTeller Trunk, Part 2: The IStartable Convention</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2009-07-14T09:49:46+02:00" pubdate  data-updated="true" >Jul 14<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In the last post I talked a bit about how &#8220;Convention over
Configuration&#8221; is applied to container registration in the StoryTeller
trunk. Another neat convention which can be found in the bootstrapping
process of StoryTeller is a convention around startable instances .</p>

<p>Each instance in the StoryTeller assemblies whose contract applies to
StructureMaps default convention and also contains the <code>IStartable</code>
interface is automatically resolved and started during bootstrapping.</p>

<p>For example: If you&#8217;ve defined an <code>IModuleLoaderService</code> contract</p>

<figure class='code'><figcaption><span>Marking a service as startable</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IStartable</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">void</span> <span class="nf">Start</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IModuleLoaderService</span> <span class="p">:</span> <span class="n">IStartable</span> <span class="p">{</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>and an implementation for it</p>

<figure class='code'><figcaption><span>Implementing Start()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ModuleLoaderService</span> <span class="p">:</span> <span class="n">IModuleLoaderService</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>the convention will automatically resolve that implementation and call
the <code>Start()</code> method on it. All of this is done by this little piece of
code:</p>

<figure class='code'><figcaption><span>The container model exposes everything we need</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">ObjectFactory</span><span class="p">.</span><span class="n">Model</span><span class="p">.</span><span class="n">PluginType</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">IsStartable</span><span class="p">())</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">ToStartable</span><span class="p">())</span>
</span><span class='line'>  <span class="p">.</span><span class="n">Each</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Start</span><span class="p">());</span>
</span></code></pre></td></tr></table></div></figure>


<p>The code itself is not that hard to understand. A bit LINQ combined with
two extension methods. The first one <code>IsStartable()</code> finds all known
known contracts (the plugin type) in the dependency graph who are
assignable to the <code>IStartable</code> type, while the second one (<code>ToStartable()</code>)
simply resolves any found contract type with the help of the container.</p>

<p>Short, simple and easy to remember ==> Love it</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/07/13/diving-into-the-storyteller-trunk-part1-convention-based-registration/">Diving Into the StoryTeller Trunk, Part 1: Convention Based Registration</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2009-07-13T08:26:34+02:00" pubdate  data-updated="true" >Jul 13<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Since I&#8217;ve read some bits about Rails I often wondered how &#8220;Convention
over Configuration&#8221; (CoC) might look like in a .NET environment.
StructureMap was (AFAIK) the first IoC container in the .Net realm which
provided functionality in order to combine conventions with dependency
injection. It&#8217;s not surprising that StoryTeller relies a lot on
StructureMap and CoC, considering that both tools share the same author.</p>

<p>So let&#8217;s dive into the StoryTeller trunk and look at how CoC is applied
inside the tool. I&#8217;m starting with the Bootstrapper of the application.
The main responsibility of the Bootstrapper (as its name implies) is to
boot up and configure StructureMap in order to wire together all the
parts of the application.</p>

<figure class='code'><figcaption><span>Hello Bootstrapper</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">IContainer</span> <span class="nf">BuildContainer</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">ObjectFactory</span><span class="p">.</span><span class="n">Initialize</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">x</span><span class="p">.</span><span class="n">AddRegistry</span><span class="p">&lt;</span><span class="n">UserInterfaceRegistry</span><span class="p">&gt;();</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">return</span> <span class="n">ObjectFactory</span><span class="p">.</span><span class="n">Container</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The StructureMap configuration is implemented using the nested closure
pattern. After the closure has been executed, the internal dependency
graph of StructureMap is sealed and cannot be changed anymore. I think
this has to do with the ILGeneration aspect of StructureMap.</p>

<p>A <code>Registry</code> is the abstraction which is used by StructureMap in order
to modularize the container configuration. If we take a look at the
<code>UserInterfaceRegistry</code> from StoryTeller we see a lot of interesting
stuff, but today I would like to focus on the particular part of the
Registry which configures all the conventions. It looks like this:</p>

<figure class='code'><figcaption><span>A registry dissected</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">UserInterfaceRegistry</span> <span class="p">:</span> <span class="n">Registry</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>      <span class="k">public</span> <span class="nf">UserInterfaceRegistry</span><span class="p">()</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="p">...</span>
</span><span class='line'>          <span class="n">Scan</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">x</span><span class="p">.</span><span class="n">TheCallingAssembly</span><span class="p">();</span>
</span><span class='line'>              <span class="n">x</span><span class="p">.</span><span class="n">AssemblyContainingType</span><span class="p">&lt;</span><span class="n">ITestEngine</span><span class="p">&gt;();</span>
</span><span class='line'>              <span class="p">...</span>
</span><span class='line'>              <span class="n">x</span><span class="p">.</span><span class="n">WithDefaultConventions</span><span class="p">();</span>
</span><span class='line'>              <span class="n">x</span><span class="p">.</span><span class="n">ConnectImplementationsToTypesClosing</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IContextualAction</span><span class="p">&lt;&gt;));</span>
</span><span class='line'>              <span class="p">...</span>
</span><span class='line'>          <span class="p">});</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you take a look at how most containers work today, you see a lot of
map-this-class-to-that-interface and
map-that-class-with-this-id-under-that-interface stuff when the
container is configured. All of this has to be done mostly by hand and
is very repetitive. Wouldn&#8217;t it be nice if the IoC container could give
us a helping hand and free us from most of this simple configuration
code? That&#8217;s exactly what StructureMap tries to do.</p>

<p>The <code>Scan</code> block configures StructureMap to automatically scan the
configured assemblies and pass each found type in those assemblies into
a chain of classes implementing the <code>ITypeScanner</code> interface. Those
classes are responsible for applying CoC in StructureMap. You can
register a class by adding a</p>

<figure class='code'><figcaption><span>Using a custom type scanner</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">x</span><span class="p">.</span><span class="n">With</span><span class="p">&lt;</span><span class="n">NameOfConcreteTypeScanner</span><span class="p">&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<p>to the scan block. The StructureMap assembly contains several
<code>ITypeScanner</code> implementations out of the box. One of them is the
<code>DefaultConventionsScanner</code> which is configured by</p>

<figure class='code'><figcaption><span>Using the default conventions</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">x</span><span class="p">.</span><span class="n">WithDefaultConventions</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>StructureMaps default convention does the following: For each concrete
type it looks for an interface whose name (minus the &#8220;I&#8221; prefix) matches
the name of the concrete type. If it finds one, it automatically
registers a mapping between those two types.</p>

<figure class='code'><figcaption><span>How DefaultConventionScanner is implemented</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">DefaultConventionScanner</span> <span class="p">:</span> <span class="n">TypeRules</span><span class="p">,</span> <span class="n">ITypeScanner</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">virtual</span> <span class="n">Type</span> <span class="nf">FindPluginType</span><span class="p">(</span><span class="n">Type</span> <span class="n">concreteType</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="kt">string</span> <span class="n">interfaceName</span> <span class="p">=</span> <span class="s">&quot;I&quot;</span> <span class="p">+</span> <span class="n">concreteType</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Array</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">concreteType</span><span class="p">.</span><span class="n">GetInterfaces</span><span class="p">(),</span> <span class="k">delegate</span> <span class="p">(</span><span class="n">Type</span> <span class="n">t</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">t</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="n">interfaceName</span><span class="p">;</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">Process</span><span class="p">(</span><span class="n">Type</span> <span class="n">type</span><span class="p">,</span> <span class="n">PluginGraph</span> <span class="n">graph</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="k">base</span><span class="p">.</span><span class="n">IsConcrete</span><span class="p">(</span><span class="n">type</span><span class="p">))</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">Type</span> <span class="n">pluginType</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">FindPluginType</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
</span><span class='line'>          
</span><span class='line'>          <span class="k">if</span> <span class="p">((</span><span class="n">pluginType</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">Constructor</span><span class="p">.</span><span class="n">HasConstructors</span><span class="p">(</span><span class="n">type</span><span class="p">))</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">graph</span><span class="p">.</span><span class="n">AddType</span><span class="p">(</span><span class="n">pluginType</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Conventions are really easy to implement, because the StructureMap
assembly provides a lot of the necessary functionality through extension
methods and base classes. Just to give you an example what you can also
do, here is an example from one of my current projects.</p>

<figure class='code'><figcaption><span>Registering named implementations</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">RegisterNamedImplementationsOf</span><span class="p">&lt;</span><span class="n">TContract</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">TypeRules</span><span class="p">,</span> <span class="n">ITypeScanner</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">ContractName</span> <span class="p">=</span> <span class="n">FindContractName</span><span class="p">();</span>
</span><span class='line'>  
</span><span class='line'>  <span class="cp">#region ITypeScanner Members </span>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">Process</span><span class="p">(</span><span class="n">Type</span> <span class="n">type</span><span class="p">,</span> <span class="n">PluginGraph</span> <span class="n">graph</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">IsConcrete</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">type</span><span class="p">.</span><span class="n">Implements</span><span class="p">&lt;</span><span class="n">TContract</span><span class="p">&gt;())</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="kt">string</span> <span class="n">name</span> <span class="p">=</span> <span class="n">FindImplementationName</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
</span><span class='line'>          
</span><span class='line'>          <span class="k">if</span> <span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">Constructor</span><span class="p">.</span><span class="n">HasConstructors</span><span class="p">(</span><span class="n">type</span><span class="p">))</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">graph</span><span class="p">.</span><span class="n">AddType</span><span class="p">(</span><span class="k">typeof</span> <span class="p">(</span><span class="n">TContract</span><span class="p">),</span> <span class="n">type</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="cp">#endregion </span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">private</span> <span class="kt">string</span> <span class="nf">FindImplementationName</span><span class="p">(</span><span class="n">Type</span> <span class="n">concreteType</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(!</span><span class="n">concreteType</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">ContractName</span><span class="p">))</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">concreteType</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="n">ContractName</span><span class="p">,</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">FindContractName</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="nf">typeof</span><span class="p">(</span><span class="n">TContract</span><span class="p">).</span><span class="n">Name</span><span class="p">.</span><span class="n">TrimStart</span><span class="p">(</span><span class="sc">&#39;I&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The convention basically does this: If you have an <code>IReportGenerator</code>
interface and one or more classes are found which implement the
interface and end with &#8220;ReportGenerator&#8221;, they are automatically
registered with their prefix in the container (for instance &#8220;Html&#8221; for
<code>HtmlReportGenerator</code> or &#8220;Text&#8221; for <code>TextReportGenerator</code>. You can set
this convention up by configuring</p>

<figure class='code'><figcaption><span>Registering our custom convention</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">x</span><span class="p">.</span><span class="n">With</span><span class="p">&lt;</span><span class="n">RegisterNamedImplementationsOf</span><span class="p">&lt;</span><span class="n">IReportGenerator</span><span class="p">&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Having configured it that way you&#8217;re able to access for instance
the &#8220;Html&#8221; generator by calling</p>

<figure class='code'><figcaption><span>Resolving our example generator</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IReportGenerator</span><span class="p">&gt;(</span><span class="s">&quot;Html&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<h2>Is there a downside of doing it that way?</h2>

<p>You certainly loose a lot of debuggability when assembling your
application based on conventions. For me personally this isn&#8217;t such a
big deal because I always try to use the debugger only when I have no
other option left and rely a lot on my test suite. What you need in
order to overcome this lack of debuggability is some reporting
functionality as a safety net for the rare situations where the
container doesn&#8217;t behave as you expect it to. To our luck StructureMap
contains helpers for those situations, for example</p>

<figure class='code'><figcaption><span>Asking the container to print out his configuration</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">ObjectFactory</span><span class="p">.</span><span class="n">WhatDoIHave</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>which gives a detailed report on the currently configured dependency graph or</p>

<figure class='code'><figcaption><span>Testing whether the container configuration is valid</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">ObjectFactory</span><span class="p">.</span><span class="n">AssertConfigurationIsValid</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>which validates the container configuration. A lot of the CoC stuff may
look like &#8220;voodhoo&#8221; or &#8220;black magic&#8221; to some developers at first, but I
think they should be able to get used to it. Conventions can be easily
documented and are in my opinion easier to remember as stuff like
if-you-want-to-register-this-you-need-to-add-it-to-file-XY-at-the-end-of-method-Z
&#8230;</p>

<p>That&#8217;s all for now. Next time we&#8217;ll look at how a kind of &#8220;startable
facitility&#8221; is implemented in StoryTeller &#8230;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/07/09/diving-into-the-storyteller-trunk/">Diving Into the StoryTeller Trunk</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2009-07-09T19:38:05+02:00" pubdate  data-updated="true" >Jul 9<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I just finished watching Jeremy D. Millers <a href="http://media01.smartcom.no/Microsite/go.aspx?eventid=4463&amp;urlback=null&amp;bitrate=665548">&#8220;Presentation Patterns&#8221;</a>
talk from this years <a href="http://www.ndc2009.no/en/">NDC</a>.</p>

<p>What he showed in the talk reminded me a lot of a prototype we build at
my last employer. The basic patterns &amp; principles we used are mostly the
same. Composite app, testable presentation layer, Presenter-First, IoC,
Event-Brokering with auto-registration, just to name a few.</p>

<p>I&#8217;m still really pleased with most of the code we wrote that time.
However, today I believe we didn&#8217;t get responsibilities right when it
comes to the whole screen creation &amp; screen activation lifecycle. This
was mainly done by a single component (the Region) in close
collaboration with the presenters. The Region did it&#8217;s job, but it was
effectively way to big and did too much. Besides that it was hard to
integrate some other stuff we wanted to do in an easy usable way
(context dependent command bindings for instance). I guess we hadn&#8217;t
really internalized SOLID at that time. (To be honest, I&#8217;m still
struggling with applying it correctly more often as I like).</p>

<p>Jeremy&#8217;s <a href="http://codebetter.com/blogs/jeremy.miller/archive/2007/07/25/the-build-your-own-cab-series-table-of-contents.aspx">&#8220;Build your own CAB&#8221;</a>
series was a real inspiration for our prototype. Some of the parts he
described (especially the thing with the <code>ScreenConductor</code>) were a bit
unclear for us, though. It&#8217;s good to finally have example code, which
can be examined, executed and learned from.</p>

<p>I must admit I&#8217;m pretty impressed judging from what I&#8217;ve seen so far in
the talk. Pretty good stuff. Because of that I decided to spend some
extra time with the StoryTeller sources over the next weeks and do some
Ayende-like
<em>I-write-this-while-I&#8217;m-looking-at-it-and-trying-to-figure-out-how-it-works-posts</em>
(Don&#8217;t get me wrong , I love them).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/07/08/thats-why-i-like-open-source/">Thatâs Why I Like Open Source &#8230;</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2009-07-08T23:19:01+02:00" pubdate  data-updated="true" >Jul 8<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today I received a really nice feature for xUnit.BDDExtensions from a
former colleague and friend of mine. It came to me completely with a
spec demonstrating and documenting its usage. Completely awesome. I wish
day to day software development would always be like that.</p>

<p>The feature deals with chained properties on interfaces. Consider the
following example: A presenter working against a composed passive view.</p>

<figure class='code'><figcaption><span>A complex MVP view interface</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IComplexView</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">ISubView</span> <span class="n">Header</span> <span class="p">{</span><span class="k">get</span><span class="p">;</span><span class="k">set</span><span class="p">;}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">ISubView</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">string</span> <span class="n">Description</span> <span class="p">{</span><span class="k">get</span><span class="p">;</span><span class="k">set</span><span class="p">;}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">Presenter</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="n">IComplexView</span> <span class="n">_view</span><span class="p">;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="nf">Presenter</span><span class="p">(</span><span class="n">IComplexView</span> <span class="n">view</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">_view</span> <span class="p">=</span> <span class="n">view</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">Initialize</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">_view</span><span class="p">.</span><span class="n">Header</span><span class="p">.</span><span class="n">Description</span> <span class="p">=</span> <span class="s">&quot;Some caption . . .&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>A spec documenting the behavior of the presenter can now look
like this if you&#8217;re using xUnit.BDDExtensions.</p>

<figure class='code'><figcaption><span>Using the HasProperties() extension method</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="na">[Concern(typeof(Presenter))]</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">When_the_presenter_is_initialized</span> <span class="p">:</span> <span class="n">InstanceContextSpecification</span><span class="p">&lt;</span><span class="n">Presenter</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">protected</span> <span class="k">override</span> <span class="nf">EstablishContext</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">The</span><span class="p">&lt;</span><span class="n">IComplexView</span><span class="p">&gt;().</span><span class="n">HasProperties</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Because</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">Sut</span><span class="p">.</span><span class="n">Initialize</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="na"> </span>
</span><span class='line'><span class="na"> [Observation]</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">It_should_set_the_headers_caption</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">The</span><span class="p">&lt;</span><span class="n">IComplexView</span><span class="p">&gt;().</span><span class="n">Header</span><span class="p">.</span><span class="n">Description</span><span class="p">.</span><span class="n">ShouldBeEqualTo</span><span class="p">(</span><span class="s">&quot;Some caption ... &quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>A really large portion of the necessary glue code has been
removed for that scenario. Only the <code>HasProperties()</code> extension method
remains.</p>

<p>Great work, Sergey. I really like the implementation of that feature &#8230;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/07/07/i-shot-me-again/">I Shot Me Again &#8230;</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2009-07-07T21:41:37+02:00" pubdate  data-updated="true" >Jul 7<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Earlier the day I wrote about my recent experience with <code>ILMerge</code>. As it turns out there were still some <code>Rhino.Mocks</code> related types which had to
be excluded (The ones related to the <code>WhenToldTo</code> / <code>WasToldTo</code> functionality). This issue should be fixed now with my last check-in.</p>

<p>Damn it ;-)</p>
</div>
  
  


    </article>
  
  <nav class="pagination">
    <div>
      
        <a class="prev" href="/blog/page/5/">&larr; Older</a>
      
      <a href="/blog/archives">Blog Archives</a>
      
      <a class="next" href="/blog/page/3/">Newer &rarr;</a>
      
    </div>
  </nav>
</div>
<aside class="sidebar">
  
    <section>
	<h1>About me</h1>
  <p><br/><img src="/images/bjro-eyes.jpg" alt="portrait" /></p>
	<p>
  My name is <strong>BjÃ¶rn Rochel</strong>.  I&#8217;m a 32 year old geek, who&#8217;s crazy about software development, living in Cologne and
  currently working for <a href="http://www.intercomponentware.com">ICW</a> as a Developer / Architect.
	</p>
	<ul class="badges">
		<li><a href="http://www.xing.com/profile/Bjoern_Rochel"><img src="/images/badges/xing2-small.png" alt="Xing" /></a></li>
		<li><a href="http://www.github.com/BjRo"><img src="/images/badges/github-small.png" alt="Github" /></a></li>
		<li><a href="http://www.twitter.com/bjoernrochel"><img src="/images/badges/twitter-square-small.png" alt="Twitter" /></a></li>
		<li><a href="/atom.xml"><img src="/images/badges/rss-circle-small.png" alt="Rss" /></a></li>
	</ul>
</section>

<section>
  <h1>Categories</h1>
  <ul id="categories">
    <li class='category'><a href='/blog/categories/Conferences/'>Conferences (8)</a></li>
<li class='category'><a href='/blog/categories/FSharp/'>FSharp (3)</a></li>
<li class='category'><a href='/blog/categories/Katas/'>Katas (2)</a></li>
<li class='category'><a href='/blog/categories/StoryTeller/'>StoryTeller (14)</a></li>
<li class='category'><a href='/blog/categories/StructureMap/'>StructureMap (9)</a></li>
<li class='category'><a href='/blog/categories/Testing/'>Testing (20)</a></li>
<li class='category'><a href='/blog/categories/Uncategorized/'>Uncategorized (8)</a></li>
<li class='category'><a href='/blog/categories/dotnet/'>dotnet (65)</a></li>
<li class='category'><a href='/blog/categories/ruby/'>ruby (3)</a></li>
<li class='category'><a href='/blog/categories/sw-design/'>sw-design (13)</a></li>
<li class='category'><a href='/blog/categories/xUnitBDDExtensions/'>xUnitBDDExtensions (15)</a></li>

  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("bjoernrochel", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/bjoernrochel" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @bjoernrochel</a>
  
</section>

<section>
<h1>Disclaimer</h1>
<p>
The opinions expressed herein are my own personal opinions and do not necessarily represent the opinion of any other organization or person, including (but not limited to) my fellow employees, my employer, its clients or their agents. 
</p>
<p>
 Copyright &copy; 2011 - BjÃ¶rn Rochel
</p>
<section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2011 - BjÃ¶rn Rochel -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'bjro';
      
        
        var disqus_script = 'count.js';
      

    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>







</body>
</html>
