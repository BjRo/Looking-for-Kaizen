
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Dude, where's my Kaizen?</title>
  <meta name="author" content="BjÃ¶rn Rochel">

  
  <meta name="description" content="I&#8217;ve just upgraded the trunk to the final 1.5 version of xUnit released last week. This update now allows BDDExtensions to be used with &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.bjoernrochel.de/blog/page/3/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Dude, where's my Kaizen?" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

</head>

<body   >
  <header role="banner"><div id="logo">
</div>
<hgroup>
  <h1><a href="/">Dude, where's my Kaizen?</a></h1>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.bjoernrochel.de" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/09/09/xunitbddextensions-now-runs-with-xunit-15-final/">xUnit.BDDExtensions Now Runs With xUnit 1.5 Final</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2009-09-09T23:25:33+02:00" pubdate  data-updated="true" >Sep 9<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&#8217;ve just upgraded the trunk to the final 1.5 version of <code>xUnit</code> released last week. This update now allows BDDExtensions to be used with the
latest version independant resharper runner for xUnit from xunitcontrib.</p>

<p>Current Version is 1.0.1.16. You can download it <a href="http://xunitbddextensions.googlecode.com/files/xunit.bddextensions.1.0.1.16.zip">here</a>
or get the latest sources from the <a href="http://xunitbddextensions.googlecode.com/svn/trunk/">trunk</a>.</p>

<p>Happy specifying &#8230;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/09/07/xunitbddextensions-update/">xUnit.BDDExtensions Update</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2009-09-07T09:07:51+02:00" pubdate  data-updated="true" >Sep 7<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>xUnit.BDDExtensions now uses <code>Rhino.Mocks 3.6</code> internally. I&#8217;ve just updated the trunk. As usual you can find it here:</p>

<p><a href="http://github.com/bjro/xunitbddextensions">http://github.com/bjro/xunitbddextensions</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/09/07/diving-into-the-storyteller-trunk-part-9-screensubject-screenfactory/">Diving Into the StoryTeller Trunk, Part 9: ScreenSubject & ScreenFactory</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2009-09-07T09:01:19+02:00" pubdate  data-updated="true" >Sep 7<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Hello back again on my little exploration of the UserInterface
implementation of Jeremy Millers StoryTeller. I&#8217;d like to start today
with a little excuse (oh my). Although I said last time that the current
post would be focused on the <code>ScreenConductor</code>, I decided to delay that at
least for one post in the series in order to add some content related to
what Jeremy calls <code>ScreenSubject</code> and <code>ScreenFactory</code>. I consider them to be
fairly simple but yet really powerful pattern which can help you a lot
to structure your UI layer, especially the fine line of the UI layer
where the UI infrastructure meets the common application code. It&#8217;s also
a very good example of applying the Open Closed Principle.</p>

<h2>The common use case for the ScreenSubject</h2>

<p>Lets first start with a little description of the usage of the two
patterns in StoryTeller. When application code wants to open a new
screen in StoryTeller it&#8217;ll probably use one of the <code>OpenScreen</code> overloads
on the <code>IScreenConductor</code> facade in order to do that.</p>

<figure class='code'><figcaption><span>Part of the IScreenConductor interface</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IScreenConductor</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">void</span> <span class="nf">OpenScreen</span><span class="p">(</span><span class="n">IScreenSubject</span> <span class="n">subject</span><span class="p">);</span>
</span><span class='line'>  <span class="k">void</span> <span class="nf">OpenScreen</span><span class="p">()</span> <span class="n">where</span> <span class="n">T</span><span class="p">:</span> <span class="n">IScreenSubject</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The common use case for the <code>ScreenSubject</code> can be easily depicted using a tool we all know quite
well, Visual Studio. Think about it: What happens when you click onto a
source code file in the Source Code Explorer for the first time? Well, a
new tab is created displaying the content of the file. However, if you
click the item in the Source Control Explorer the second time, the
previously created tab gets activated and NO NEW TAB IS CREATED.</p>

<h2>How is this implemented</h2>

<p>Let&#8217;s take a look at how this behavior is implemented in StoryTeller.
The following code snippet shows a very small part of the
<code>ScreenConductor</code>. I&#8217;ve inline some comments in order to make it more
visible what is going on there.</p>

<figure class='code'><figcaption><span>The OpenScreen method </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">virtual</span> <span class="k">void</span> <span class="nf">OpenScreen</span><span class="p">(</span><span class="n">IScreenSubject</span> <span class="n">subject</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">//_screens is of type IScreenCollection </span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">subject</span><span class="p">.</span><span class="n">Matches</span><span class="p">(</span><span class="n">_screens</span><span class="p">.</span><span class="n">Active</span><span class="p">))</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//This simply makes a LINQ-lookup on the ScreenCollection </span>
</span><span class='line'>  <span class="c1">//using ScreenSubject.Matches as a predicate </span>
</span><span class='line'>  <span class="n">IScreen</span> <span class="n">screen</span> <span class="p">=</span> <span class="n">findScreenMatchingSubject</span><span class="p">(</span><span class="n">subject</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">screen</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="c1">//This passes the global IScreenFactory into the </span>
</span><span class='line'>    <span class="c1">//ScreenSubjects CreateScreen method in order to create </span>
</span><span class='line'>    <span class="c1">//the screen. </span>
</span><span class='line'>    <span class="n">screen</span> <span class="p">=</span> <span class="n">createNewActiveScreen</span><span class="p">(</span><span class="n">subject</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">activate</span><span class="p">(</span><span class="n">screen</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">_screens</span><span class="p">.</span><span class="n">Show</span><span class="p">(</span><span class="n">screen</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>IScreenSubject</code> abstraction plays a quite important role in this use case. The interface defines
only two methods matching the responsibilities of the ScreenSubject</p>

<figure class='code'><figcaption><span>The IScreenSubject interface</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IScreenSubject</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">bool</span> <span class="nf">Matches</span><span class="p">(</span><span class="n">IScreen</span> <span class="n">screen</span><span class="p">);</span>
</span><span class='line'>  <span class="n">IScreen</span> <span class="nf">CreateScreen</span><span class="p">(</span><span class="n">IScreenFactory</span> <span class="n">factory</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>
As we saw in the <code>ScreenConductor</code> snippet the <code>Matches</code>
method is used as a predicate in order to find the related screen. The
<code>CreateScreen</code> method isn&#8217;t directly shown in the snippet, but it&#8217;s not
that complicated. It&#8217;s responsible for coordinating the creation of a
screen. When I say coordination I&#8217;m referring to the fact that the
actual screen creation is the responsibility of the <code>IScreenFactory</code>
(which is just a simple wrapper around StructureMap).</p>

<figure class='code'><figcaption><span>The IScreenFactory interface </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IScreenFactory</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">T</span> <span class="n">Build</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span> <span class="n">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">IScreen</span><span class="p">;</span>
</span><span class='line'>  <span class="n">IScreen</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">Build</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">T</span> <span class="n">subject</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this design in place we have a very nice extension point in place to do all kinds of
things around the screen creation. Want to do some deferred data loading
before the screen is shown? That&#8217;s your place. Maybe you want to show
some progress indicator while doing this. Guess what, that&#8217;s your place
to do this. And the best of it: The screen doesn&#8217;t have to know anything
of this, you can free him of this kind of logic. There&#8217;re some base
classes which provide some base implementation for different use cases
in StoryTeller. I&#8217;m only going to show one of them, the
<code>ScreenSubject&lt;T&gt;</code>. This class adds a bit generics on top of the
ScreenSubject (in order to allow auto-registration using StructureMaps
convention over configuration features).</p>

<figure class='code'><figcaption><span>ScreenSubject<T> </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="c1">// Marker interface </span>
</span><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IScreenSubject</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IScreenSubject</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ScreenSubject</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IScreenSubject</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">T</span> <span class="n">_subject</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="nf">ScreenSubject</span><span class="p">(</span><span class="n">T</span> <span class="n">subject</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">_subject</span> <span class="p">=</span> <span class="n">subject</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="cp">#region IScreenSubject Members </span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Matches</span><span class="p">(</span><span class="n">IScreen</span> <span class="n">screen</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">var</span> <span class="n">specific</span> <span class="p">=</span> <span class="n">screen</span> <span class="k">as</span> <span class="n">IScreen</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">specific</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">specific</span><span class="p">.</span><span class="n">Subject</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">_subject</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="n">IScreen</span> <span class="nf">CreateScreen</span><span class="p">(</span><span class="n">IScreenFactory</span> <span class="n">factory</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">factory</span><span class="p">.</span><span class="n">Build</span><span class="p">(</span><span class="n">_subject</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="cp">#endregion </span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Equals</span><span class="p">(</span><span class="n">ScreenSubject</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">other</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">ReferenceEquals</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="n">other</span><span class="p">))</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">ReferenceEquals</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">other</span><span class="p">))</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nf">Equals</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">_subject</span><span class="p">,</span> <span class="n">_subject</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">Equals</span><span class="p">(</span><span class="kt">object</span> <span class="n">obj</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">ReferenceEquals</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">ReferenceEquals</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">GetType</span><span class="p">()</span> <span class="p">!=</span> <span class="k">typeof</span> <span class="p">(</span><span class="n">ScreenSubject</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;))</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nf">Equals</span><span class="p">((</span><span class="n">ScreenSubject</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;)</span> <span class="n">obj</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">override</span> <span class="kt">int</span> <span class="nf">GetHashCode</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">_subject</span><span class="p">.</span><span class="n">GetHashCode</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>
The basic idea used in this implementation of <code>IScreenSubject</code> is that a <code>ScreenSubject</code> is related
to a single data instance. Coming back to the Visual Studio example,
this could have been represented as something like
<code>ScreenSubject&lt;SourceCodeFile&gt;</code>. Really interesting &#8230;</p>

<p>The last code snippet for today I&#8217;d like to show is how the <code>ScreenFactory</code> is actually
implemented. As usual really short, not very much code.</p>

<figure class='code'><figcaption><span>The ScreenFactory</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ScreenFactory</span> <span class="p">:</span> <span class="n">IScreenFactory</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">IContainer</span> <span class="n">_container</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="nf">ScreenFactory</span><span class="p">(</span><span class="n">IContainer</span> <span class="n">container</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">_container</span> <span class="p">=</span> <span class="n">container</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="cp">#region IScreenFactory Members</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="n">SCREEN</span> <span class="n">Build</span><span class="p">&lt;</span><span class="n">SCREEN</span><span class="p">&gt;()</span> <span class="n">where</span> <span class="n">SCREEN</span> <span class="p">:</span> <span class="n">IScreen</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">_container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">SCREEN</span><span class="p">&gt;();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="n">IScreen</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">Build</span><span class="p">(</span><span class="n">T</span> <span class="n">subject</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">_container</span><span class="p">.</span><span class="n">With</span><span class="p">(</span><span class="n">subject</span><span class="p">).</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="cp">#endregion </span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I really like the way how StructureMap allows injecting transient
parameters in the resolution process &#8230;</p>

<h2>Closing thoughts</h2>

<p>I&#8217;m honest with you. I consider <code>ScreenSubject</code> to be one of the most
valuable patterns I&#8217;ve learned so far while playing with the StoryTeller
sources. It provides such a nice extension point for screen
initialization. I think it&#8217;s one of those patterns you don&#8217;t know how
much you miss it until you see it for the first time and recognize how
much it could have helped you in the past. At least that was my
reaction. In the past I&#8217;ve put a lot of the functionality which resides
in StoryTeller in <code>ScreenSubject</code> implementations on my screens which
polluted my screens with a lot of initialization code and sometimes
(especially when you have high network latency) doesn&#8217;t even really look
good (I bet you know what I&#8217;m talking about, don&#8217;t you? I bet a lot of
you have seen the frozen screen, too). The <code>ScreenSubject</code> pattern was
introduced to my project last week and what can I say: I&#8217;m pretty happy
to have it in our application ;-)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/08/31/pimp-my-cab-or-how-to-integrate-an-existing-ioc-with-scsf/">Pimp My CAB, or How to Integrate an Existing IoC With SCSF</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2009-08-31T21:14:53+02:00" pubdate  data-updated="true" >Aug 31<span>st</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A LITTLE WARNING: This post goes pretty deep into the CAB framework
without examining the CAB basics. If you&#8217;re unfamiliar with CAB or SCSF
this post is probably not going to be very handy for you &#8230;</p>

<p>My current project uses the Smart Client Software Factory which is build on
top of the Composite UI Application Block from Microsofts Patterns &amp;
Practices department. SCSF is an organizational standard at my current
client and we&#8217;re reusing some components of earlier projects (Large
Parts of the Shell, Changetracking model etc.)</p>

<p>CAB is build around a very simple Dependency Injection machinery called the <code>ObjectBuilder</code>. I
consider having the <code>ObjectBuilder</code> a good thing, compared to having no
Dependency Injection at all. However if you&#8217;ve ever worked with any
other IoC be it StructureMap, Unity, Windsor, NInject or some other
container, you&#8217;ll recognize pretty fast some limitations. Its dependency
injection mechanism</p>

<ul>
<li>can&#8217;t really be used without attributes.</li>
<li>doesn&#8217;t separate registration and creation very well, which often
leads to ordering problems.</li>
<li>can&#8217;t close open generic types. If you&#8217;ve ever used generic
specialization you&#8217;re going to miss this.</li>
<li>is pretty tightly coupled to the concept of <code>WorkItems</code> inside CAB.</li>
</ul>


<p>The last point is actually the real pain point for me. The whole
<code>WorkItem</code> API is way to general purpose and generic (meaning string
based!!!) in many parts and actually not the kind of concept I would
like to be a central piece of my application design. It&#8217;s not intuitive
to work with it and imho doesn&#8217;t fall into the pit of success at all.</p>

<p>Interestingly when you compare PRISM (which was also build by P&amp;P about
two years later) to CAB you&#8217;re going to recognize that the concept of
WorkItems is completely missing in PRISM. Maybe I&#8217;m not the only one who
feels that way. Our team decided very early that the whole contact area
of our application to the CAB framework should be limited to the
presentation layer. We wanted to use a fully fledged IoC on the lower
layers. This lead to an intersting challenge: How to integrate those two
pipelines? My initial thought was to replace the <code>CreationStrategy</code> used
in CABs <code>Builder</code> class with something that reaches into our main
container. This turned out not to be the best choice since a lot of CABs
internal structure kind of relates to the standard behavior. I got
something working for about half of the use cases, but it didn&#8217;t really
feel good.</p>

<p>You know the best ideas come up when you stand under the
shower. At least this happened yesterday. Actually integrating those two
things is pretty straight forward. I just needed to approach the problem
differently. CAB is build around attributes. A typical CAB service might
look like this.</p>

<figure class='code'><figcaption><span>A service using CAB</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">NavigationService</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="nf">NavigationService</span><span class="p">([</span><span class="n">ServiceDependency</span><span class="p">]</span> <span class="n">IShell</span> <span class="n">shell</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>ServiceDependencyAttribute</code> tells the
<code>ObjectBuilder</code> that it should get the dependency from the collection of
services associated with the related <code>WorkItem</code> used to create the class.
The interesting part is that this isn&#8217;t a marker attribute. It&#8217;s a fully
fledged extension point to which the <code>ObjectBuilder</code> delegates the
essential work of resolving an instance.</p>

<blockquote><p>Here&#8217;s the deal: You can write a custom tailored attribute which is
called by the ObjectBuilder but uses your main IoC in order to resolve
the dependency</p></blockquote>

<p>The implementation of this is actually pretty easy. Here are the steps
you need to implement.</p>

<h2>1. Create a Static Gateway into your container</h2>

<p>Attributes are by their nature kind of static and created by the
framework. In order to be able to call into my container from an
attribute I created a static class which holds a reference to my
container (You can of course also use the P&amp;P CommonServiceLocator for
this).</p>

<figure class='code'><figcaption><span>Create a static gateway into your container</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">Container</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">static</span> <span class="n">IContainer</span> <span class="n">_container</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">SetContainer</span><span class="p">(</span><span class="n">IContainer</span> <span class="n">container</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">_container</span> <span class="p">=</span> <span class="n">container</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="kt">object</span> <span class="nf">Resolve</span><span class="p">(</span><span class="n">Type</span> <span class="n">type</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">_container</span><span class="p">.</span><span class="n">Resolve</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>2. Create an attribute deriving from ParameterAttribute</h2>

<p>The responsibility of <code>ParameterAttributes</code> in the <code>ObjectBuilder</code> is pretty
limited. All they have to do is to create an implementation of the
<code>IParameter</code> interface which will than be used to do the actual resolving.
If you&#8217;re wondering what the membertype is, that&#8217;s the type of the
parameter marked with the attribute (in the example code above this
would be <code>IShell</code>). The <code>CreateParameter</code> method will automatically be
called by the <code>ObjectBuilder</code> during the creation process.</p>

<figure class='code'><figcaption><span>Creating a custom ParameterAttribute</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ContainerDependencyAttribute</span> <span class="p">:</span> <span class="n">ParameterAttribute</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">override</span> <span class="n">IParameter</span> <span class="nf">CreateParameter</span><span class="p">(</span><span class="n">Type</span> <span class="n">memberType</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nf">ContainerParameter</span><span class="p">(</span><span class="n">memberType</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>3. Create an implementation of IParameter which calls into your static gateway</h2>

<p>The <code>IParameter</code> interface defines two methods <code>GetParameterType</code> and <code>GetValue</code>.</p>

<figure class='code'><figcaption><span>The IParameter interface</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IParameter</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">Type</span> <span class="nf">GetParameterType</span><span class="p">(</span><span class="n">IBuilderContext</span> <span class="n">buildContext</span><span class="p">);</span>
</span><span class='line'>  <span class="kt">object</span> <span class="nf">Getvalue</span><span class="p">(</span><span class="n">IBuilderContext</span> <span class="n">buildContext</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We simply implement the first one with returning the member type and the the
second one with a call into our Gateway.</p>

<figure class='code'><figcaption><span>A parameter that calls into our container</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ContainerParameter</span> <span class="p">:</span> <span class="n">IParameter</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="n">Type</span> <span class="n">_typeToResolve</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="nf">ContainerParameter</span><span class="p">(</span><span class="n">Type</span> <span class="n">typeToResolve</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">_typeToResolve</span> <span class="p">=</span> <span class="n">typeToResolve</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="n">Type</span> <span class="nf">GetParameterType</span><span class="p">(</span><span class="n">IBuilderContext</span> <span class="n">buildContext</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">_typeToResolve</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="kt">object</span> <span class="nf">Getvalue</span><span class="p">(</span><span class="n">IBuilderContext</span> <span class="n">buildContext</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">Container</span><span class="p">.</span><span class="n">Resolve</span><span class="p">(</span><span class="n">_typeToResolve</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Here is an example how it is used</h2>

<figure class='code'><figcaption><span>Using the new attribute</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">SomePresenter</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="nf">SomePresenter</span><span class="p">(</span>
</span><span class='line'><span class="na">    [ServiceDependency]</span> <span class="n">INavigationService</span> <span class="n">navigationService</span><span class="p">,</span>
</span><span class='line'><span class="na">    [ContainerDependency]</span> <span class="n">ISomeService</span> <span class="n">someService</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>At least for us, this works like a charm. What I like about the solution is
that it plays nicely by the rules of the CAB framework and doesn&#8217;t fight
the framework design, but still enables us to use the framework in a way
we want to use it. The interesting aspect in this approach is that
you&#8217;re now able to haved mixed dependencies where one part is resolved
using the surrounding CAB <code>WorkItem</code> and the other part is resolved using
your container of choice. The whole attribute usage is limited to the
presentation layer while the rest of the application can take advantage
of fully fledged dependency injection without attribute, with generic
specicialization and dynamic proxy generation, just to name a few
options.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/08/28/implementing-the-notification-pattern-using-dataannotation-validators/">Implementing the Notification Pattern Using DataAnnotation Validators</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2009-08-28T15:38:24+02:00" pubdate  data-updated="true" >Aug 28<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Some weeks ago a friend of mine told me about
<code>System.ComponentModel.DataAnnotations</code>. It&#8217;s a relatively new addition to
the framework, mainly Asp.net related (mh, was it Mvc or Asp.net Dynamic
Data? I&#8217;m sure he told me, but I can&#8217;t remember). Although I&#8217;m more
focussed on client side development (WinForms + WPF), what he told me
made me curious enough to spend some time with it in order to
investigate whether the DataAnnotation framework could be reused for
validation in a desktop app.</p>

<h2>Background</h2>

<p>What I was particulary interested in was whether I could use it in order to implement some sort
of declarative validation (for most of the standard cases) on my WPF
ViewModels. The usage I wanted to achieve was something similar to the
code shown in the next listing.</p>

<figure class='code'><figcaption><span>A ViewModel with valiation annotations</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">CustomerViewModel</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>     <span class="k">private</span> <span class="n">IValidator</span><span class="p">&lt;</span><span class="n">CustomerViewModel</span><span class="p">&gt;</span> <span class="n">_validator</span><span class="p">;</span>
</span><span class='line'>     <span class="k">private</span> <span class="n">NotificationCollection</span> <span class="n">_notifications</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="na">     [Required]</span>
</span><span class='line'><span class="na">     [MinLenght(3)]</span>
</span><span class='line'><span class="na">     [DisplayName(&quot;First name&quot;)]</span>
</span><span class='line'>     <span class="k">public</span> <span class="kt">string</span> <span class="n">FirstName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">     [Required]</span>
</span><span class='line'><span class="na">     [MinLenght(3)]</span>
</span><span class='line'><span class="na">     [DisplayName(&quot;Last name&quot;)]</span>
</span><span class='line'>     <span class="k">public</span> <span class="kt">string</span> <span class="n">LastName</span>  <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">     [Required(ErrorMessage=&quot;The field Email address is mandatory&quot;)]</span>
</span><span class='line'><span class="na">     [ValidEmail]</span>
</span><span class='line'><span class="na">     [DisplayName(&quot;Email address&quot;)]</span>
</span><span class='line'>     <span class="k">public</span> <span class="kt">string</span> <span class="n">EmailAddress</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">public</span> <span class="nf">CustomerViewModel</span><span class="p">(</span><span class="n">IValidator</span><span class="p">&lt;</span><span class="n">CustomerViewModel</span><span class="p">&gt;</span> <span class="n">validator</span><span class="p">)</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>            <span class="n">_validator</span> <span class="p">=</span> <span class="n">validator</span><span class="p">;</span>
</span><span class='line'>            <span class="n">_notifications</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NotificationCollection</span><span class="p">();</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">public</span> <span class="n">NotificationCollection</span> <span class="n">Notifications</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_notifications</span><span class="p">;}}</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">public</span> <span class="kt">bool</span> <span class="nf">IsValid</span><span class="p">()</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>            <span class="n">_notifications</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
</span><span class='line'>            <span class="n">_validator</span><span class="p">.</span><span class="n">Validate</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">_notifications</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">_notifications</span><span class="p">.</span><span class="n">ContainsErrors</span><span class="p">;</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Here is what I came up with in order to use the DataAnnotation Validators for this</h2>

<p>First of all, some basics. I&#8217;m going to demonstrate a (very simple)
implementation of the <code>Notification pattern</code> in this post. A detailed
explanation this pattern is a bit out of scope for this post, but
here&#8217;re some excellent resources for that:</p>

<ul>
<li><a href="http://martinfowler.com/eaaDev/Notification.html">The Notification Pattern</a> by Martin
Fowler</li>
<li><a href="http://codebetter.com/blogs/jeremy.miller/archive/2007/06/13/build-your-own-cab-part-9-domain-centric-validation-with-the-notification-pattern.aspx">Domain centric validation with the Notification Pattern</a> by Jeremy D. Miller</li>
</ul>


<p>We&#8217;re starting with a base class for our Notifications. It&#8217;s a simple
abstract class containing a message and a Source property. Besides that
it contains an implicit conversion to string.</p>

<figure class='code'><figcaption><span>Our notification abstraction</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">Notification</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>     <span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">_message</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">protected</span> <span class="nf">Notification</span><span class="p">()</span> <span class="p">:</span> <span class="k">this</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">,</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">)</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">protected</span> <span class="nf">Notification</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">)</span> <span class="p">:</span> <span class="k">this</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>            <span class="n">_message</span> <span class="p">=</span> <span class="n">message</span><span class="p">;</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">protected</span> <span class="nf">Notification</span><span class="p">(</span><span class="kt">string</span> <span class="n">source</span><span class="p">,</span> <span class="kt">string</span> <span class="n">message</span><span class="p">)</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>            <span class="n">Require</span><span class="p">.</span><span class="n">ArgumentNotNull</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s">&quot;source&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="n">Require</span><span class="p">.</span><span class="n">ArgumentNotNull</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">_message</span> <span class="p">=</span> <span class="n">message</span><span class="p">;</span>
</span><span class='line'>            <span class="n">Source</span> <span class="p">=</span> <span class="n">source</span><span class="p">;</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">public</span> <span class="kt">string</span> <span class="n">Source</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">protected</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">public</span> <span class="k">override</span> <span class="kt">string</span> <span class="nf">ToString</span><span class="p">()</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">_message</span><span class="p">;</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">public</span> <span class="k">static</span> <span class="k">implicit</span> <span class="k">operator</span> <span class="nf">string</span><span class="p">(</span><span class="n">Notification</span> <span class="n">notification</span><span class="p">)</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">notification</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Error is a simple class derived from Notification, which
contains no additional code.</p>

<figure class='code'><figcaption><span>Representing an error as a class</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">Error</span> <span class="p">:</span> <span class="n">Notification</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>     <span class="k">public</span> <span class="nf">Error</span><span class="p">(</span><span class="kt">string</span> <span class="n">source</span><span class="p">,</span> <span class="kt">string</span> <span class="n">message</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">public</span> <span class="nf">Error</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&#8217;ve seen some people implementing the Notification
pattern with a single Notification class and an enumeration specifying
the type of the Notification (Error, Warning, Info, etc.) but I prever
using classes for this. I think readability is way better (and shorter)
using classes. Decide for yourself:</p>

<figure class='code'><figcaption><span>Class based vs enumeration based implementation</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">bool</span> <span class="n">isError</span> <span class="p">=</span> <span class="n">notification</span> <span class="k">is</span> <span class="n">Error</span><span class="p">;</span>
</span><span class='line'><span class="c1">//versus</span>
</span><span class='line'><span class="kt">bool</span> <span class="n">isError</span> <span class="p">=</span> <span class="n">notification</span><span class="p">.</span><span class="n">Severity</span> <span class="p">==</span> <span class="n">Severity</span><span class="p">.</span><span class="n">Error</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&#8217;s very rare that you only have to validate one element / property. Mostly we&#8217;re
dealing with more than one elment beeing validated. Because of that it&#8217;s
useful to have a container or collection for Notifications. This gives
you a nice place for some additional functionality.</p>

<figure class='code'><figcaption><span>A container for Notifications</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">NotificationCollection</span> <span class="p">:</span> <span class="n">ObservableCollection</span><span class="p">&lt;</span><span class="n">Notification</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>     <span class="k">public</span> <span class="kt">bool</span> <span class="n">ContainsErrors</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>            <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">notification</span> <span class="p">=&gt;</span> <span class="n">notification</span><span class="p">.</span><span class="n">IsOfType</span><span class="p">&lt;</span><span class="n">Error</span><span class="p">&gt;());</span> <span class="p">}</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">public</span> <span class="kt">bool</span> <span class="n">ContainsWarnings</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>            <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">notification</span> <span class="p">=&gt;</span> <span class="n">notification</span><span class="p">.</span><span class="n">IsOfType</span><span class="p">&lt;</span><span class="n">Warning</span><span class="p">&gt;());</span> <span class="p">}</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Notification</span><span class="p">&gt;</span> <span class="n">AllNotificationsFor</span><span class="p">(</span><span class="kt">string</span> <span class="n">nameOfSource</span><span class="p">)</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">notification</span> <span class="p">=&gt;</span> <span class="kt">string</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">notification</span><span class="p">.</span><span class="n">Source</span><span class="p">,</span> <span class="n">nameOfSource</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">Ordinal</span><span class="p">));</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>While the first properties are pretty obvious, the last method probably needs some
explanation. It finds all notifications for a given source name. The
source in my implementation is the name of the property on the ViewModel
that was validated. Im currently using a little convention here.
Properties in WPF views have the same name as the ViewModel properties
they&#8217;re bound to. This makes it relatively easy to correlate those two
things (meaning deciding which Notification belongs to which UIElement).
Having set this up, let me walk you through the validator
implementation.</p>

<h2>A Validator<T> using DataAnnotations</h2>

<figure class='code'><figcaption><span>A dedicated Validator</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">Validator</span><span class="p">&lt;</span><span class="n">TElement</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IValidator</span><span class="p">&lt;</span><span class="n">TElement</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>     <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">PropertyValidator</span><span class="p">&gt;</span> <span class="n">Validators</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">static</span> <span class="nf">Validator</span><span class="p">()</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>            <span class="n">var</span> <span class="n">properties</span> <span class="p">=</span> <span class="k">typeof</span> <span class="p">(</span><span class="n">TElement</span><span class="p">).</span><span class="n">GetProperties</span><span class="p">(</span><span class="n">BindingFlags</span><span class="p">.</span><span class="n">Instance</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Public</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">Validators</span> <span class="p">=</span> <span class="n">from</span> <span class="n">property</span> <span class="k">in</span> <span class="n">properties</span>
</span><span class='line'>                   <span class="n">where</span> <span class="n">property</span><span class="p">.</span><span class="n">IsMarkedWith</span><span class="p">&lt;</span><span class="n">ValidationAttribute</span><span class="p">&gt;()</span>
</span><span class='line'>                   <span class="n">select</span> <span class="k">new</span> <span class="nf">PropertyValidator</span><span class="p">(</span><span class="n">property</span><span class="p">);</span>
</span><span class='line'>     <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The static constructor of the <code>Validator&lt;TElement&gt;</code> class uses
reflection to find all marked properties of the target type specified
via the generic type argument <code>TElement</code>. It searches for properties
marked at least with one derivate of the <code>System.ComponentModel.DataAnnotations.ValidationAttribute</code> and creates a
<code>PropertyValidator</code> for each match.</p>

<figure class='code'><figcaption><span>Validating an element</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="cp">#region IValidator&lt;TElement&gt; Members</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">Validate</span><span class="p">(</span><span class="n">TElement</span> <span class="n">element</span><span class="p">,</span> <span class="n">NotificationCollection</span> <span class="n">notifications</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>     <span class="n">Validators</span><span class="p">.</span><span class="n">Each</span><span class="p">(</span><span class="n">entry</span> <span class="p">=&gt;</span> <span class="n">entry</span><span class="p">.</span><span class="n">Validate</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">notifications</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#endregion</span>
</span></code></pre></td></tr></table></div></figure>


<p>The actual validation happens inside the Validate method. This method simply
uses all known <code>PropertyValidators</code> in order to validate the target
object.</p>

<figure class='code'><figcaption><span>The PropertyValidator class</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="cp">#region Nested type: PropertyValidator</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="k">class</span> <span class="nc">PropertyValidator</span> <span class="p">:</span> <span class="n">IValidator</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>     <span class="k">private</span> <span class="k">readonly</span> <span class="n">PropertyInfo</span> <span class="n">_property</span><span class="p">;</span>
</span><span class='line'>     <span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">_propertyDisplayName</span><span class="p">;</span>
</span><span class='line'>     <span class="k">private</span> <span class="k">readonly</span> <span class="n">IEnumerable</span> <span class="n">_propertyValidators</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">public</span> <span class="nf">PropertyValidator</span><span class="p">(</span><span class="n">PropertyInfo</span> <span class="n">property</span><span class="p">)</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>            <span class="n">_property</span> <span class="p">=</span> <span class="n">property</span><span class="p">;</span>
</span><span class='line'>            <span class="n">_propertyDisplayName</span> <span class="p">=</span> <span class="n">GetDisplayName</span><span class="p">(</span><span class="n">_property</span><span class="p">);</span>
</span><span class='line'>            <span class="n">_propertyValidators</span> <span class="p">=</span> <span class="n">GetValidators</span><span class="p">(</span><span class="n">property</span><span class="p">);</span>
</span><span class='line'>     <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>A <code>PropertyValidator</code> does some things internally when it&#8217;s created. First it determines the name for
the validated element which should be used in the UI. Since you probably
don&#8217;t want the user to see something like &#8220;FirstName is required&#8221; or
&#8220;SelectedCountry is required&#8221; I&#8217;m using <code>System.ComponentModel.Design.DisplayNameAttribute</code> here which can be used
to specify a UI-friendly name. If no <code>DisplayNameAttribute</code> is specified
on a property the validator uses the property name instead.</p>

<figure class='code'><figcaption><span>Getting the name that is displayed for a property</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">GetDisplayName</span><span class="p">(</span><span class="n">PropertyInfo</span> <span class="n">property</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>     <span class="k">if</span> <span class="p">(</span><span class="n">property</span><span class="p">.</span><span class="n">IsMarkedWith</span><span class="p">&lt;</span><span class="n">DisplayNameAttribute</span><span class="p">&gt;())</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">property</span><span class="p">.</span><span class="n">GetAttribute</span><span class="p">&lt;</span><span class="n">DisplayNameAttribute</span><span class="p">&gt;().</span><span class="n">DisplayName</span><span class="p">;</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">return</span> <span class="n">property</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>After it has determined the UI friendly display name it extracts all DataAnnotations <code>ValidationAttributes</code> from the property.
(Note: GetAttributes is an ExtensionMethod. Same applies to <code>IsMarkedWith</code> and <code>GetAttribute</code>)</p>

<figure class='code'><figcaption><span>Extracting all DataAnnotation validators</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">ValidationAttribute</span><span class="p">&gt;</span> <span class="n">GetValidators</span><span class="p">(</span><span class="n">PropertyInfo</span> <span class="n">property</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>     <span class="k">return</span> <span class="n">property</span><span class="p">.</span><span class="n">GetAttributes</span><span class="p">&lt;</span><span class="n">ValidationAttribute</span><span class="p">&gt;();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And here is the rest, which brings the whole thing to life. This code simply extracts the value from
the property, iterates over all known ValidationAttributes and checks
the value with them. When a <code>ValidationAttribute</code> signals that a value is
not valid, an error message is formatted with the UI-friendly name I
talked earlier about and the whole thing is stored as an Error.</p>

<figure class='code'><figcaption><span>Validating an element</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="cp">#region IValidator Members</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">Validate</span><span class="p">(</span><span class="n">TElement</span> <span class="n">element</span><span class="p">,</span> <span class="n">NotificationCollection</span> <span class="n">notifications</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>     <span class="n">var</span> <span class="k">value</span> <span class="p">=</span> <span class="n">_property</span><span class="p">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="k">new</span> <span class="kt">object</span><span class="p">[]</span> <span class="p">{});</span>
</span><span class='line'>
</span><span class='line'>     <span class="n">_propertyValidators</span><span class="p">.</span><span class="n">Each</span><span class="p">(</span><span class="n">validator</span> <span class="p">=&gt;</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(!</span><span class="n">validator</span><span class="p">.</span><span class="n">IsValid</span><span class="p">(</span><span class="k">value</span><span class="p">))</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                   <span class="kt">string</span> <span class="n">formmattedErrorMessage</span> <span class="p">=</span> <span class="n">validator</span><span class="p">.</span><span class="n">FormatErrorMessage</span><span class="p">(</span><span class="n">_propertyDisplayName</span><span class="p">);</span>
</span><span class='line'>                   <span class="n">notifications</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">Error</span><span class="p">(</span><span class="n">_property</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">formmattedErrorMessage</span><span class="p">));</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>     <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#endregion</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Bottom line</h2>

<p>It&#8217;s pretty easy to combine the existing functionality provided by DataAnnotations with the
Notification Pattern. It just took me an hour to get to a working
solution which I consider pretty fast and which imho indicates an easy
to use framework. As you can imagine the hard part isn&#8217;t getting the
Notifications out of the model, but rather finding an unrepetative,
intuitive way to display them in the UI. In the past I&#8217;ve missed several
times the pit of success regarding this aspect. However I&#8217;m really
confident that my current solution is really Dry AND easy to use. In one
of the next posts I&#8217;m going to show how to combine Attached Behavior,
Styles and Templates in order to bring the Notifications described in
this post to the applications front door, the UI &#8230;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/08/21/diving-into-the-storyteller-trunk-part-8-the-screencollection/">Diving Into the StoryTeller Trunk, Part 8: The ScreenCollection</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2009-08-21T16:19:11+02:00" pubdate  data-updated="true" >Aug 21<span>st</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Welcome back again to the &#8220;Diving into the StoryTeller trunk&#8221; series.
Got your diving suit on? If so, good. If not: Suit-up! (Sorry, the HIMYM
fanboy in me was too strong ;-))</p>

<p>Last time we spend some time with the concept of Screens. Screens more
or less provide the content of an application. Content needs to be
displayed somewhere and that&#8217;s where the ScreenCollection concept comes
into play.</p>

<p>In abstract a ScreenCollection is a container for multiple Screens. It&#8217;s
used to display screens. The ScreenCollection concept is comparable to
PRISMs Regions or CABs WorkSpaces. It doesn&#8217;t really contain a lot of
intelligence. It only allows you to add a Screen, remove a Screen,
getting all Screens in the container, make a Screen the active one. You
know, all in all the typical stuff you would expect from a collection
(maybe except the last one). The ScreenCollection contract is
represented by the <code>IScreenCollection</code> interface which looks like this:</p>

<figure class='code'><figcaption><span>The IScreenCollection interface</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IScreenCollection</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>      <span class="k">void</span> <span class="nf">ClearAll</span><span class="p">();</span>
</span><span class='line'>      <span class="n">IScreen</span> <span class="n">Active</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>      <span class="k">void</span> <span class="nf">Show</span><span class="p">(</span><span class="n">IScreen</span> <span class="n">screen</span><span class="p">);</span>
</span><span class='line'>      <span class="k">void</span> <span class="nf">Add</span><span class="p">(</span><span class="n">IScreen</span> <span class="n">screen</span><span class="p">);</span>
</span><span class='line'>      <span class="k">void</span> <span class="nf">Remove</span><span class="p">(</span><span class="n">IScreen</span> <span class="n">screen</span><span class="p">);</span>
</span><span class='line'>      <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IScreen</span><span class="p">&gt;</span> <span class="n">AllScreens</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>      <span class="k">void</span> <span class="nf">RenameTab</span><span class="p">(</span><span class="n">IScreen</span> <span class="n">screen</span><span class="p">,</span> <span class="kt">string</span> <span class="n">name</span><span class="p">);</span>
</span><span class='line'> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If take a closer look at the interface you&#8217;ve probably recognized the last
method which doesn&#8217;t really fit in there. Let&#8217;s spare that discussion
for a moment. I&#8217;m going to comment on that in a moment.</p>

<p>StoryTeller contains only one implementation for the <code>IScreenCollection</code>
interface, which is called (what-a-surprise) <code>ScreenCollection</code>. This
class simply wraps around a standard WPF <code>TabControl</code>. Let&#8217;s take a look
at how this is implemented, starting with the constructor.</p>

<figure class='code'><figcaption><span>StoryTellers ScreenCollection class</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ScreenCollection</span> <span class="p">:</span> <span class="n">IScreenCollection</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">private</span> <span class="k">readonly</span> <span class="n">Cache</span><span class="p">&lt;</span><span class="n">IScreen</span><span class="p">,</span> <span class="n">StoryTellerTabItem</span><span class="p">&gt;</span> <span class="n">_tabItems</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Cache</span><span class="p">&lt;</span><span class="n">IScreen</span><span class="p">,</span> <span class="n">StoryTellerTabItem</span><span class="p">&gt;();</span>
</span><span class='line'>   <span class="k">private</span> <span class="k">readonly</span> <span class="n">TabControl</span> <span class="n">_tabs</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">public</span> <span class="nf">ScreenCollection</span><span class="p">(</span><span class="n">TabControl</span> <span class="n">tabs</span><span class="p">,</span> <span class="n">IEventAggregator</span> <span class="n">events</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>       <span class="n">_tabs</span> <span class="p">=</span> <span class="n">tabs</span><span class="p">;</span>
</span><span class='line'>       <span class="n">_tabItems</span><span class="p">.</span><span class="n">OnMissing</span> <span class="p">=</span> <span class="n">screen</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">StoryTellerTabItem</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">events</span><span class="p">);</span>
</span><span class='line'>       <span class="n">_tabs</span><span class="p">.</span><span class="n">SelectionChanged</span> <span class="p">+=</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="n">events</span><span class="p">.</span><span class="n">SendMessage</span><span class="p">&lt;</span><span class="n">UserScreenActivation</span><span class="p">&gt;();</span> <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">// Hack.  Sigh.</span>
</span><span class='line'>       <span class="n">events</span><span class="p">.</span><span class="n">AddListener</span><span class="p">(</span><span class="k">new</span> <span class="n">RenameTestHandler</span><span class="p">(</span><span class="k">new</span> <span class="n">ScreenFinder</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="k">this</span><span class="p">));</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>There&#8217;re are two interesting things to notice here. The <code>ScreenCollection</code> uses a cache concept in order to correlate
Screens and the TabItems used to display them. The <code>Cache&lt;TKey,TValue&gt;</code>
class is a smart wrapper around an <code>IDictionary&lt;TKey,TValue&gt;</code> which
(besides some other functionality) allows you to plug-in a custom
handler which is called when no value is found for the specified key.
This handler acts as a kind of value factory. That&#8217;s exactly what we see
when we take a look at the line with <code>_tabItems.OnMissing</code>. Each time a
Screen is not found in the cache StoryTeller creates a new <code>StoryTellerTabItem</code>.</p>

<p>The other interesting thing to notice is that the <code>ScreenCollection</code>
doesn&#8217;t directly expose events but rather uses the <code>Eventbroker</code> for this.
You can see this at the <code>UserScreenActivation</code> message.</p>

<p>Yeah and then there is the &#8220;RenameTab&#8221; thing. It&#8217;s marked as a hack. It
simply shouldn&#8217;t be there. The problem it currently solves it that when
a test is renamed the related <code>TabHeader</code> must also be updated (We take a
look at the <code>TabItem</code> in a moment). I wonder whether this isn&#8217;t something
that could be done in a cleaner way using WPF databinding on <code>Screen.Title</code> instead.</p>

<p>Lets take a look at how the cache magic is used. It&#8217;s really compact
code. Most of the methods are one or two liners.</p>

<figure class='code'><figcaption><span>Methods of the ScreenCollection class</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">ClearAll</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">_tabs</span><span class="p">.</span><span class="n">Items</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">Show</span><span class="p">(</span><span class="n">IScreen</span> <span class="n">screen</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">_tabs</span><span class="p">.</span><span class="n">SelectedItem</span> <span class="p">=</span> <span class="n">_tabItems</span><span class="p">[</span><span class="n">screen</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">Add</span><span class="p">(</span><span class="n">IScreen</span> <span class="n">screen</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">_tabs</span><span class="p">.</span><span class="n">Items</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">_tabItems</span><span class="p">[</span><span class="n">screen</span><span class="p">]);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">Remove</span><span class="p">(</span><span class="n">IScreen</span> <span class="n">screen</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">TabItem</span> <span class="n">tabItem</span> <span class="p">=</span> <span class="n">_tabItems</span><span class="p">[</span><span class="n">screen</span><span class="p">];</span>
</span><span class='line'>    <span class="n">_tabItems</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">screen</span><span class="p">);</span>
</span><span class='line'>    <span class="n">_tabs</span><span class="p">.</span><span class="n">Items</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">tabItem</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IScreen</span><span class="p">&gt;</span> <span class="n">AllScreens</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">IScreen</span><span class="p">&gt;(</span><span class="n">_tabItems</span><span class="p">.</span><span class="n">Keys</span><span class="p">());</span> <span class="p">}</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The cache class is used like you would use a good old
Hashtable. All in all I think I don&#8217;t need to say more here. Here is the
code for determining the active Screen.</p>

<figure class='code'><figcaption><span>Determining the active Screen</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="n">IScreen</span> <span class="n">Active</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">get</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">_tabs</span><span class="p">.</span><span class="n">SelectedItem</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="k">return</span> <span class="n">toScreen</span><span class="p">(</span><span class="n">_tabs</span><span class="p">.</span><span class="n">SelectedItem</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="n">IScreen</span> <span class="nf">toScreen</span><span class="p">(</span><span class="kt">object</span> <span class="n">tab</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">tab</span><span class="p">.</span><span class="n">As</span><span class="p">&lt;</span><span class="n">TabItem</span><span class="p">&gt;().</span><span class="n">Tag</span><span class="p">.</span><span class="n">As</span><span class="p">&lt;</span><span class="n">IScreen</span><span class="p">&gt;();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Last but not least here&#8217;s the code for the <code>TabItem</code> which is build around a
screen.</p>

<figure class='code'><figcaption><span>The StoryTellerTabItem class</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">StoryTellerTabItem</span> <span class="p">:</span> <span class="n">TabItem</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="n">Label</span> <span class="n">_label</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">StoryTellerTabItem</span><span class="p">(</span><span class="n">IScreen</span> <span class="n">screen</span><span class="p">,</span> <span class="n">IEventAggregator</span> <span class="n">events</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">Func</span><span class="p">&lt;</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">IScreenConductor</span><span class="p">&gt;,</span> <span class="n">Action</span><span class="p">&gt;</span> <span class="n">sendMessage</span> <span class="p">=</span> <span class="n">a</span> <span class="p">=&gt;</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">events</span><span class="p">.</span><span class="n">SendMessage</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">Header</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StackPanel</span><span class="p">().</span><span class="n">Horizontal</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">AddText</span><span class="p">(</span><span class="n">screen</span><span class="p">.</span><span class="n">Title</span><span class="p">,</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">_label</span> <span class="p">=</span> <span class="n">x</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">IconButton</span><span class="p">(</span><span class="n">Icon</span><span class="p">.</span><span class="n">Close</span><span class="p">,</span> <span class="n">sendMessage</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">Close</span><span class="p">(</span><span class="n">screen</span><span class="p">)),</span> <span class="n">b</span> <span class="p">=&gt;</span> <span class="n">b</span><span class="p">.</span><span class="n">SmallerImages</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">Content</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DockPanel</span><span class="p">().</span><span class="n">With</span><span class="p">(</span><span class="n">screen</span><span class="p">.</span><span class="n">View</span><span class="p">);</span>
</span><span class='line'>        <span class="n">Tag</span> <span class="p">=</span> <span class="n">screen</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">ContextMenu</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ContextMenu</span><span class="p">().</span><span class="n">Configure</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">o</span><span class="p">.</span><span class="n">AddItem</span><span class="p">(</span><span class="s">&quot;Close&quot;</span><span class="p">,</span> <span class="n">sendMessage</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">Close</span><span class="p">(</span><span class="n">screen</span><span class="p">)));</span>
</span><span class='line'>            <span class="n">o</span><span class="p">.</span><span class="n">AddItem</span><span class="p">(</span><span class="s">&quot;Close All But This&quot;</span><span class="p">,</span> <span class="n">sendMessage</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">CloseAllBut</span><span class="p">(</span><span class="n">screen</span><span class="p">)));</span>
</span><span class='line'>            <span class="n">o</span><span class="p">.</span><span class="n">AddItem</span><span class="p">(</span><span class="s">&quot;Close All&quot;</span><span class="p">,</span> <span class="n">sendMessage</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">CloseAll</span><span class="p">()));</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="n">HeaderText</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_label</span><span class="p">.</span><span class="n">Content</span> <span class="k">as</span> <span class="kt">string</span><span class="p">;</span> <span class="p">}</span> <span class="k">set</span> <span class="p">{</span> <span class="n">_label</span><span class="p">.</span><span class="n">Content</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I need to talk more about this part, don&#8217;t I? Again two
intersting things here. First thing, it really makes heavy usage of
C#3.0. You can see a lot of Extension Methods on WPF classes used in
order to build and configure WPF elements in a very fluent and compact
way.</p>

<p>Besides that you see here again how the <code>EventBroker</code> can be nicely
integrated into Screen handling. Take a look at the context menu of each
<code>TabItem</code>. It provides handlers which call directly into the <code>EventBroker</code>
for triggering the typical close operations you can also see in Visual
Studio. The important thing here to take away is that the close
operations are only triggered here but performed by the
<code>IScreenConductor</code>.</p>

<p>For those of you who didn&#8217;t follow my &#8220;StoryTeller&#8221; investigations from
the start: The <code>ScreenConductor</code> is the great coordinator for the Screen
Activation Lifecycle behind the scenes. It&#8217;s (as far as I can tell) the
central facade to the Screen Activation Lifecyle from the perspective of
typical application code. The <code>ScreenConductor</code> is a big topic which will
be discussed in one of the next posts.</p>

<h2>Closing thoughts</h2>

<p>Lets not comment on the <code>RenameTab</code> thing, ok? I bet, Jeremy is going to
fix that pretty soon. The <code>ScreenCollection</code> is (again) a good example of
how much you can do with so few lines. However sometimes this can have
downsides, too. I can only imagine .NET developers unfamiliar with this
heavy usage of C#3.0 features staring at the code and thinking
something like: WTF, what&#8217;s happening here? Personally, I like it,
especially the cache aspect of it. I&#8217;ve done the .Tag thing far too
often now.</p>

<p>Sadly one thing I would have loved to see is missing in the code, the
ability to block deactivation or activation. Typical example for this is
a requirement forcing the user to save or discard changed data before
leaving a Screen. I had this requirement in the last 5 applications I
worked on. It would have been interesting to see how Jeremy tackles such
a requirement. I&#8217;m just assuming that he would use the <code>EventBroker</code> for
that &#8230;</p>

<p>Enought Screen Mania for today. I hope you&#8217;ve enjoyed the ride so far
and we&#8217;ll rejoin next time when it&#8217;s time to take a look at the big guy
in the game, the <code>ScreenConductor</code>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/08/19/the-attached-behavior-pattern/">The Attached Behavior Pattern</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2009-08-19T08:46:01+02:00" pubdate  data-updated="true" >Aug 19<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>With new technologies often completely new patterns emerge as people try
to check-out how far a technology might take them. One interesting
example for this is the <code>Attached Behavior Pattern</code> which seems to get a
lot of attention in the WPF and Silverlight community lately. It&#8217;s a
great example of what you can do with those technologies that was
previously only very hard to achieve (although sometimes in my calm
moments it feels a little bit like a hack to me).</p>

<p>Anyway, here is what the pattern actually does:</p>

<p>The <code>Attached Behavior Pattern</code> uses the moment when an attached
DependencyProperty is attached to a <code>DependencyObject</code> in order to wire
event handlers to it. With this you&#8217;re able to extend the behavior of
elements in the WPF trees with arbitrary code.</p>

<p>Let&#8217;s take a look at how this can be achieved. First of all we need a
class deriving from <code>DependencyObject</code> in order to be able to provide an
attached <code>DependencyProperty</code>. It uses the standard pattern of registering
the <code>IsEnabled</code> DependencyProperty in the static constructor (which is a
bit clunky, btw).</p>

<figure class='code'><figcaption><span>A behavior must derive from DependencyObject</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">MyBehavior</span> <span class="p">:</span> <span class="n">DependencyObject</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">DependencyProperty</span> <span class="n">IsEnabledProperty</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">static</span> <span class="nf">MyBehavior</span> <span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">IsEnabledProperty</span> <span class="p">=</span> <span class="n">DependencyProperty</span><span class="p">.</span><span class="n">RegisterAttached</span><span class="p">(</span>
</span><span class='line'>            <span class="s">&quot;IsEnabled&quot;</span><span class="p">,</span> <span class="c1">//Name of the property</span>
</span><span class='line'>            <span class="k">typeof</span><span class="p">(</span><span class="kt">bool</span><span class="p">),</span><span class="c1">//Type of the attached property</span>
</span><span class='line'>            <span class="k">typeof</span><span class="p">(</span><span class="n">MyBehavior</span><span class="p">),</span><span class="c1">//Type of the class that provides the property</span>
</span><span class='line'>            <span class="k">new</span> <span class="nf">FrameworkPropertyMetadata</span><span class="p">(</span><span class="k">false</span><span class="p">));</span> <span class="c1">//Default value</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsEnabled</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">GetValue</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;(</span><span class="n">IsEnabledProperty</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>        <span class="k">set</span> <span class="p">{</span> <span class="n">SetValue</span><span class="p">(</span><span class="n">IsEnabledProperty</span><span class="p">,</span> <span class="k">value</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Pretty standard stuff so far. However you can use another constructor of
<code>FrameworkPropertyMetdata</code> in order to supply a callback which is called
when the value of the attached property changes.</p>

<figure class='code'><figcaption><span>Registering for change notifications</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">IsEnabledProperty</span> <span class="p">=</span> <span class="n">DependencyProperty</span><span class="p">.</span><span class="n">RegisterAttached</span><span class="p">(</span>
</span><span class='line'>               <span class="s">&quot;IsEnabled&quot;</span><span class="p">,</span> <span class="c1">//Name of the property</span>
</span><span class='line'>               <span class="k">typeof</span><span class="p">(</span><span class="kt">bool</span><span class="p">),</span><span class="c1">//Type of the attached property</span>
</span><span class='line'>               <span class="k">typeof</span><span class="p">(</span><span class="n">MyBehavior</span><span class="p">),</span><span class="c1">//Type of the class that provides the property</span>
</span><span class='line'>               <span class="k">new</span> <span class="nf">FrameworkPropertyMetadata</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="n">OnBehaviorEnabled</span><span class="p">));</span> <span class="c1">//Default value + Callback</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next thing we need to do is to configure this attached property on the <code>DependencyObject</code> we want to attach behavior to.
This is preferably done in XAML. You&#8217;ve got at least two options for
doing the configuration. The first option is to set your attached
property in the <code>XAML</code> file of a <code>UserControl</code>, <code>Page</code> or <code>Window</code> directly at
the source, the element you want to attach behavior to.</p>

<figure class='code'><figcaption><span>Wiring it via XAML</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;TextBox</span> <span class="na">myNamespace:MyBehavior.IsEnabled=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The other option is to use the the power of styles (an area were WPF really shines imho) in order to set it for
all elements to which a style is applied.</p>

<figure class='code'><figcaption><span>Wiring it via XAML and styles</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;Style</span> <span class="na">TargetType=</span><span class="s">&quot;TextBox&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>   <span class="nt">&lt;Setter</span> <span class="na">Property=</span><span class="s">&quot;myNamespace:MyBehavior.IsEnabled&quot;</span> <span class="na">Value=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/Style&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Personally I very much vote for the second option, because it enables you to specify the attached behavior in a single place in
contrast to configuring it at several places in your solution. Don&#8217;t repeat yourself, unless you really need to.</p>

<p>Now, fasten your seatbelts. This is were the fun begins. When the WPF / Silverlight infrastructure loads the compiled baml from the resources
and builds the element tree from it (and with this attaches our new property to the specified elements) the callback method gets called.</p>

<figure class='code'><figcaption><span>Attaching to the target instance</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">OnBehaviorEnabled</span><span class="p">(</span>
</span><span class='line'>    <span class="n">DependencyObject</span> <span class="n">dependencyObject</span><span class="p">,</span>
</span><span class='line'>    <span class="n">DependencyPropertyChangedEventArgs</span> <span class="n">args</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">TextBox</span> <span class="n">textBox</span> <span class="p">=</span> <span class="p">(</span><span class="n">TextBox</span><span class="p">)</span><span class="n">dependencyObject</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">textBox</span><span class="p">.</span><span class="n">LostFocus</span> <span class="p">+=</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">)</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="c1">//Put your little piece of magic here</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>With first parameter of the callback you get a reference to the <code>DependencyObject</code> to which our attached property has been attached
to. You&#8217;re now able to wire all sort of event handlers to the <code>DependencyObject</code> and are able to execute arbitrary code when the event
occurs.</p>

<p>Here ends our journey for today. Attached Behaviors is a really nice technique which enabled me to do something that I always wanted to have
in my WinForms apps but never found a satisfiing way to implement it (just a bit patience, I&#8217;m going to blog about it soon). I think it will
be interesting to see how this pattern is used in the future. While new patterns always have the tendency to be overused, I think that this
particular pattern can enable lots of valuable things &#8230;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/08/17/wpf-is-not-winforms/">WPF Is Not WinForms</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2009-08-17T12:36:45+02:00" pubdate  data-updated="true" >Aug 17<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&#8217;ve been investing a lot of time in learning WPF lately. WPF has always been somehow interesting to me, however I never found actually
the time to learn it from the ground up. I&#8217;ve been trying to grok it for several weeks know and am now slowly coming to a point were I can feel
the ROI, start seeing the big picture (how the whole WPF architecture fits together) and what&#8217;s the really beneficial side of WPF compared to
WinForms.</p>

<p>I&#8217;ve read several times about how steep the learning curve is and must admit, yeah that&#8217;s probably right. At least I&#8217;ve experienced it
that way. BUT, here is the interesting side node: That&#8217;s mostly not because of the difficulty or complexity of the technology itself. A lot
of my problems arose because of the way how I tried to approach WPF.  Having spend most of my professional work with WinForms seems to have
left some traces. I remember lots and lots of situations where I thought to myself: <em>&#8220;Why is that so hard? In WinForms you must simply &#8230;&#8221;</em>,
<em>&#8220;This TreeView just plain sucks&#8221;</em> or <em>&#8220;Mh, where is the Dock property on a Control?&#8221;</em>.</p>

<p>Makes me smile now when I think about it. What I basically experienced is <strong>THAT IT&#8217;S HARD TO DO WINFORMS DEVELOPMENT WITH WPF</strong>. WPF was never designed to be WinForms V2.
Neither was it designed to have a similar programming model. After realizing this here is a little yoda-eske advice for WPF-learners like me:</p>

<blockquote><p>Don&#8217;t let you&#8217;re WinForms knowledge stand in your way. Try to really understand the programming model and the intentions of WPF first and constantly<br/>review whether problems you experience while learning WPF come from trying to do the things the way you&#8217;re used to in WinForms.</p></blockquote>


<p>Once I&#8217;ve understood that I really felt that I made a big leap forward. WPF is such a rich, enjoyable technology if you stick with it long enough.
Sadly I&#8217;m currently not participating in a WPF or Silverlight project (like so may others), but I&#8217;ve high hopes. Better times are coming &#8230;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/08/14/diving-into-the-storyteller-trunk-part-7-screens/">Diving Into the StoryTeller Trunk, Part 7: Screens</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2009-08-14T17:04:15+02:00" pubdate  data-updated="true" >Aug 14<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In the previous post I gave a short overview over the players that are
involved in the so called Screen Activation Lifecycle. Today I would
like to take a closer look at, guess what, the Screen.</p>

<p>For me personally, the design &#8216;around&#8217; a Screen is one of the crutial
elements for success in developing a composite UI layer. Why do I think
so?</p>

<p>Mostly because it&#8217;s one of the central points which connects the UI
infrastructure with all the rest of the application, the actual
application code. It&#8217;s THE INTERFACE that fills you&#8217;re framework /
infrastructure with life. If you fail here you probably feel the result
throughout the complete application. Day to day work happens around that
interface and since the UI seems to be one of those places in an
application that is very volatile and changes a lot, a Screen design
with principles like DRY and OCP in mind will make your life as an
application developer much easier.</p>

<p>So what are the basic responsibilities of a Screen?</p>

<ul>
<li>First of all it provides content. While a composite UI&#8217;s shell
provides the hull of the application, the Screen provides the UI to
fulfill a business requirement. I think it&#8217;s comparable to the
relationship between an Asp.Net Masterpage and the aspx pages
displayed in its content placeholder (Disclaimer: I&#8217;m no Asp.net
expert so feel free to correct).</li>
<li>Controlling Screen Activation. Since the UI infrastructure can&#8217;t
possibly now what has to happen when a Screen is activated, it
delegates the responsibility to the Screen itself. A practical
example of the Tell-Don&#8217;t-Ask-principle. Interaction with the
Command infrastructure mostly happens here.</li>
<li>Controlling Screen Deactivation / Closing. I&#8217;ve seen this in several
applications now. A Screen with changed data can only be left /
closed when a) changes have been persisted or b) the user votes to
discard the changes. Like in point 2. the UI infrastructure can&#8217;t
possibly know when that&#8217;s the case, so it&#8217;s delegated.</li>
</ul>


<p>With those 3 points in mind, let&#8217;s take a look at the Screen interface
in StoryTeller.</p>

<figure class='code'><figcaption><span>The Screen interface</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IScreen</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">object</span> <span class="n">View</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="kt">string</span> <span class="n">Title</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">void</span> <span class="nf">Activate</span><span class="p">(</span><span class="n">IScreeObjectRegistry</span> <span class="n">screenObjects</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">bool</span> <span class="nf">CanClose</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Pretty straight forward, isn&#8217;t it?. Next question, who is
actually implementing the interface? And the answer is surprisingly: It
depends! This interface can be implemented for instance by <code>Passive View</code>
- or <code>Supervising Controller</code> - style Presenters. It can be implemented by
ViewModels in Model-View-View-Model implementations. It can even be
implemented by UserControls (though StoryTeller uses this only for very
simplistic screens). It&#8217;s a very pragmatic solution giving a lot of
choice to an application developer on how to interact with the UI
infrastructure.</p>

<p>I think that&#8217;s a good choice. We, as a community, shouldn&#8217;t be dogmatic
about MVVM vs. MVP, or the whole No-Code-Behind-debate. Consistency is
import but, sticking to a pattern not suited for a particular screen
(for instance using Passive View for a screen with a lot of fields) can
hurt much more than the (pattern) consistency would justify. Mh, that
was a little bit off-topic, wasn&#8217;t it?</p>

<p>Most of the Screens in StoryTeller are classical Model View Presenter
implementations getting their view injected in the constructor.</p>

<figure class='code'><figcaption><span>An screen straight from StoryTeller</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>   <span class="k">public</span> <span class="k">class</span> <span class="nc">SuitePresenter</span> <span class="p">:</span> <span class="n">IListener</span><span class="p">&lt;</span><span class="n">TestIconChanged</span><span class="p">&gt;,</span> <span class="n">ISuitePresenter</span><span class="p">,</span> <span class="n">IListener</span><span class="p">&lt;</span><span class="n">TestAdded</span><span class="p">&gt;</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>       <span class="k">private</span> <span class="k">readonly</span> <span class="n">Cache</span> <span class="n">_drivers</span><span class="p">;</span>
</span><span class='line'>       <span class="k">private</span> <span class="k">readonly</span> <span class="n">ITestExplorer</span> <span class="n">_explorer</span><span class="p">;</span>
</span><span class='line'>       <span class="k">private</span> <span class="k">readonly</span> <span class="n">ITestService</span> <span class="n">_service</span><span class="p">;</span>
</span><span class='line'>       <span class="k">private</span> <span class="k">readonly</span> <span class="n">Suite</span> <span class="n">_suite</span><span class="p">;</span>
</span><span class='line'>       <span class="k">private</span> <span class="k">readonly</span> <span class="n">ISuiteView</span> <span class="n">_view</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">public</span> <span class="nf">SuitePresenter</span><span class="p">(</span><span class="n">Suite</span> <span class="n">suite</span><span class="p">,</span> <span class="n">ISuiteView</span> <span class="n">view</span><span class="p">,</span> <span class="n">ITestExplorer</span> <span class="n">explorer</span><span class="p">,</span> <span class="n">ITestService</span> <span class="n">service</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>           <span class="n">_suite</span> <span class="p">=</span> <span class="n">suite</span><span class="p">;</span>
</span><span class='line'>           <span class="n">_view</span> <span class="p">=</span> <span class="n">view</span><span class="p">;</span>
</span><span class='line'>           <span class="n">_explorer</span> <span class="p">=</span> <span class="n">explorer</span><span class="p">;</span>
</span><span class='line'>           <span class="n">_service</span> <span class="p">=</span> <span class="n">service</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>           <span class="n">_view</span><span class="p">.</span><span class="n">Presenter</span> <span class="p">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>           <span class="n">_drivers</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Cache</span><span class="p">&lt;</span><span class="n">Test</span><span class="p">,</span> <span class="n">ITestLineDriver</span><span class="p">&gt;(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="n">_view</span><span class="p">.</span><span class="n">AddTest</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">queueTest</span><span class="p">));</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">..........</span>
</span><span class='line'>   <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The structural aspect of the screens isn&#8217;t
that interesting to me. Standard MVP stuff. The activation however (in
particular the usage of <code>IScreenObjectRegistry</code>) looks really interesting.
Take a look for yourself:</p>

<figure class='code'><figcaption><span>A dsl for controlling commands</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">Activate</span><span class="p">(</span><span class="n">IScreenObjectRegistry</span> <span class="n">screenObjects</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">screenObjects</span>
</span><span class='line'>       <span class="p">.</span><span class="n">Action</span><span class="p">(</span><span class="s">&quot;Run&quot;</span><span class="p">)</span>
</span><span class='line'>       <span class="p">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">ModifierKeys</span><span class="p">.</span><span class="n">Control</span><span class="p">,</span> <span class="n">Key</span><span class="p">.</span><span class="n">D1</span><span class="p">)</span>
</span><span class='line'>       <span class="p">.</span><span class="n">To</span><span class="p">(</span><span class="n">_presenter</span><span class="p">.</span><span class="n">RunCommand</span><span class="p">).</span><span class="n">Icon</span> <span class="p">=</span> <span class="n">Icon</span><span class="p">.</span><span class="n">Run</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>IScreenObjectRegistry</code> will be inspected in a future post. The next post
though, will take a closer look at the <code>ScreenCollection</code>. So, if you&#8217;re
eager to learn more about the diamonds and jewels Jeremy has created in
StoryTellers trunk (like I am) rejoin me for the next post when it&#8217;s
time to go diving again &#8230;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/08/07/diving-into-the-storyteller-trunk-part-6-the-main-players-in-the-screen-activation-lifecycle/">Diving Into the StoryTeller Trunk, Part 6: The Main Players in the Screen Activation Lifecycle</a></h1>
    
    
      <p class="meta">
        





  



<time datetime="2009-08-07T19:42:40+02:00" pubdate  data-updated="true" >Aug 7<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It has been an interesting time with the StoryTeller codebase so far.
I&#8217;ve learned a lot about advanced StructureMap usage by scanning through
the code, trying to understand the unit tests, debugging StoryTeller and
writing some smaller programs based on the newly discovered patterns &amp;
features. However, my initial motivation for spending time with that
codebase wasn&#8217;t StructureMap or the Convention over Configuration topic
but rather StoryTellers implementation of the screen activation
lifecycle. Jeremy wrote bits about it in his &#8220;Build your Own Cab&#8221;
series, but they where rather abstract and didn&#8217;t show a lot of code.
Many responsibilities he described seemed totally logical to me, but I
had trouble putting all those concepts together into code (which mostly
undermines that I only understood have of the stuff I read ;-)). Things
became really interesting again when Jeremy showed more parts at the
Presentation Patterns talk at last NDC. Damn, I wasn&#8217;t aware that a lot
of the patterns he described were already implemented in the StoryTeller
codebase (or did they emerge after the recent rewrite ???). With part 6
of my Story Teller journey I would like to spend some time describing
the general players in the screen activation lifecycle. This will be a
no-code-post. A high level view so to say.</p>

<h2>ScreenCollection</h2>

<p>In his Presentation Patterns talk Jeremy described that the kind of desktop
application he worked on in the past implemented mostly one of two major
navigation styles: Tab-style navigation or Web-style-navigation..</p>

<ul>
<li>Tab-style-navigation more or less means that every new screen or
control is displayed on a different tab, a new content control in
the UI.</li>
<li>Web-style-navigation means that every new screen or control is
mostly displayed in the same content control and replaces the
previously displayed control. Basically a way how a browser handles
things (of course, in the old ages before the empire, hm I mean tab
;-)).</li>
</ul>


<p>StoryTeller implements a Tab-style navigation. However you don&#8217;t
interact with a TabControl directly in StoryTeller . It is exposed via
the <code>IScreenCollection</code> interface. The functionality of this interface is
mostly similar to CAL/CAG/PRISMs <code>IRegion</code> or the old <code>IWorkspace</code> interface
in CAB. However there&#8217;s a huge difference in what the <code>IScreenCollection</code>
accepts in his <code>Open</code>, <code>Close</code> or <code>Activate</code> methods. They don&#8217;t accept
UserControls or UIElements, they accept only instances implementing the
<code>IScreen</code> interface.</p>

<h2>Screen</h2>

<p>The complete screen activation lifecycle in StoryTeller is based on the <code>IScreen</code> interface and therefore
completely decoupled from the related UI technology. Testability, baby !!!</p>

<p>The screen interface is mostly implemented directly by Presenters or ViewModels and exposes methods for determining current caption for the
screen, or the activation and deactivation of commands. Screens are
created by a <code>ScreenSubject</code>.</p>

<h2>ScreenSubject </h2>

<p><code>ScreenSubject</code> is a really nice abstraction which deals with the creation and the identification of
a particular screen. This abstraction is really valuable in applications which behave a lot like Visual Studio when opening code files. Think
about it, when you first open up a source code file by double clicking it in the Source Code Explorer a new tab or window is created for it.
Double clicking the file again doesn&#8217;t open a new window but rather activates the related tab or window. That&#8217;s exactly what the
ScreenSubject abstraction tries to achieve, too. Freeing the consumer code from the decision whether to create a new screen or to activate an
already existing screen is the responsibility of the <code>ScreenSubject</code>
implementations.</p>

<h2>ShellConductor </h2>

<p>The <code>ShellConductor</code> is THE BIG PLAYER in the screen activation lifecycle. In Martin Fowlers terms the
<code>ShellConductor</code> fulfills the role of the <code>ApplicationController</code>. The <code>ShellConductor</code> is the piece of code that (besides some other topics)
controls and coordinates the whole Screen handling. He is responsible for screen activation and deactivation, controls the closing of Screens
and acts as kind of a facade for typical application code working with the framework. You could say that the ScreenConductor is an
<code>ApplicationController</code> broken down into more smaller, specialized parts.</p>

<p>As you can imagine the <code>ShellConductor</code> knows a lot of his buddies in the neighborhood. Just to give you an impression how a typical operation on
it might look like, I&#8217;d like to walk you through the simple topic of opening a screen in the UI. Here are the Steps:</p>

<ol>
<li>Client code calls <code>OpenScreen(new MyScreenSubject())</code> on the
<code>ShellConductor</code>.</li>
<li><code>ShellConductor</code> knows the <code>ScreenCollection</code> and tries to find a <code>IScreen</code>
matching the subject in the collection.</li>
<li>If a Screen was found, it&#8217;s activated.</li>
<li>If no Screen was found, the <code>ShellConductor</code>

<ol>
<li>creates the target screen via the supplied <code>ScreenSubject</code>,</li>
<li>adds it to the <code>ScreenCollection</code> and</li>
<li>activates it in the <code>ScreenCollection</code>.</li>
</ol>
</li>
</ol>


<p>The <code>ShellConductor</code> will be a larger topic I&#8217;m going to look into in one
of the next posts, so please forgive me for the moment if I continue my
overview with the last element for today, the <code>Shell</code>.</p>

<h2>Shell </h2>

<p>The <code>Shell</code> is the host window for the application. It&#8217;s the frame in which the
<code>ScreenCollection</code> and <code>Screens</code> are displayed. It&#8217;s actually pretty dumb,
since it only has kind of a container functionality.</p>

<h2>What I didn&#8217;t touch today </h2>

<p>To be honest there is a more in the StoryTeller UI layer
than the stuff I described today. On of the major topics for instance I
left out for the moment is the whole topic dealing with <code>Commands</code>,
<code>CommandBindings</code> and <code>InputGestures</code>. StoryTeller shows a nice way of how to use a little internal Dsl for defining Commands on the fly. So far
I&#8217;ve looked at it only sufficiently but it looks really promising. I&#8217;m
definitely going to spend a post or two for that topic, so stay tuned.</p>

<p>See you next time when it&#8217;s time to look at some code again &#8230;</p>
</div>
  
  


    </article>
  
  <nav class="pagination">
    <div>
      
        <a class="prev" href="/blog/page/4/">&larr; Older</a>
      
      <a href="/blog/archives">Blog Archives</a>
      
      <a class="next" href="/blog/page/2/">Newer &rarr;</a>
      
    </div>
  </nav>
</div>
<aside class="sidebar">
  
    <section>
	<h1>About me</h1>
  <p><br/><img src="/images/bjro-eyes.jpg" alt="portrait" /></p>
	<p>
  My name is <strong>BjÃ¶rn Rochel</strong>.  I&#8217;m a 32 year old geek, who&#8217;s crazy about software development, living in Cologne and
  currently working for <a href="http://www.intercomponentware.com">ICW</a> as a Developer / Architect.
	</p>
	<ul id="badges">
    <li><a id="xing" href="http://www.xing.com/profile/Bjoern_Rochel"><span>XING</span></a></li>
    <li><a id="github" href="http://www.github.com/BjRo"><span>Github</span></a></li>
    <li><a id="twitter" href="http://www.twitter.com/bjoernrochel"><span>Twitter</span></a></li>
    <li><a id="rss" href="/atom.xml"><span>Rss</span></a></li>
	</ul>
</section>

<section>
  <h1>Categories</h1>
  <ul id='categories'>
<li><a href='http://www.bjoernrochel.de/blog/categories/Conferences/'>Conferences (8)</a></li>
<li><a href='http://www.bjoernrochel.de/blog/categories/FSharp/'>FSharp (3)</a></li>
<li><a href='http://www.bjoernrochel.de/blog/categories/Katas/'>Katas (2)</a></li>
<li><a href='http://www.bjoernrochel.de/blog/categories/StoryTeller/'>StoryTeller (14)</a></li>
<li><a href='http://www.bjoernrochel.de/blog/categories/StructureMap/'>StructureMap (9)</a></li>
<li><a href='http://www.bjoernrochel.de/blog/categories/Testing/'>Testing (20)</a></li>
<li><a href='http://www.bjoernrochel.de/blog/categories/Uncategorized/'>Uncategorized (8)</a></li>
<li><a href='http://www.bjoernrochel.de/blog/categories/dotnet/'>dotnet (65)</a></li>
<li><a href='http://www.bjoernrochel.de/blog/categories/ruby/'>ruby (3)</a></li>
<li><a href='http://www.bjoernrochel.de/blog/categories/sw-design/'>sw-design (13)</a></li>
<li><a href='http://www.bjoernrochel.de/blog/categories/xUnitBDDExtensions/'>xUnitBDDExtensions (15)</a></li>
</ul>

</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("bjoernrochel", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/bjoernrochel" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @bjoernrochel</a>
  
</section>

<section>
<h1>Disclaimer</h1>
<p>
The opinions expressed herein are my own personal opinions and do not necessarily represent the opinion of any other organization or person, including (but not limited to) my fellow employees, my employer, its clients or their agents. 
</p>
<p>
 Copyright &copy; 2011 - BjÃ¶rn Rochel
</p>
<section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2011 - BjÃ¶rn Rochel -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'bjro';
      
        
        var disqus_script = 'count.js';
      

    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>







</body>
</html>
