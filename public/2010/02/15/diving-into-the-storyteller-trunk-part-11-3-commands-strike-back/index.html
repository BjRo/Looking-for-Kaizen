
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Diving into the StoryTeller trunk, Part 11.3: Commands strike back - Dude, where's my Kaizen?</title>
  <meta name="author" content="Björn Rochel">

  
  <meta name="description" content="One of the things that can hit you really hard when writing blog posts about open source software (like StoryTeller is),is the fact that your posts &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.bjoernrochel.de/2010/02/15/diving-into-the-storyteller-trunk-part-11-3-commands-strike-back/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Dude, where's my Kaizen?" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

</head>

<body   >
  <header role="banner"><div id="logo">
	<img src="/images/kaizen.png" alt="Kaizen" title="Kaizen" />
</div>
<hgroup>
  <h1><a href="/">Dude, where's my Kaizen?</a></h1>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.bjoernrochel.de" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Diving Into the StoryTeller Trunk, Part 11.3: Commands Strike Back</h1>
    
    
      <p class="meta">
        





  



<time datetime="2010-02-15T20:21:20+01:00" pubdate  data-updated="true" >Feb 15<span>th</span>, 2010</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>One of the things that can hit you really hard when writing blog posts about open source software (like StoryTeller is),
is the fact that your posts tend to get very fast outdated, especially when you don&#8217;t pay that much attention to the detail (like I did, sigh).
If you&#8217;re not aware of what I&#8217;m talking about, it&#8217;s StoryTellers command story. I&#8217;m not sure when it changed but it definitely has changed and I
needed to update my last post <a href="/2010/01/09/diving-into-the-storyteller-trunk-part-11-2-more-on-commands/">11.2</a> quite a bit in order
to reflect the changes. Today I would like to conclude my trip through StoryTellers UI infrastructure with a look at how Commands are integrated
into the Screen Activation Lifecycle.</p>

<!--more-->


<p>Some of my older posts on the topic showed that the component responsible for Screen activation and deactivation in StoryTeller is the <code>ScreenConductor</code>.
However, when the <code>ScreenConductor</code> activates or deactivates a Screen, it delegates a major part of work to the so called <code>IShellService</code>.
The only implementer of this interface, the <code>ShellService</code>, is just a little facade around three things.</p>

<ol>
<li>The <code>ICommandbar</code>, which is the main toolbar of StoryTeller,</li>
<li>the <code>IOptionsMenu</code>, which is a kind of Shortcut menu for StoryTellers Commands and</li>
<li>the <code>IScreenObjectRegistry</code>, which acts as a store  / front-end for the current Command registration.</li>
</ol>


<figure class='code'><figcaption><span>The ShellService</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ShellService</span> <span class="p">:</span> <span class="n">IShellService</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ICommandBar</span> <span class="n">_Commands</span><span class="p">;</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IOptionsMenu</span> <span class="n">_options</span><span class="p">;</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IScreenObjectRegistry</span> <span class="n">_registry</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">ShellService</span><span class="p">(</span>
</span><span class='line'>          <span class="n">IScreenObjectRegistry</span> <span class="n">registry</span><span class="p">,</span>
</span><span class='line'>          <span class="n">ICommandBar</span> <span class="n">Commands</span><span class="p">,</span>
</span><span class='line'>          <span class="n">IOptionsMenu</span> <span class="n">options</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">_registry</span> <span class="p">=</span> <span class="n">registry</span><span class="p">;</span>
</span><span class='line'>        <span class="n">_Commands</span> <span class="p">=</span> <span class="n">Commands</span><span class="p">;</span>
</span><span class='line'>        <span class="n">_options</span> <span class="p">=</span> <span class="n">options</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#region IShellService Members</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">ActivateScreen</span><span class="p">(</span><span class="n">IScreen</span> <span class="n">screen</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">_registry</span><span class="p">.</span><span class="n">ClearTransient</span><span class="p">();</span>
</span><span class='line'>        <span class="n">screen</span><span class="p">.</span><span class="n">Activate</span><span class="p">(</span><span class="n">_registry</span><span class="p">);</span>
</span><span class='line'>        <span class="n">refill</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">ClearTransient</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">_registry</span><span class="p">.</span><span class="n">ClearTransient</span><span class="p">();</span>
</span><span class='line'>        <span class="n">refill</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">refill</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#endregion</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">void</span> <span class="nf">refill</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">_Commands</span><span class="p">.</span><span class="n">Refill</span><span class="p">(</span><span class="n">_registry</span><span class="p">.</span><span class="n">Actions</span><span class="p">);</span>
</span><span class='line'>        <span class="n">_options</span><span class="p">.</span><span class="n">Refill</span><span class="p">(</span><span class="n">_registry</span><span class="p">.</span><span class="n">Actions</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can see some interesting aspects in the short code above.</p>

<ol>
<li>The word transient appears several times. StoryTeller differentiates between two types of Commands:
Permanent Commands and transient Commands. Permanent Commands are displayed, well permanently, while transient Commands are
what I depicted as contextual Commands. They are Commands which should be only visible in a particular context.</li>
<li>Contextualization of Commands is handled on a per Screen basis in StoryTeller. Every time a Screen gets activated or
deactivated the <code>ICommandBar</code> and the <code>IOptionsMenu</code> get reset and completely rebuild. With this you can have a very different Command UI
depending on which Screen is activated.</li>
<li>The actual Command configuration in the Screen Activation Lifecycle is completely delegated to the active Screen. In his <code>Activate()</code> method he
receives a reference to the <code>IScreenObjectRegistry</code> which can be used in order to start the Command configuration via a small fluent API.</li>
</ol>


<figure class='code'><figcaption><span>IScreenObjectRegistry </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IScreenObjectRegistry</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">//Gets a collection of all currently known command configurations  </span>
</span><span class='line'>    <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">ScreenAction</span><span class="p">&gt;</span> <span class="n">Actions</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//Removes all transient command configurations from the registry</span>
</span><span class='line'>    <span class="k">void</span> <span class="nf">ClearTransient</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//DSL starting point for the configuration of transient Commands</span>
</span><span class='line'>    <span class="n">IActionExpression</span> <span class="nf">Action</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//DSL starting point for the configuration of permanent Commands</span>
</span><span class='line'>    <span class="n">IActionExpression</span> <span class="nf">PermanentAction</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The following code snippet shows an example of how this API could be leveraged inside a Screen.</p>

<figure class='code'><figcaption><span>Inside a screen</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Activate</span><span class="p">(</span><span class="n">IScreenObjectRegistry</span> <span class="n">screenObjects</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">screenObjects</span>
</span><span class='line'>            <span class="p">.</span><span class="n">Action</span><span class="p">(</span><span class="s">&quot;Save&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">ModifierKeys</span><span class="p">.</span><span class="n">Control</span><span class="p">,</span> <span class="n">Key</span><span class="p">.</span><span class="n">S</span><span class="p">)</span>
</span><span class='line'>             <span class="p">.</span><span class="n">To</span><span class="p">(</span><span class="n">_save</span><span class="p">);</span> <span class="c1">//This can be either Systen.Action or an System.Windows.Input.ICommand</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">screenObjects</span>
</span><span class='line'>            <span class="p">.</span><span class="n">Action</span><span class="p">(</span><span class="s">&quot;Cancel&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">Key</span><span class="p">.</span><span class="n">Escape</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">To</span><span class="p">(</span><span class="n">_cancel</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Gabriel Schenker has <a href="http://www.lostechies.com/blogs/gabrielschenker/archive/2010/01/08/fluent-silverlight-table-of-content.aspx">written an excellent series on how to write such a fluent API</a>.
Although it&#8217;s targeting Silverlight, most of the involved problems are explained in detail there, so forgive me if I don&#8217;t dive into the actual DSL implementation.</p>

<h2>Some final thoughts</h2>

<p>Making the Screen responsible for setting up his Commands makes a lot of sense to me, since the Screen is the unit which gets plugged into the UI infrastructure
and it also very likely plays the role of the Command receiver in terms of the classic GoF pattern description.
This doesn&#8217;t necessary mean that Screens are the only place for Command configuration.
The initialization of modules in a Composite application is also a very likely place for registration of permanent Commands.</p>

<p>I consider having a fluent API for configuring the Commands also a plus, because it IMHO makes the actual Command configuration a lot easier and accessible.
I&#8217;ve used the same setup (fluent API + delegation to screen) on my last 3 projects and it always worked for me like a charm.</p>

<p>Like I mentioned in the previous post, what I don&#8217;t like that much is the idea of mixing in visual aspects (Icon, Size, Location) into the Command configuration,
mostly because I&#8217;ve been burned by this in the past when facing complex menus, like the ribbon.
I think it&#8217;s a good idea to externalize the visual aspect via XML, at least for all the static stuff.</p>

<h2>This is it</h2>

<p>This was the last post about StoryTeller (at least for a while). It has been an interesting voyage which taught me a lot about UI infrastructure design,
StructureMap usage and Convention over Configuration. Although it was primarily my learning excercise I hope you took something interesting with you
from this blog series, too.</p>

<p>I&#8217;m going to continue my research on UI architecture with another deep dive into <a href="http://devlicio.us/blogs/rob_eisenberg/default.aspx">Rob Eisenbergs</a> <a href="http://www.codeplex.com/caliburn">Caliburn</a> soon.
If your interested I would be very happy to have you with me on that trip &#8230;</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">admin</span></span>

      





  



<time datetime="2010-02-15T20:21:20+01:00" pubdate  data-updated="true" >Feb 15<span>th</span>, 2010</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/storyteller/'>StoryTeller</a>, <a class='category' href='/blog/categories/dotnet/'>dotnet</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.bjoernrochel.de/2010/02/15/diving-into-the-storyteller-trunk-part-11-3-commands-strike-back/" data-via="bjoernrochel" data-counturl="http://www.bjoernrochel.de/2010/02/15/diving-into-the-storyteller-trunk-part-11-3-commands-strike-back/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
</div>

    
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
	<h1>About me</h1>
  <p><br/><img src="/images/bjro-eyes.jpg" alt="portrait" /></p>
	<p>
  My name is <strong>Björn Rochel</strong>.  I'm a 32 year old geek, who's crazy about software development, living in Cologne and
  currently working for <a href="http://www.intercomponentware.com">ICW</a> as a Developer / Architect.
	</p>
	<ul class="badges">
		<li><a href="http://www.xing.com/profile/Bjoern_Rochel"><img src="/images/badges/xing2-small.png" alt="Xing" /></a></li>
		<li><a href="http://www.github.com/BjRo"><img src="/images/badges/github-small.png" alt="Github" /></a></li>
		<li><a href="http://www.twitter.com/bjoernrochel"><img src="/images/badges/twitter-square-small.png" alt="Twitter" /></a></li>
		<li><a href="/atom.xml"><img src="/images/badges/rss-circle-small.png" alt="Rss" /></a></li>
	</ul>
</section>

<section>
  <h1>Categories</h1>
  <ul id="categories">
    <li class='category'><a href='/blog/categories/Conferences/'>Conferences (8)</a></li>
<li class='category'><a href='/blog/categories/FSharp/'>FSharp (3)</a></li>
<li class='category'><a href='/blog/categories/Katas/'>Katas (2)</a></li>
<li class='category'><a href='/blog/categories/StoryTeller/'>StoryTeller (14)</a></li>
<li class='category'><a href='/blog/categories/StructureMap/'>StructureMap (9)</a></li>
<li class='category'><a href='/blog/categories/Testing/'>Testing (20)</a></li>
<li class='category'><a href='/blog/categories/Uncategorized/'>Uncategorized (8)</a></li>
<li class='category'><a href='/blog/categories/dotnet/'>dotnet (65)</a></li>
<li class='category'><a href='/blog/categories/ruby/'>ruby (3)</a></li>
<li class='category'><a href='/blog/categories/sw-design/'>sw-design (13)</a></li>
<li class='category'><a href='/blog/categories/xUnitBDDExtensions/'>xUnitBDDExtensions (15)</a></li>

  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("bjoernrochel", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/bjoernrochel" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @bjoernrochel</a>
  
</section>

<section>
<h1>Disclaimer</h1>
<p>
The opinions expressed herein are my own personal opinions and do not necessarily represent the opinion of any other organization or person, including (but not limited to) my fellow employees, my employer, its clients or their agents. 
</p>
<p>
 Copyright &copy; 2011 - Björn Rochel
</p>
<section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2011 - Björn Rochel -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'bjro';
      
        

				//var disqus_developer = 1;
				var disqus_identifier = 'http://www.bjoernrochel.de/2010/02/15/diving-into-the-storyteller-trunk-part-11-3-commands-strike-back/';
				var disqus_url = 'http://www.bjoernrochel.de/2010/02/15/diving-into-the-storyteller-trunk-part-11-3-commands-strike-back/';
        var disqus_script = 'embed.js';
      

    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>







</body>
</html>
