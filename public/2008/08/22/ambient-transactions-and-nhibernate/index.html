
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ambient transactions and NHibernate - Dude, where's my Kaizen?</title>
  <meta name="author" content="Björn Rochel">

  
  <meta name="description" content="About two weeks ago we had some discussions in the german Alt.NET mailing list whether ambient transactions can be used in combinationwith NHibernate &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.bjoernrochel.de/2008/08/22/ambient-transactions-and-nhibernate/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Dude, where's my Kaizen?" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

</head>

<body   >
  <header role="banner"><div id="logo">
</div>
<hgroup>
  <h1><a href="/">Dude, where's my Kaizen?</a></h1>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.bjoernrochel.de" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Ambient Transactions and NHibernate</h1>
    
    
      <p class="meta">
        





  



<time datetime="2008-08-22T17:29:30+02:00" pubdate  data-updated="true" >Aug 22<span>nd</span>, 2008</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>About two weeks ago we had some discussions in the german Alt.NET mailing list whether ambient transactions can be used in combination
with NHibernate, especially regarding performance implications of such an approach. Background of that discussion was that my colleague
<a href="http://shishkin.org">Sergey</a> and I wanted to implement the repository pattern based on Linq 2 NHibernate in a way that exposes no NHibernate
dependency to a surrounding layer. Besides that we didn&#8217;t want to dublicate the UnitOfWork pattern that NHibernate implements internally.
Because of that we decided to try out ambient transactions (<code>System.Transactions</code>) as our UnitOfWork. Sergey has already posted about
the design we&#8217;re currently investigating, so I won&#8217;t go into detail about that here. You can read more here:</p>

<ul>
<li><a href="http://sergeyshishkin.spaces.live.com/blog/cns!9F19E53BA9C1D63F!263.entry">Repository Pattern revised</a></li>
<li><a href="http://sergeyshishkin.spaces.live.com/blog/cns!9F19E53BA9C1D63F!265.entry">UnitOfWork Pattern revised</a></li>
<li><a href="http://sergeyshishkin.spaces.live.com/blog/cns!9F19E53BA9C1D63F!264.entry">Specification Pattern revised</a></li>
</ul>


<p>We started with a simple test comparison between the behavior of <code>NHibernates</code> native <code>ITransactions</code> and NHibernate using
<code>TransactionScope</code> for transactions. What we noticed :</p>

<h2>FlushMode.Commit doesn&#8217;t work when using ambient Transactions</h2>

<p>The following (xUnit) test fails:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="na">[Fact]</span>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">Session_should_be_clean_after_commited_transaction</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="p">(</span><span class="n">var</span> <span class="n">tx</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TransactionScope</span><span class="p">())</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">SaveTwoPatients</span><span class="p">();</span>
</span><span class='line'>      <span class="n">tx</span><span class="p">.</span><span class="n">Complete</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">Session</span><span class="p">.</span><span class="n">IsDirty</span><span class="p">().</span><span class="n">ShouldBeFalse</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>But this can be easily fixed like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="na">[Fact]</span>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">Session_should_be_clean_after_commited_transaction_Fixed</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="p">(</span><span class="n">var</span> <span class="n">tx</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TransactionScope</span><span class="p">())</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>          <span class="n">Transaction</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">TransactionCompleted</span> <span class="p">+=</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="p">=&gt;</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Transaction</span><span class="p">.</span><span class="n">TransactionInformation</span><span class="p">.</span><span class="n">Status</span> <span class="p">==</span> <span class="n">TransactionStatus</span><span class="p">.</span><span class="n">Committed</span><span class="p">)</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="n">Session</span><span class="p">.</span><span class="n">Flush</span><span class="p">();</span>
</span><span class='line'>                  <span class="n">Session</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">};</span>
</span><span class='line'>          
</span><span class='line'>          <span class="n">SaveTwoPatients</span><span class="p">();</span>
</span><span class='line'>          <span class="n">tx</span><span class="p">.</span><span class="n">Complete</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">Session</span><span class="p">.</span><span class="n">IsDirty</span><span class="p">().</span><span class="n">ShouldBeFalse</span><span class="p">();</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>For some reason ambient Transaction are FASTER than NHibernates native counter parts</h2>

<p>We have also some tests that perform a transactional insert a 1000 times. The duration of those tests are
quite surprising. Have a look:</p>

<p><a href="/images/posts/nhibernatetransactions.png" title="NHibernate transactions"><img src="/images/posts/nhibernatetransactions.png" alt="NHibernateTransactions" /></a></p>

<p>This has nothing to do with jitting in the CLR or the order how test are executed. I double checked the durations and ran each test on his own.
I didn&#8217;t expect that gap, but I&#8217;m also not a NHibernate pro. Any thoughts? I&#8217;ll write more about our experiences with that approach soon.
Our concept looks good on paper and our first impressions are not disproving either, so stay tuned &#8230;</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">BjRo</span></span>

      





  



<time datetime="2008-08-22T17:29:30+02:00" pubdate  data-updated="true" >Aug 22<span>nd</span>, 2008</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/dotnet/'>dotnet</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.bjoernrochel.de/2008/08/22/ambient-transactions-and-nhibernate/" data-via="bjoernrochel" data-counturl="http://www.bjoernrochel.de/2008/08/22/ambient-transactions-and-nhibernate/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
</div>

    
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
	<h1>About me</h1>
  <p><br/><img src="/images/bjro-eyes.jpg" alt="portrait" /></p>
	<p>
  My name is <strong>Björn Rochel</strong>.  I'm a 32 year old geek, who's crazy about software development, living in Cologne and
  currently working for <a href="http://www.intercomponentware.com">ICW</a> as a Developer / Architect.
	</p>
	<ul id="badges">
    <li><a id="xing" href="http://www.xing.com/profile/Bjoern_Rochel"><span>XING</span></a></li>
    <li><a id="github" href="http://www.github.com/BjRo"><span>Github</span></a></li>
    <li><a id="twitter" href="http://www.twitter.com/bjoernrochel"><span>Twitter</span></a></li>
    <li><a id="rss" href="/atom.xml"><span>Rss</span></a></li>
	</ul>
</section>

<section>
  <h1>Categories</h1>
  <ul id='categories'>
<li><a href='blog/categories/Conferences/'>Conferences (8)</a></li>
<li><a href='blog/categories/FSharp/'>FSharp (3)</a></li>
<li><a href='blog/categories/Katas/'>Katas (2)</a></li>
<li><a href='blog/categories/StoryTeller/'>StoryTeller (14)</a></li>
<li><a href='blog/categories/StructureMap/'>StructureMap (9)</a></li>
<li><a href='blog/categories/Testing/'>Testing (20)</a></li>
<li><a href='blog/categories/Uncategorized/'>Uncategorized (8)</a></li>
<li><a href='blog/categories/dotnet/'>dotnet (65)</a></li>
<li><a href='blog/categories/ruby/'>ruby (3)</a></li>
<li><a href='blog/categories/sw-design/'>sw-design (13)</a></li>
<li><a href='blog/categories/xUnitBDDExtensions/'>xUnitBDDExtensions (15)</a></li>
</ul>

</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("bjoernrochel", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/bjoernrochel" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @bjoernrochel</a>
  
</section>

<section>
<h1>Disclaimer</h1>
<p>
The opinions expressed herein are my own personal opinions and do not necessarily represent the opinion of any other organization or person, including (but not limited to) my fellow employees, my employer, its clients or their agents. 
</p>
<p>
 Copyright &copy; 2011 - Björn Rochel
</p>
<section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2011 - Björn Rochel -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'bjro';
      
        

				//var disqus_developer = 1;
				var disqus_identifier = 'http://www.bjoernrochel.de/2008/08/22/ambient-transactions-and-nhibernate/';
				var disqus_url = 'http://www.bjoernrochel.de/2008/08/22/ambient-transactions-and-nhibernate/';
        var disqus_script = 'embed.js';
      

    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>







</body>
</html>
