
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Implementing a fluent API for the ribbon - Dude, where's my Kaizen?</title>
  <meta name="author" content="Björn Rochel">

  
  <meta name="description" content="For the last two weeks I&#8217;ve been engaged in implementing an internal Domain Specific Language (DSL) for dealing with the ribbon in a &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.bjoernrochel.de/2008/08/10/implementing-a-fluent-api-for-the-ribbon/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Dude, where's my Kaizen?" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

</head>

<body   >
  <header role="banner"><div id="logo">
	<img src="/images/kaizen.png" alt="Kaizen" title="Kaizen" />
</div>
<hgroup>
  <h1><a href="/">Dude, where's my Kaizen?</a></h1>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.bjoernrochel.de" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Implementing a Fluent API for the Ribbon</h1>
    
    
      <p class="meta">
        





  



<time datetime="2008-08-10T20:07:44+02:00" pubdate  data-updated="true" >Aug 10<span>th</span>, 2008</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>For the last two weeks I&#8217;ve been engaged in implementing an internal Domain Specific Language (DSL) for dealing with the ribbon in a Windows
Forms composite client. For those of you who haven&#8217;t heard of the ribbon before, it&#8217;s the <a href="http://en.wikipedia.org/wiki/Ribbon_(computing">new user interface</a>) microsoft introduced with MS Office 2007.
Those two weeks have really been interesting, mostly because this was the first time I actually tried to build a large internal DSL.</p>

<p>In this post I would like to talk a bit about internal dsls, the implementation of the ribbon dsl and what I learned from those two weeks &#8230;</p>

<!--more-->


<h2>So, what is actually an internal dsl?</h2>

<p>So what is an internal dsl actually? An internal dsl is basically just another style of an API, which follows a more language-oriented approach.
Instead of following the classic <a href="http://martinfowler.com/bliki/CommandQuerySeparation.html">CommandQuerySeparation</a> - principle, it encourages a more fluent style of programming, which
when read out loud by a reader is intent revealing enough to understand what the code basically does.
Martin Fowler and Eric Evans coined the term fluent API to describe this behavior, which I will use too in the rest of this post.
Source code and pictures usally say more than a hundred words, so here a some examples for fluent APIs.</p>

<figure class='code'><figcaption><span>Container configuration in Castle Windsor </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>   <span class="n">container</span><span class="p">.</span><span class="n">Register</span><span class="p">(</span><span class="n">Component</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">ICommand</span><span class="p">&gt;()</span>
</span><span class='line'>          <span class="p">.</span><span class="n">Named</span><span class="p">(</span><span class="n">CommandNames</span><span class="p">.</span><span class="n">StartSearch</span><span class="p">)</span>
</span><span class='line'>          <span class="p">.</span><span class="n">ImplementedBy</span><span class="p">&lt;</span><span class="n">SearchCommand</span><span class="p">&gt;()</span>
</span><span class='line'>          <span class="p">.</span><span class="n">LifeStyle</span><span class="p">.</span><span class="n">Singleton</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Assertions with the constraint - API in NUnit</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">Assert</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="s">&quot;Foo&quot;</span><span class="p">,</span> <span class="n">Is</span><span class="p">.</span><span class="n">Not</span><span class="p">.</span><span class="n">Null</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Fluent Mocking with Rhino.Mocks: </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">using</span> <span class="p">(</span><span class="n">Record</span><span class="p">())</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">Expect</span><span class="p">.</span><span class="n">Call</span><span class="p">(</span><span class="n">_FormFactory</span><span class="p">.</span><span class="n">LoadForm</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
</span><span class='line'>      <span class="p">.</span><span class="n">IgnoreArguments</span><span class="p">()</span>
</span><span class='line'>      <span class="p">.</span><span class="n">Return</span><span class="p">(</span><span class="k">new</span> <span class="n">DummyForm</span><span class="p">())</span>
</span><span class='line'>      <span class="p">.</span><span class="n">Constraints</span><span class="p">(</span><span class="k">new</span> <span class="n">ValidFormConfigurationConstraint</span><span class="p">());</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Did you notice one thing the examples above all have in common? <strong>Yes, they&#8217; re all OSS!</strong>
A lot of OSS-projects have embraced fluent APIs in the past or seem to embrace this API style lately. Although they&#8217;re currently just the
minority of existing APIs out there, it&#8217;s interesting to watch the emergence of more language-oriented APIs, even in the .NET Framework
core. I think nobody will slap me when I say that Linq can be described as an internal dsl for querying data. You may have guessed it, I like fluent APIs a lot.
I won&#8217;t say they are applicable everywhere, but personally I think there are places where they can give you quite a bit advantage in readability and testability
over regular APIs. Especially configuration and specification scenarios are very well suited for fluent apis.</p>

<h2>Possible ingredients of a fluent API</h2>

<h3>Method chaining</h3>

<p>The basic idea of method-chaining is that you directly use the return value of a method in order to invoke a method
on it and repeat this as long as needed in order to make sense as a complete sentence. The easiest way to achieve this is a class whose
methods all return a this reference. Here&#8217;s a simplified example of something I&#8217;ve written earlier this year. It&#8217;s a kind of
specification that describes the details of a form which a form framework should create. Don&#8217;t worry about the details. This is just a
shortened example.</p>

<figure class='code'><figcaption><span>This is part of the class definition &#8230;</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">FormCreationExpression</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="nf">FormCreationExpression</span><span class="p">(</span><span class="n">Guid</span> <span class="n">formId</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">_Configuration</span> <span class="p">=</span> <span class="k">new</span> <span class="n">FormConfiguration</span><span class="p">(</span><span class="n">formId</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="n">FormCreationExpression</span> <span class="n">WithBinding</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">T</span> <span class="n">instance</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">_Configuration</span><span class="p">.</span><span class="n">AddBinding</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>&#8230; combined with a static entry point like this &#8230;</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">From</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">static</span> <span class="n">FormCreationExpression</span> <span class="nf">Template</span><span class="p">(</span> <span class="n">Guid</span> <span class="n">formId</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">new</span> <span class="nf">FormCreationExpression</span><span class="p">(</span><span class="n">formId</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>&#8230; it can be used like this</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">IClientForm</span> <span class="n">form</span> <span class="p">=</span> <span class="n">_FormFactory</span><span class="p">.</span><span class="n">CreateForm</span><span class="p">(</span><span class="n">From</span><span class="p">.</span><span class="n">Template</span><span class="p">(</span><span class="n">templateId</span><span class="p">).</span><span class="n">WithBinding</span><span class="p">(</span><span class="n">patient</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>One personal note to method chaining: If you&#8217;re using a mock framework like for instance <code>Rhino.Mocks</code> better don&#8217;t try to mock out a fluent interface.
Find other ways to test it. So, why am I saying this? Most mocking framework don&#8217;t have a natural syntax for configuring the expectations on fluent apis (except <a href="http://www.typemock.com"><code>TypeMock</code></a>). Because of that you have to
configure every call on the chain step by step, which is a) very tedious and b) also results in not well readable tests (which mostly smell, too).</p>

<p>The form example above is what I mostly do in order to get better testability. I mostly use fluent APIs as builders, which produce something I can easily test / verify
(In the example above it&#8217;s the configured <code>FormExpression</code>). Most of the fluent API&#8217;s I created used the <code>Fluent Builder</code> pattern.
The basic pattern for <code>Fluent Builder</code> can be easily described: Method chaining + an implicit conversion operator for the convertion into the build product.</p>

<figure class='code'><figcaption><span>A Fluent Builder</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="k">implicit</span> <span class="k">operator</span> <span class="nf">FormConfiguration</span><span class="p">(</span><span class="n">FormExpression</span> <span class="n">expression</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">expression</span><span class="p">.</span><span class="n">_Configuration</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>When I was implementing the ribbon fluent API however, I used a variation of a different pattern which is called <code>Expression Builder</code>. The idea of the <code>Expression Builder</code>
pattern is that the fluent API only is layer on top of a regular API. It serves as a kind of facade to the other api. This was especially useful because I didn&#8217;t want the ribbon API to be coupled to a particular
vendor implementation. Instead the API uses interfaces and a facade in order to perform actions on the concrete ribbon control. Please have a bit patience, I&#8217;ll show code soon.
Read <a href="http://martinfowler.com/dslwip/ExpressionBuilder.html">here</a> for a bit more on <code>Expression Builders</code>.</p>

<h3>Nested functions</h3>

<p>One problem with fluent APIs implemented only with method chaining is extensibility or reusability.Â A short example. Let&#8217;s assume we have a typical OO
situation with two products having a lot of properties in common but also some special ones. Let us further assume that we want to build
fluent builders for each of them. One approach is to use a <code>Fluent Builder</code> base class and derived builders for each product. When you do
this you have an API in which some of the methods (those implemented by the builder base class) return only a subset of the API (because they
only return an instance of the base class). In order to use the methods of the derived <code>Fluent Builder</code> in combination with those of the base
class you have to call the special methods first before continuing with the base class method in the fluent chain.</p>

<p>You can get around this (look <a href="http://sergeyshishkin.spaces.live.com/blog/cns!9F19E53BA9C1D63F!218.entry">here</a>) for more informations) with redefinition and the new operator, but imho
it doesn&#8217;t smell very good. However I haven&#8217;t found a solution which solves the problem <strong>and</strong> makes me happy. Has anyone found a better
solution? I would like to hear other thoughts on this. With that beeing said, how can extensibility be tackled without sacrificing the language
orientation. That&#8217;s where <code>Nested Functions</code> come into play. The basic idea is that you compose your fluent API out of several independant
parts/ functions. A good example for this is the constraint API that <code>NUnit</code> provides. Look at the signature of the <code>That</code> method of the <code>Assert</code>
class.</p>

<figure class='code'><figcaption><span>NUnits Assert class</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">Assert</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">That</span><span class="p">(</span><span class="kt">object</span> <span class="n">obj</span><span class="p">,</span> <span class="n">Constraint</span> <span class="n">constraint</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">//...</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Doesn&#8217;t really look fluent first, doesn&#8217;t it? But combined with a static entrypoint and a derived constraint <code>NUnit</code> is able to achive a very nice and well
readable syntax for specifiing tests.</p>

<figure class='code'><figcaption><span>NUnit constraints in Action</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">Assert</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Is</span><span class="p">.</span><span class="n">Not</span><span class="p">.</span><span class="n">Null</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>For me this API is just a single piece of beauty. Awesome :-).
You can read more about <code>Nested Functions</code> <a href="http://martinfowler.com/dslwip/NestedFunction.html">here</a>.</p>

<p>That&#8217;s all I&#8217; d wanted to show you about fluent APIs in this post. If you&#8217;re interested in learning more about fluent APIs I would highly
recommend Martin Fowlers <a href="http://martinfowler.com/dslwip/InternalOverview.html">current articles</a> about DSLs. Although they&#8217;re work in progress (as part of an upcoming book),
I consider them best resource for learning about dsls available at the moment. Before I&#8217;ll show bit from the ribbon API I want to give you an
impression what the actual requirements for the API were.</p>

<h2>The basic requirements for the ribbon API</h2>

<ol>
<li>The API should provide benefit in a composite (windows forms)
architecture, where modules are loosly coupled and UI configuration
is scattered through several modules. From a product level
perspective the API should enable very exact (and relative)
positioning of elements while the load order of modules might
change.</li>
<li>The interaction with the ribbon should be testable with unit tests.</li>
<li>Consumer code of the API should not be coupled to a particular
vendor implementation of the ribbon.</li>
<li>Consumer code should be able to configure the ribbon from any
thread.</li>
<li>Configuration via an external XML - file should be possible
(although not implemented in the current version).</li>
</ol>


<h2>An internal dsl for the ribbon</h2>

<p>One of my earliest design decisions was to design the ribbon API to be based on the <code>Command pattern</code>
internally. The decoupling that was possible with such a design allows a good level of control over the execution of the commands (which is
very important while initializing modules (Requirement 1) ). Besides that commands are a good candidate for testability, because the
configuration of the commands can be tested via unit tests whithout actually having to execute them. Because of that I decided to implement
a little variation of the <code>Fluent / Expression Builder</code> topic. Let&#8217;s look at some code. There are four static entrypoints for creating fluent
(command) builders.</p>

<p>These are the <code>CreateNew</code> class, which creates commands that when executed configure the ribbon UI,</p>

<figure class='code'><figcaption><span>Configuring the ribbon layout</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">CreateNew</span><span class="p">.</span><span class="n">Tab</span><span class="p">.</span><span class="n">Named</span><span class="p">(</span><span class="n">RibbonTabNames</span><span class="p">.</span><span class="n">Home</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">WithCaption</span><span class="p">(</span><span class="n">SR</span><span class="p">.</span><span class="n">HomeTabCaption</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">AddGroups</span><span class="p">(</span>
</span><span class='line'>      <span class="n">CreateNew</span><span class="p">.</span><span class="n">Group</span><span class="p">.</span><span class="n">Named</span><span class="p">(</span><span class="n">RibbonGroupNames</span><span class="p">.</span><span class="n">SearchGroup</span><span class="p">)</span>
</span><span class='line'>          <span class="p">.</span><span class="n">WithCaption</span><span class="p">(</span><span class="n">SR</span><span class="p">.</span><span class="n">SearchGroupCaption</span><span class="p">)</span> <span class="p">.</span><span class="n">WithVerticalLayout</span><span class="p">()</span>
</span><span class='line'>          <span class="p">.</span><span class="n">WithToolsAlignedCentered</span><span class="p">()</span>
</span><span class='line'>          <span class="p">.</span><span class="n">AddTools</span><span class="p">(</span>
</span><span class='line'>              <span class="n">CreateNew</span><span class="p">.</span><span class="n">TextBox</span><span class="p">.</span><span class="n">Named</span><span class="p">(</span><span class="n">ToolNames</span><span class="p">.</span><span class="n">SearchTextBox</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">.</span><span class="n">RaisingCommandOnReturn</span><span class="p">(</span><span class="n">CommandNames</span><span class="p">.</span><span class="n">StartSearch</span><span class="p">),</span>
</span><span class='line'>              <span class="n">CreateNew</span><span class="p">.</span><span class="n">Button</span><span class="p">.</span><span class="n">Named</span><span class="p">(</span><span class="n">ToolNames</span><span class="p">.</span><span class="n">SearchButton</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">.</span><span class="n">WithCaption</span><span class="p">(</span><span class="n">SR</span><span class="p">.</span><span class="n">SearchButtonCaption</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">.</span><span class="n">WithLargeImage</span><span class="p">(</span><span class="n">Images</span><span class="p">.</span><span class="n">Search_32</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">.</span><span class="n">WithSmallImage</span><span class="p">(</span><span class="n">Images</span><span class="p">.</span><span class="n">Search_16</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">.</span><span class="n">DisplayedAsLargeToolWithCaptionBelow</span><span class="p">()</span>
</span><span class='line'>                  <span class="p">.</span><span class="n">RaisingCommand</span><span class="p">(</span><span class="n">CommandNames</span><span class="p">.</span><span class="n">StartSearch</span><span class="p">)));</span>
</span></code></pre></td></tr></table></div></figure>


<p>the <code>Enable</code> and the <code>Disable</code> class for creating commands, which enable
or disable elements on the ribbon,</p>

<figure class='code'><figcaption><span>Enabling or disabling a tool</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">Enable</span><span class="p">.</span><span class="n">Tool</span><span class="p">(</span><span class="n">ToolNames</span><span class="p">.</span><span class="n">SearchButton</span><span class="p">).</span><span class="n">If</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">shouldActivate</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p> the <code>ChangeVisibilityOf</code> class for creating commands, which change the visibillity of elements on the ribbon,</p>

<figure class='code'><figcaption><span>Changing the visibility of a tool</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">ChangeVisibilityOf</span><span class="p">.</span><span class="n">Tool</span><span class="p">(</span><span class="n">ToolNames</span><span class="p">.</span><span class="n">SearchButton</span><span class="p">).</span><span class="n">ToInvisible</span><span class="p">()</span> <span class="p">.</span><span class="n">If</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">shouldBeInvisible</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>and the <code>Access</code> class for creating commands, which perform other read or write
operations on elements on the ribbon.</p>

<figure class='code'><figcaption><span>Accessing a tool in the ribbon</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">Access</span><span class="p">.</span><span class="n">TextBox</span><span class="p">(</span><span class="n">ToolNames</span><span class="p">.</span><span class="n">SearchTextBox</span><span class="p">).</span><span class="n">ReadText</span><span class="p">(</span> <span class="n">text</span> <span class="p">=&gt;</span> <span class="n">DisplayText</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The commands execute against a internal facade for the ribbon. This facade is completely based on
interfaces and can be adapted to different vendor APIs (at least thats the idea :-)). This is the regular API to which I referred when I
talked about <code>Expression Builder</code> previously. The next code sample shows the implementation of the <code>NewTabCommand</code> for creating new tabs on the
ribbon.</p>

<figure class='code'><figcaption><span>The implementation of the NewTabCommand</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">NewTabCommand</span> <span class="p">:</span> <span class="n">ShellCommand</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="nf">NewTabCommand</span><span class="p">(</span> <span class="n">RibbonTabConfiguration</span> <span class="n">configuration</span><span class="p">,</span> <span class="n">IEnumerable</span> <span class="n">groupBuilderCommands</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">Configuration</span> <span class="p">=</span> <span class="n">configuration</span><span class="p">;</span>
</span><span class='line'>      <span class="n">GroupBuilderCommands</span> <span class="p">=</span> <span class="n">groupBuilderCommands</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">internal</span> <span class="n">RibbonTabConfiguration</span> <span class="n">Configuration</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">internal</span> <span class="n">IEnumerable</span> <span class="n">GroupBuilderCommands</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Execute</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">var</span> <span class="n">tab</span> <span class="p">=</span> <span class="n">GetShell</span><span class="p">().</span><span class="n">CreateTab</span><span class="p">(</span><span class="n">Configuration</span><span class="p">);</span>
</span><span class='line'>      
</span><span class='line'>      <span class="k">foreach</span> <span class="p">(</span><span class="n">var</span> <span class="n">command</span> <span class="k">in</span> <span class="n">GroupBuilderCommands</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">command</span><span class="p">.</span><span class="n">OverrideTabSetting</span><span class="p">(</span><span class="n">tab</span><span class="p">);</span>
</span><span class='line'>          <span class="n">command</span><span class="p">.</span><span class="n">Execute</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>Commands</code> are executed with the <code>ICommandExecutor</code>. Main responsibility of the service is to allow thread safe access to the ribbon (which runs in the UI thread), so that the
module initialization can run multi-threaded. Is has several overloads for running commands. This is one of them:</p>

<figure class='code'><figcaption><span>Executing a ribbon command</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">ExecuteCommand</span><span class="p">(</span><span class="n">Command</span> <span class="n">command</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">Ensure</span><span class="p">.</span><span class="n">ArgumentIsNotNull</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="s">&quot;command&quot;</span><span class="p">);</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">command</span><span class="p">.</span><span class="n">IsAvailable</span><span class="p">())</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">_ThreadContextOfMainThread</span><span class="p">.</span><span class="n">Send</span><span class="p">(</span> <span class="n">c</span> <span class="p">=&gt;</span> <span class="n">command</span><span class="p">.</span><span class="n">Execute</span><span class="p">(),</span> <span class="k">null</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>To complete the picture I wrote custom assertion to make testing easy.</p>

<figure class='code'><figcaption><span>Testing support</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="na">[Test]</span>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">Command_with_false_condition_should_not_enable_tool</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">var</span> <span class="n">command</span> <span class="p">=</span> <span class="n">Enable</span><span class="p">.</span><span class="n">Tool</span><span class="p">(</span><span class="s">&quot;Foo&quot;</span><span class="p">).</span><span class="n">If</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">false</span><span class="p">);</span>
</span><span class='line'>  <span class="n">Assert</span><span class="p">.</span><span class="n">That</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">DoesNotEnable</span><span class="p">.</span><span class="n">Tool</span><span class="p">(</span><span class="s">&quot;Foo&quot;</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Some final thoughts to conclude this post</h2>

<p>It&#8217;s harder than I orignally thought to create large fluent APIs in C#. Especially code reuse and extensibility can be
barriers. C# as a statically typed language is somehow limited here (One more reason to learn more about Ruby and Boo &#8230;). I&#8217;m
particulary don&#8217;t like reusability through builder inheritance and method redefinition, though I&#8217;m doing it because of a lack of options.
Again, does anyone know a way in C# around this? Finally I really like the readability and testability of what I&#8217;ve implemented, although there
is still a lot room for improvements. Feel free to post (positive and negative) thoughts on this or domain specific languages in general.
Read you soon :-)</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">BjRo</span></span>

      





  



<time datetime="2008-08-10T20:07:44+02:00" pubdate  data-updated="true" >Aug 10<span>th</span>, 2008</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/dotnet/'>dotnet</a>, <a class='category' href='/blog/categories/sw-design/'>sw-design</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.bjoernrochel.de/2008/08/10/implementing-a-fluent-api-for-the-ribbon/" data-via="bjoernrochel" data-counturl="http://www.bjoernrochel.de/2008/08/10/implementing-a-fluent-api-for-the-ribbon/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
</div>

    
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
	<h1>About me</h1>
  <p><br/><img src="/images/bjro-eyes.jpg" alt="portrait" /></p>
	<p>
  My name is <strong>Björn Rochel</strong>.  I'm a 32 year old geek, who's crazy about software development, living in Cologne and
  currently working for <a href="http://www.intercomponentware.com">ICW</a> as a .NET Developer / Architect.
	</p>
	<ul class="badges">
		<li><a href="http://www.xing.com/profile/Bjoern_Rochel"><img src="/images/badges/xing2-small.png" alt="Xing" /></a></li>
		<li><a href="http://www.github.com/BjRo"><img src="/images/badges/github-small.png" alt="Github" /></a></li>
		<li><a href="http://www.twitter.com/bjoernrochel"><img src="/images/badges/twitter-square-small.png" alt="Twitter" /></a></li>
		<li><a href="/atom.xml"><img src="/images/badges/rss-circle-small.png" alt="Rss" /></a></li>
	</ul>
</section>

<section>
  <h1>Categories</h1>
  <ul id="categories">
    <li class='category'><a href='/blog/categories/Conferences/'>Conferences (8)</a></li>
<li class='category'><a href='/blog/categories/FSharp/'>FSharp (3)</a></li>
<li class='category'><a href='/blog/categories/Katas/'>Katas (2)</a></li>
<li class='category'><a href='/blog/categories/StoryTeller/'>StoryTeller (14)</a></li>
<li class='category'><a href='/blog/categories/StructureMap/'>StructureMap (9)</a></li>
<li class='category'><a href='/blog/categories/Testing/'>Testing (20)</a></li>
<li class='category'><a href='/blog/categories/Uncategorized/'>Uncategorized (7)</a></li>
<li class='category'><a href='/blog/categories/dotnet/'>dotnet (65)</a></li>
<li class='category'><a href='/blog/categories/ruby/'>ruby (3)</a></li>
<li class='category'><a href='/blog/categories/sw-design/'>sw-design (13)</a></li>
<li class='category'><a href='/blog/categories/xUnitBDDExtensions/'>xUnitBDDExtensions (15)</a></li>

  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("bjoernrochel", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/bjoernrochel" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @bjoernrochel</a>
  
</section>

<section>
<h1>Disclaimer</h1>
<p>
The opinions expressed herein are my own personal opinions and do not necessarily represent the opinion of any other organization or person, including (but not limited to) my fellow employees, my employer, its clients or their agents. 
</p>
<p>
 Copyright &copy; 2011 - Björn Rochel
</p>
<section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2011 - Björn Rochel -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'bjro';
      
        

				//TODO: comment disqus_developer out
				var disqus_developer = 1;
				var disqus_identifier = 'http://www.bjoernrochel.de/2008/08/10/implementing-a-fluent-api-for-the-ribbon/';
				var disqus_url = 'http://www.bjoernrochel.de/2008/08/10/implementing-a-fluent-api-for-the-ribbon/';
        var disqus_script = 'embed.js';
      

    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>







</body>
</html>
