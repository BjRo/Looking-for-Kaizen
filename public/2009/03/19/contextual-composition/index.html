
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Contextual composition - Dude, where's my Kaizen?</title>
  <meta name="author" content="BjÃ¶rn Rochel">

  
  <meta name="description" content="Today I would like to talk a little bit about something I&#8217;ve witnessed in software development over and over again. Actually, I&#8217;ve seen &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.bjoernrochel.de/2009/03/19/contextual-composition/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Dude, where's my Kaizen?" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

</head>

<body   >
  <header role="banner"><div id="logo">
	<img src="/images/kaizen.png" alt="Kaizen" title="Kaizen" />
</div>
<hgroup>
  <h1><a href="/">Dude, where's my Kaizen?</a></h1>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.bjoernrochel.de" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Contextual Composition</h1>
    
    
      <p class="meta">
        





  



<time datetime="2009-03-19T23:00:22+01:00" pubdate  data-updated="true" >Mar 19<span>th</span>, 2009</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Today I would like to talk a little bit about something I&#8217;ve witnessed in software development over and over again. Actually, I&#8217;ve seen this
more or less in every commercial codebase I&#8217;ve worked with so far. I&#8217;m talking about giant switch statements, the misuse of inheritance and
code that is so entangled that it&#8217;s a pain to work with it. And it just becomes harder and harder every day. Sounds familiar? I bet so. I&#8217;m
talking about the tiny little variations in behaviour of software and typical code that is written to handle them. Sounds abstract? Maybe a
little example might help.</p>

<h2>Example: A WorkItem viewer</h2>

<p>To be honest, I&#8217;m not really good at examples. I hope the following one is sufficient enough to transport what I&#8217;d like to show you. Let&#8217;s say we&#8217;re building
a software that displays WorkItems. WorkItems are in short a concept often used in ALM (Application Lifecycle Management) tools in order to
perform work and defect tracking. WorkItems can be assigned to a participating user. To add a little twist, let&#8217;s say that there&#8217;re two
roles in the application: Administrator and Developer. The Administrator is able to see all the items, while the Developer only sees the ones
assigned to him. This is how our little domain might look like:</p>

<p><a href="/images/posts/domain.bmp"><img src="/images/posts/domain.bmp" alt="WorkItem Domain Model" /></a></p>

<p>So let&#8217;s have a look at how this might be implemented using Windows Forms, starting with the most common type.</p>

<h2>Type 1: The procedural one</h2>

<figure class='code'><figcaption><span>A typical procedural implementation</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">WorkItemExplorer</span> <span class="p">:</span> <span class="n">Form</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">IWorkItemRepository</span> <span class="n">workItemRepository</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="nf">WorkItemExplorer</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">InitializeComponent</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="nf">WorkItemExplorer</span><span class="p">(</span><span class="n">IWorkItemRepository</span> <span class="n">workItemRepository</span><span class="p">)</span> <span class="p">:</span> <span class="k">this</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="n">workItemRepository</span> <span class="p">=</span> <span class="n">workItemRepository</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnLoad</span><span class="p">(</span><span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">IList</span> <span class="n">workItems</span><span class="p">;</span>
</span><span class='line'>      
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentPrincipal</span><span class="p">.</span><span class="n">IsInRole</span><span class="p">(</span><span class="n">ApplicationRoles</span><span class="p">.</span><span class="n">Admin</span><span class="p">))</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">workItems</span> <span class="p">=</span> <span class="n">workItemRepository</span><span class="p">.</span><span class="n">ToList</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">workItems</span> <span class="p">=</span> <span class="n">workItemRepository</span>
</span><span class='line'>                                  <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">wi</span> <span class="p">=&gt;</span> <span class="n">Equals</span><span class="p">(</span><span class="n">wi</span><span class="p">.</span><span class="n">AssignedTo</span><span class="p">.</span><span class="n">Alias</span><span class="p">,</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentPrincipal</span><span class="p">.</span><span class="n">Identity</span><span class="p">.</span><span class="n">Name</span><span class="p">))</span>
</span><span class='line'>                                  <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">wi</span> <span class="p">=&gt;</span> <span class="n">wi</span><span class="p">)</span>
</span><span class='line'>                                  <span class="p">.</span><span class="n">ToList</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      
</span><span class='line'>      <span class="n">workItemList</span><span class="p">.</span><span class="n">DataSource</span> <span class="p">=</span> <span class="n">workItems</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This piece of code really raises strong emotions in me. Don&#8217;t get me wrong I&#8217;ve written stuff like that myself, but I don&#8217;t want to see code like this
anymore. What I especially don&#8217;t like about it (besides the inability to be unit tested) is how easily it falls apart and becomes messy when new
roles with slightly different behaviour must be integrated later on.</p>

<h2>Type 2: The inheritance based one</h2>

<p>If not procedural, let&#8217;s do it the classic object oriented way. Isn&#8217;t inheritance useful to solve our
problem? Why don&#8217;t we use subclasses and polymorphism? This could get us something like this &#8230;</p>

<p><a href="/images/posts/inheritance.bmp"><img src="/images/posts/inheritance.bmp" alt="image" /></a></p>

<p>&#8230; or if you prever code:</p>

<figure class='code'><figcaption><span>Using inheritance</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">AdminWorkItemExplorer</span> <span class="p">:</span> <span class="n">Form</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">IWorkItemRepository</span> <span class="n">workItemRepository</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="nf">AdminWorkItemExplorer</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">InitializeComponent</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="nf">AdminWorkItemExplorer</span><span class="p">(</span><span class="n">IWorkItemRepository</span> <span class="n">workItemRepository</span><span class="p">)</span> <span class="p">:</span> <span class="k">this</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="n">workItemRepository</span> <span class="p">=</span> <span class="n">workItemRepository</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnLoad</span><span class="p">(</span><span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">base</span><span class="p">.</span><span class="n">OnLoad</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
</span><span class='line'>      <span class="n">workItemList</span><span class="p">.</span><span class="n">DataSource</span> <span class="p">=</span> <span class="n">LoadItems</span><span class="p">(</span><span class="n">workItemRepository</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">protected</span> <span class="k">virtual</span> <span class="n">IList</span> <span class="nf">LoadItems</span><span class="p">(</span><span class="n">IWorkItemRepository</span> <span class="n">workItemRepository</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">workItemRepository</span><span class="p">.</span><span class="n">ToList</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">DeveloperWorkItemExplorer</span> <span class="p">:</span> <span class="n">AdminWorkItemExplorer</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="nf">DeveloperWorkItemExplorer</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">InitializeComponent</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="nf">DeveloperWorkItemExplorer</span><span class="p">(</span><span class="n">IWorkItemRepository</span> <span class="n">workItemRepository</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">workItemRepository</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">protected</span> <span class="k">override</span> <span class="n">IList</span> <span class="nf">LoadItems</span><span class="p">(</span><span class="n">IWorkItemRepository</span> <span class="n">workItemRepository</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">workItemRepository</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">wi</span> <span class="p">=&gt;</span> <span class="n">Equals</span><span class="p">(</span><span class="n">wi</span><span class="p">.</span><span class="n">AssignedTo</span><span class="p">.</span><span class="n">Alias</span><span class="p">,</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentPrincipal</span><span class="p">.</span><span class="n">Identity</span><span class="p">.</span><span class="n">Name</span><span class="p">))</span>
</span><span class='line'>                      <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">wi</span> <span class="p">=&gt;</span> <span class="n">wi</span><span class="p">)</span>
</span><span class='line'>                      <span class="p">.</span><span class="n">ToList</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">WorkItemExplorerFactory</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">static</span> <span class="n">Form</span> <span class="nf">CreateExplorer</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">var</span> <span class="n">wiRepository</span> <span class="p">=</span> <span class="k">new</span> <span class="n">WorkItemRepository</span><span class="p">();</span>
</span><span class='line'>      
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentPrincipal</span><span class="p">.</span><span class="n">IsInRole</span><span class="p">(</span><span class="n">ApplicationRoles</span><span class="p">.</span><span class="n">Admin</span><span class="p">))</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="k">new</span> <span class="nf">AdminWorkItemExplorer</span><span class="p">(</span><span class="n">wiRepository</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      
</span><span class='line'>      <span class="k">return</span> <span class="k">new</span> <span class="nf">DeveloperWorkItemExplorer</span><span class="p">(</span><span class="n">wiRepository</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Instead of one we&#8217;ve now got three classes: One Form for each role in addition to a little <code>Factory</code>. The <code>Factory</code> was added to encapsulate the creation of the concrete Form. The specialized behaviour is extracted into a virtual
method and overridden where it was needed. This is code I&#8217;ve seen less often in my career than the procedural one, but still I&#8217;ve seen it
often. This was the standard way for me personally to handle variation not so many years ago. When I originally started to write code for
object oriented systems, I almost all the time thought OO was about solving problems through inheritance. I can only guess, but I tend to
think that same applies to a lot of other developers out there. So what might be wrong with this design? First the obvious one: A
<code>DeveloperWorkItemExplorer</code> is a specialized <code>AdminWorkItemExplorer</code>. Aha, nice one! Inheritance is only used for technical reasons here. The
inheritance chain by itself doesn&#8217;t really make sense on its own.  Besides that the <code>Extract &amp; Override-Pattern</code> used here also tends to
degrade very fast. After time you&#8217;ll often see more and more virtual methods appear in your class hierarchy as more variations are introduced
to your system. Another thing to mention is that you can only inherit once in .NET. The inheritance based solution becomes quickly messy when
you have to share code between different leaves of the inheritance tree, which are in no direct connection.</p>

<h2>Type 3: A glimpse at contextual composition</h2>

<p>Why don&#8217;t we use composition to achieve what we need? Let&#8217;s play a bit with generics and
try to build classes which can be composed together. Let&#8217;s look at a possible implementation and its implications.</p>

<p><a href="/images/posts/contextualcomposition.bmp"><img src="/images/posts/contextualcomposition.bmp" alt="image" /></a></p>

<p>So whats different here (besides the amount of involved components :-))?</p>

<p>There is only one View. The complete behaviour is moved into a newly created <code>Presenter</code> class.</p>

<figure class='code'><figcaption><span>Refactoring to composition with a swappable Presenter</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">WorkItemExplorerView</span> <span class="p">:</span> <span class="n">Form</span><span class="p">,</span> <span class="n">IWorkItemView</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">IPresenter</span> <span class="n">presenter</span><span class="p">;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="nf">WorkItemExplorerView</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">InitializeComponent</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="nf">WorkItemExplorerView</span><span class="p">(</span><span class="n">IPresenter</span> <span class="n">presenter</span><span class="p">)</span> <span class="p">:</span> <span class="k">this</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="n">presenter</span> <span class="p">=</span> <span class="n">presenter</span><span class="p">;</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="n">presenter</span><span class="p">.</span><span class="n">View</span> <span class="p">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="cp">#region IWorkItemView Members public void RenderWorkItems(IList workItems) </span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">workItemList</span><span class="p">.</span><span class="n">DataSource</span> <span class="p">=</span> <span class="n">workItems</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="cp">#endregion</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnLoad</span><span class="p">(</span><span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">base</span><span class="p">.</span><span class="n">OnLoad</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
</span><span class='line'>      <span class="n">presenter</span><span class="p">.</span><span class="n">Load</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>There&#8217;re two presenters, one for each role.</p>

<figure class='code'><figcaption><span>The Presenters</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">AdminWorkItemExplorerPresenter</span> <span class="p">:</span> <span class="n">Presenter</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">IWorkItemRepository</span> <span class="n">repository</span><span class="p">;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="nf">AdminWorkItemExplorerPresenter</span><span class="p">(</span><span class="n">IWorkItemRepository</span> <span class="n">repository</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="n">repository</span> <span class="p">=</span> <span class="n">repository</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Load</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>          <span class="n">View</span><span class="p">.</span><span class="n">RenderWorkItems</span><span class="p">(</span><span class="n">repository</span><span class="p">.</span><span class="n">ToList</span><span class="p">());</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">DeveloperWorkItemExplorerPresenter</span> <span class="p">:</span> <span class="n">Presenter</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">IWorkItemRepository</span> <span class="n">repository</span><span class="p">;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="nf">DeveloperWorkItemExplorerPresenter</span><span class="p">(</span><span class="n">IWorkItemRepository</span> <span class="n">repository</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="n">repository</span> <span class="p">=</span> <span class="n">repository</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Load</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">View</span><span class="p">.</span><span class="n">RenderWorkItems</span><span class="p">(</span> <span class="n">repository</span>
</span><span class='line'>          <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">wi</span><span class="p">=&gt;</span> <span class="n">Equals</span><span class="p">(</span><span class="n">wi</span><span class="p">.</span><span class="n">AssignedTo</span><span class="p">.</span><span class="n">Alias</span><span class="p">,</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentPrincipal</span><span class="p">.</span><span class="n">Identity</span><span class="p">.</span><span class="n">Name</span><span class="p">))</span>
</span><span class='line'>          <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">wi</span> <span class="p">=&gt;</span> <span class="n">wi</span><span class="p">)</span>
</span><span class='line'>          <span class="p">.</span><span class="n">ToList</span><span class="p">());</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The Factory is composed out of reusable parts.</p>

<figure class='code'><figcaption><span>A generic composable factory</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IFactory</span><span class="p">&lt;</span><span class="n">TSubject</span><span class="p">,</span> <span class="n">TContext</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">TSubject</span> <span class="nf">Create</span><span class="p">(</span><span class="n">TContext</span> <span class="n">context</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">InlineFactory</span><span class="p">&lt;</span><span class="n">TSubject</span><span class="p">,</span> <span class="n">TContext</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IFactory</span><span class="p">&lt;</span><span class="n">TFactory</span><span class="p">,</span> <span class="n">TContext</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">TContext</span><span class="p">,</span> <span class="n">TSubject</span><span class="p">&gt;</span> <span class="n">inlineFactory</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="nf">InlineFactory</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">TContext</span><span class="p">,</span> <span class="n">TSubject</span><span class="p">&gt;</span> <span class="n">inlineFactory</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="n">inlineFactory</span> <span class="p">=</span> <span class="n">inlineFactory</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>      
</span><span class='line'>  <span class="cp">#region IFactory&lt;TContext, TSubject&gt; Members </span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="n">TSubject</span> <span class="nf">Create</span><span class="p">(</span><span class="n">TContext</span> <span class="n">context</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="nf">inlineFactory</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>      
</span><span class='line'>  <span class="cp">#endregion </span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IContextualFactory</span><span class="p">&lt;</span><span class="n">TSubject</span><span class="p">,</span> <span class="n">TContext</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IFactory</span><span class="p">&lt;</span><span class="n">TSubject</span><span class="p">,</span> <span class="n">TContext</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">bool</span> <span class="nf">CanHandle</span><span class="p">(</span><span class="n">TContext</span> <span class="n">context</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ContextualFactory</span><span class="p">&lt;</span><span class="n">TSubject</span><span class="p">,</span><span class="n">TContext</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IContextualFactory</span><span class="p">&lt;</span><span class="n">TSubject</span><span class="p">,</span> <span class="n">TContext</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">ISpecification</span><span class="p">&lt;</span><span class="n">TContext</span><span class="p">&gt;</span> <span class="n">contextSpec</span><span class="p">;</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">IFactory</span><span class="p">&lt;</span><span class="n">TSubject</span><span class="p">,</span> <span class="n">TContext</span><span class="p">&gt;</span> <span class="n">factory</span><span class="p">;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="nf">ContextualFactory</span><span class="p">(</span>
</span><span class='line'>      <span class="n">ISpecification</span><span class="p">&lt;</span><span class="n">TContext</span><span class="p">&gt;</span> <span class="n">contextSpec</span><span class="p">,</span>
</span><span class='line'>      <span class="n">IFactory</span><span class="p">&lt;</span><span class="n">TSubject</span><span class="p">,</span> <span class="n">TContext</span><span class="p">&gt;</span> <span class="n">factory</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">this</span><span class="p">.</span><span class="n">contextSpec</span> <span class="p">=</span> <span class="n">contextSpec</span><span class="p">;</span>
</span><span class='line'>          <span class="k">this</span><span class="p">.</span><span class="n">factory</span> <span class="p">=</span> <span class="n">factory</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      
</span><span class='line'>  <span class="k">public</span> <span class="nf">ContextualFactory</span><span class="p">(</span>
</span><span class='line'>      <span class="n">Predicate</span><span class="p">&lt;</span><span class="n">TContext</span><span class="p">&gt;</span> <span class="n">inlineSpec</span><span class="p">,</span>
</span><span class='line'>      <span class="n">Func</span><span class="p">&lt;</span><span class="n">TContext</span><span class="p">,</span> <span class="n">TSubject</span><span class="p">&gt;</span> <span class="n">inlineFactory</span><span class="p">)</span> <span class="p">:</span> <span class="k">this</span><span class="p">(</span>
</span><span class='line'>          <span class="k">new</span> <span class="nf">InlineSpecification</span><span class="p">(</span><span class="n">inlineSpec</span><span class="p">),</span>
</span><span class='line'>          <span class="k">new</span> <span class="nf">InlineFactory</span><span class="p">(</span><span class="n">inlineFactory</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="cp">#region IContextualFactory&lt;TSubject, TContext&gt; Members </span>
</span><span class='line'>      
</span><span class='line'>  <span class="k">public</span> <span class="kt">bool</span> <span class="nf">CanHandle</span><span class="p">(</span><span class="n">TContext</span> <span class="n">context</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">contextSpec</span><span class="p">.</span><span class="n">IsSatisfiedBy</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>      
</span><span class='line'>  <span class="k">public</span> <span class="n">TSubject</span> <span class="nf">Create</span><span class="p">(</span><span class="n">TContext</span> <span class="n">context</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">factory</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="cp">#endregion</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">ISpecification</span><span class="p">&lt;</span><span class="n">TSubject</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">bool</span> <span class="nf">IsSatisfiedBy</span><span class="p">(</span><span class="n">TSubject</span> <span class="n">subject</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">InlineSpecification</span> <span class="p">:</span> <span class="n">ISpecification</span><span class="p">&lt;</span><span class="n">TSubject</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">Predicate</span><span class="p">&lt;</span><span class="n">TSubject</span><span class="p">&gt;</span> <span class="n">predicate</span><span class="p">;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="nf">InlineSpecification</span><span class="p">(</span><span class="n">Predicate</span><span class="p">&lt;</span><span class="n">TSubject</span><span class="p">&gt;</span> <span class="n">predicate</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="n">predicate</span> <span class="p">=</span> <span class="n">predicate</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="kt">bool</span> <span class="nf">IsSatisfiedBy</span><span class="p">(</span><span class="n">Subject</span> <span class="n">subject</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="nf">predicate</span><span class="p">(</span><span class="n">subject</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ComposedFactory</span><span class="p">&lt;</span><span class="n">TSubject</span><span class="p">,</span> <span class="n">TContext</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IFactory</span><span class="p">&lt;</span><span class="n">TSubject</span><span class="p">,</span> <span class="n">TContext</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">IContextualFactory</span><span class="p">&lt;</span><span class="n">TSubject</span><span class="p">,</span> <span class="n">TContext</span><span class="p">&gt;&gt;</span> <span class="n">factories</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="nf">ComposedFactory</span><span class="p">(</span><span class="k">params</span> <span class="n">IContextualFactory</span><span class="p">&lt;</span><span class="n">TSubject</span><span class="p">,</span> <span class="n">TContext</span><span class="p">&gt;[]</span> <span class="n">factories</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="n">factories</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&gt;&lt;</span><span class="n">TSubject</span><span class="p">,</span> <span class="n">TContext</span><span class="p">&gt;();</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="n">factories</span><span class="p">.</span><span class="n">AddRange</span><span class="p">(</span><span class="n">factories</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="cp">#region IFactory Members </span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="n">TSubject</span> <span class="nf">Create</span><span class="p">(</span><span class="n">TContext</span> <span class="n">context</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">factories</span><span class="p">.</span><span class="n">First</span><span class="p">(</span><span class="n">factory</span> <span class="p">=&gt;</span> <span class="n">factory</span><span class="p">.</span><span class="n">CanHandle</span><span class="p">(</span><span class="n">context</span><span class="p">)).</span><span class="n">Create</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="cp">#endregion </span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>There is a composed factory consisting of special factories for each role. The composed factory chooses the inner factory based on its ability to handle the
context and delegates the creation to it.</p>

<figure class='code'><figcaption><span>Composing the factory</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">var</span> <span class="n">composedFactory</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ComposedFactory</span><span class="p">&lt;</span><span class="n">Form</span><span class="p">,</span> <span class="n">IPrincipal</span><span class="p">&gt;(</span>
</span><span class='line'>  <span class="k">new</span> <span class="n">ContextualFactory</span><span class="p">&lt;</span><span class="n">Form</span><span class="p">,</span> <span class="n">IPrincipal</span><span class="p">&gt;(</span>
</span><span class='line'>      <span class="n">context</span> <span class="p">=&gt;</span> <span class="n">context</span><span class="p">.</span><span class="n">IsInRole</span><span class="p">(</span><span class="n">ApplicationRoles</span><span class="p">.</span><span class="n">Admin</span><span class="p">),</span>
</span><span class='line'>      <span class="n">create</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">WorkItemExplorerView</span><span class="p">(</span><span class="k">new</span> <span class="n">AdminWorkItemExplorerPresenter</span><span class="p">(</span><span class="k">new</span> <span class="n">WorkItemRepository</span><span class="p">()))),</span>
</span><span class='line'>  <span class="k">new</span> <span class="n">ContextualFactory</span><span class="p">&lt;</span><span class="n">Form</span><span class="p">,</span> <span class="n">IPrincipal</span><span class="p">&gt;(</span>
</span><span class='line'>      <span class="n">context</span> <span class="p">=&gt;</span> <span class="n">context</span><span class="p">.</span><span class="n">IsInRole</span><span class="p">(</span><span class="n">ApplicationRoles</span><span class="p">.</span><span class="n">Developer</span><span class="p">),</span>
</span><span class='line'>      <span class="n">create</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">WorkItemExplorerView</span><span class="p">(</span><span class="k">new</span> <span class="n">DeveloperWorkItemExplorerPresenter</span><span class="p">(</span><span class="k">new</span> <span class="n">WorkItemRepository</span><span class="p">())))</span> <span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>This one was fun to write and I think it&#8217;s a good step forward in comparison to the previous examples.
However I must admit that I&#8217;m not overwhelmed by the end result. One the one hand we can change a lot of the stuff easily without affecting other
code. The classes are small and are focused on their responsibilities.  We&#8217;ve managed to extract some code that is potentially reusable. On the
flipside it looks quite a bit over engineered, especially for this tiny little example. There is a lot of stuff we need to pull together in
order to make the solution work (although you could of course hide a lot of the details of the composition by wrapping it up in an internal
DSL.).</p>

<h2>Type 4: Contextual composition + IoC</h2>

<p>Doesn&#8217;t this look like a good situation to introduce an inversion of control container? Probably, but there&#8217;s a tiny little problem. Most of the .NET IoC-Frameworks
unfortunately don&#8217;t support dynamic contextual binding. This type of binding uses a context (for instance a parameter or something like the
current principle used in the current example) and determines how to resolve the target on-the-fly based on the context. This is more or less
the behaviour that I tried to implement manually in the previous example. To our luck there is one framework that implements such a
behaviour. This is Nate Koharis NInject. The reworked initialization of the code looks like this.</p>

<figure class='code'><figcaption><span>Configuring contextual composition with NInject</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">WorkItemExplorerModule</span> <span class="p">:</span> <span class="n">NinjectModule</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Load</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">Bind</span><span class="p">&lt;</span><span class="n">IPresenter</span><span class="p">&lt;</span><span class="n">IWorkItemExplorerView</span><span class="p">&gt;&gt;()</span>
</span><span class='line'>          <span class="p">.</span><span class="n">To</span><span class="p">&lt;</span><span class="n">AdminWorkItemExplorerPresenter</span><span class="p">&gt;()</span>
</span><span class='line'>          <span class="p">.</span><span class="n">When</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentPrincipal</span><span class="p">.</span><span class="n">IsInRole</span><span class="p">(</span><span class="n">ApplicationRoles</span><span class="p">.</span><span class="n">Admin</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">Bind</span><span class="p">&lt;</span><span class="n">IPresenter</span><span class="p">&lt;</span><span class="n">IWorkItemExplorerView</span><span class="p">&gt;&gt;()</span>
</span><span class='line'>          <span class="p">.</span><span class="n">To</span><span class="p">&lt;</span><span class="n">DeveloperWorkItemExplorerPresenter</span><span class="p">&gt;()</span>
</span><span class='line'>          <span class="p">.</span><span class="n">When</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentPrincipal</span><span class="p">.</span><span class="n">IsInRole</span><span class="p">(</span><span class="n">ApplicationRoles</span><span class="p">.</span><span class="n">Developer</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">Bind</span><span class="p">&lt;</span><span class="n">IWorkItemRepository</span><span class="p">&gt;().</span><span class="n">To</span><span class="p">&lt;</span><span class="n">WorkItemRepository</span><span class="p">&gt;();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>and it could be used like this</p>

<figure class='code'><figcaption><span>Configuring an running an app with NInject</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">var</span> <span class="n">kernel</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StandardKernel</span><span class="p">(</span><span class="k">new</span> <span class="n">WorkItemExplorerModule</span><span class="p">());</span>
</span><span class='line'><span class="n">Application</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span><span class="n">kernel</span><span class="p">.</span><span class="n">Get</span><span class="p">&lt;</span><span class="n">WorkItemExplorerView</span><span class="p">&gt;());</span>
</span></code></pre></td></tr></table></div></figure>


<p>Do you see any unnecessary mechanics here?</p>

<h2>Bottomline </h2>

<p>With a little help of our little ninja friend we&#8217;ve managed to build a loosely coupled
system which is a) easy to change and b) easy to extend. NInject hides a lot of the needed mechanics behind the scenes and lets us focus on the
essence of the actual composition. While NInject certainly helps a lot, everything is still doable without such a container. That beeing said:
Favor composition over inheritance. Combine stuff in order to deal with variation. Leave nasty procedual and primarily inheritance bases
solutions behind. It will make your life a lot easier, at least it worked for me &#8230;</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">BjRo</span></span>

      





  



<time datetime="2009-03-19T23:00:22+01:00" pubdate  data-updated="true" >Mar 19<span>th</span>, 2009</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/dotnet/'>dotnet</a>, <a class='category' href='/blog/categories/sw-design/'>sw-design</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.bjoernrochel.de/2009/03/19/contextual-composition/" data-via="bjoernrochel" data-counturl="http://www.bjoernrochel.de/2009/03/19/contextual-composition/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
</div>

    
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
	<h1>About me</h1>
  <p><br/><img src="/images/bjro-eyes.jpg" alt="portrait" /></p>
	<p>
  My name is <strong>BjÃ¶rn Rochel</strong>.  I'm a 32 year old geek, who's crazy about software development, living in Cologne and
  currently working for <a href="http://www.intercomponentware.com">ICW</a> as a .NET Developer / Architect.
	</p>
	<ul class="badges">
		<li><a href="http://www.xing.com/profile/Bjoern_Rochel"><img src="/images/badges/xing2-small.png" alt="Xing" /></a></li>
		<li><a href="http://www.github.com/BjRo"><img src="/images/badges/github-small.png" alt="Github" /></a></li>
		<li><a href="http://www.twitter.com/bjoernrochel"><img src="/images/badges/twitter-square-small.png" alt="Twitter" /></a></li>
		<li><a href="/atom.xml"><img src="/images/badges/rss-circle-small.png" alt="Rss" /></a></li>
	</ul>
</section>

<section>
  <h1>Categories</h1>
  <ul id="categories">
    <li class='category'><a href='/blog/categories/Conferences/'>Conferences (8)</a></li>
<li class='category'><a href='/blog/categories/FSharp/'>FSharp (3)</a></li>
<li class='category'><a href='/blog/categories/Katas/'>Katas (2)</a></li>
<li class='category'><a href='/blog/categories/StoryTeller/'>StoryTeller (14)</a></li>
<li class='category'><a href='/blog/categories/StructureMap/'>StructureMap (9)</a></li>
<li class='category'><a href='/blog/categories/Testing/'>Testing (20)</a></li>
<li class='category'><a href='/blog/categories/Uncategorized/'>Uncategorized (7)</a></li>
<li class='category'><a href='/blog/categories/dotnet/'>dotnet (65)</a></li>
<li class='category'><a href='/blog/categories/ruby/'>ruby (3)</a></li>
<li class='category'><a href='/blog/categories/sw-design/'>sw-design (13)</a></li>
<li class='category'><a href='/blog/categories/xUnitBDDExtensions/'>xUnitBDDExtensions (15)</a></li>

  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("bjoernrochel", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/bjoernrochel" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @bjoernrochel</a>
  
</section>

<section>
<h1>Disclaimer</h1>
<p>
The opinions expressed herein are my own personal opinions and do not necessarily represent the opinion of any other organization or person, including (but not limited to) my fellow employees, my employer, its clients or their agents. 
</p>
<p>
 Copyright &copy; 2011 - BjÃ¶rn Rochel
</p>
<section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2011 - BjÃ¶rn Rochel -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'bjro';
      
        

				//TODO: comment disqus_developer out
				var disqus_developer = 1;
				var disqus_identifier = 'http://www.bjoernrochel.de/2009/03/19/contextual-composition/';
				var disqus_url = 'http://www.bjoernrochel.de/2009/03/19/contextual-composition/';
        var disqus_script = 'embed.js';
      

    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>







</body>
</html>
