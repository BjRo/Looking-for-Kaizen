
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Cutting the fluff from Service registration (or how to do funky stuff with CoC, Castle.DynamicProxy & StructureMap) - Dude, where's my Kaizen?</title>
  <meta name="author" content="Björn Rochel">

  
  <meta name="description" content="The more I play around with Convention over Configuration in combinationwith StructureMap the more I&#8217;m amazed about what you can do with it &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.bjoernrochel.de/2009/07/24/cutting-the-fluff-from-service-registration-or-how-to-do-funky-stuff-with-coc-castledynamicproxy-structuremap/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Dude, where's my Kaizen?" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

</head>

<body   >
  <header role="banner"><div id="logo">
</div>
<hgroup>
  <h1><a href="/">Dude, where's my Kaizen?</a></h1>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.bjoernrochel.de" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Cutting the Fluff From Service Registration (or How to Do Funky Stuff With CoC, Castle.DynamicProxy & StructureMap)</h1>
    
    
      <p class="meta">
        





  



<time datetime="2009-07-24T18:46:07+02:00" pubdate  data-updated="true" >Jul 24<span>th</span>, 2009</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>The more I play around with Convention over Configuration in combination
with StructureMap the more I&#8217;m amazed about what you can do with it and
how much it reduces the amount of code you need in order to configure
and wire stuff together. Today I implemented this convention for our
current prototype:</p>

<blockquote><p>Every class whose class name ends with &#8216;Service&#8217; and who implements a
service interface ( &#8216;I&#8217; + ServiceName) is automatically registered as
a Singleton and proxied</p></blockquote>

<p>The reasoning behind this convention is that I&#8217;d like to remove a lot of
the common, redundant instrumentation code from Services in our
application. This includes for instance a lot of the logging, caching or
maybe argument validation aspects. It&#8217;s currently implemented using
Castle.DynamicProxy2 although the actual service call interceptors
haven&#8217;t been implemented so far. So let&#8217;s walk through the code and see
what is necessary in order to realize this.</p>

<p>First of all you need to implement the <code>ITypeScanner</code> interface. Its basic
purpose is to inspect every type which has been picked up in the
scanning process of StructureMap and do container registration with it
in case the type meets the expected criteria. The interface looks like
this.</p>

<figure class='code'><figcaption><span>StuctureMaps TypeScanner</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">ITypeScanner</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">void</span> <span class="nf">Process</span><span class="p">(</span><span class="n">Type</span> <span class="n">type</span><span class="p">,</span> <span class="n">PluginGraph</span> <span class="n">graph</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>StructureMap contains a handy base class which contains a lot of helper
methods for implementing a convention, the <code>TypeRules</code> class. The basic
code for my convention looks like this:</p>

<figure class='code'><figcaption><span>My convention </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ServicesAreSingletonsAndProxies</span> <span class="p">:</span> <span class="n">TypeRules</span><span class="p">,</span> <span class="n">ITypeScanner</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="cp">#region ITypeScanner Members </span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">Process</span><span class="p">(</span><span class="n">Type</span> <span class="n">type</span><span class="p">,</span> <span class="n">PluginGraph</span> <span class="n">graph</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(!</span><span class="n">IsConcrete</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">||</span> <span class="p">!</span><span class="n">IsService</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">||</span> <span class="p">!</span><span class="n">Constructor</span><span class="p">.</span><span class="n">HasConstructors</span><span class="p">(</span><span class="n">type</span><span class="p">))</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">var</span> <span class="n">pluginType</span> <span class="p">=</span> <span class="n">FindPluginType</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">pluginType</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">var</span> <span class="n">family</span> <span class="p">=</span> <span class="n">GetFamiliy</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">pluginType</span><span class="p">);</span>
</span><span class='line'>    <span class="n">var</span> <span class="n">instance</span> <span class="p">=</span> <span class="n">CreateInstance</span><span class="p">(</span><span class="n">pluginType</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">family</span><span class="p">.</span><span class="n">AddInstance</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
</span><span class='line'>    <span class="n">family</span><span class="p">.</span><span class="n">SetScopeTo</span><span class="p">(</span><span class="n">InstanceScope</span><span class="p">.</span><span class="n">Singleton</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="cp">#endregion </span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>When my convention inspects a type, it first checks whether the type is
concrete, the type name ends with <code>Service</code> and whether the type has a
public constructor. If any of this criteria is not satisfied the type is
ignored. Then it tries to find the primary interface for the concrete
type. In case an interface has been found a bit StructureMap magic is
applied which configures the DynamicProxy integration and the plugin
family to be scoped as Singletons.</p>

<p>In order to integrate DynamicProxy the registration has to be done a bit
differently compared to how I&#8217;ve described it in previous posts. Instead
of using <code>PluginGraph.AddType()</code> I&#8217;m using
<code>PluginGraph.AddInstance(IInstance)</code>. This gives you some more options for
configuration, including adding <code>InstanceInterceptors</code> which are called
when an instance is resolved via StructureMap. That&#8217;s the extension
point I&#8217;ve used. The configuration looks like this &#8230;</p>

<figure class='code'><figcaption><span>Configuring an interceptor</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="n">Instance</span> <span class="nf">CreateInstance</span><span class="p">(</span><span class="n">Type</span> <span class="n">pluginType</span><span class="p">,</span> <span class="n">Type</span> <span class="n">concreteType</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nf">ConfiguredInstance</span><span class="p">(</span><span class="n">concreteType</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">Interceptor</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DynamicProxyInterceptor</span><span class="p">(</span><span class="n">pluginType</span><span class="p">)</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>&#8230; and the code for the interceptor looks like this &#8230;</p>

<figure class='code'><figcaption><span>An Castle.DynamicProxy interceptor</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">DynamicProxyInterceptor</span> <span class="p">:</span> <span class="n">InstanceInterceptor</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">ProxyGenerator</span> <span class="n">ProxyGenerator</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ProxyGenerator</span><span class="p">();</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">Type</span> <span class="n">_pluginType</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="nf">DynamicProxyInterceptor</span><span class="p">(</span><span class="n">Type</span> <span class="n">pluginType</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">_pluginType</span> <span class="p">=</span> <span class="n">pluginType</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="cp">#region InstanceInterceptor Members </span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="kt">object</span> <span class="nf">Process</span><span class="p">(</span><span class="kt">object</span> <span class="n">target</span><span class="p">,</span> <span class="n">IContext</span> <span class="n">context</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">ProxyGenerator</span><span class="p">.</span><span class="n">CreateInterfaceProxyWithTargetInterface</span><span class="p">(</span>
</span><span class='line'>              <span class="n">_pluginType</span><span class="p">,</span>
</span><span class='line'>              <span class="n">target</span><span class="p">,</span>
</span><span class='line'>              <span class="k">new</span> <span class="nf">LoggingInterceptor</span><span class="p">());</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="cp">#endregion </span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&#8217;m using proxy creation over interfaces here. I prefer this over the
proxy over classes approach, because it doesn&#8217;t force implementation
constraints like having to make every public method virtual or the need
to inherit from <code>MarshalByRef</code> onto the service classes.</p>

<p>That&#8217;s basically it. The best of it: The whole rule can be easily tested
in a unit test. The following code uses xUnit.BDDExtensions for this.</p>

<figure class='code'><figcaption><span>Testing the convention with xUnit.BDDExtensions</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="na">[Concern(typeof (ServicesAreSingletonsAndProxies))]</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">When_applying_the__ServicesAreSingletonsAndProxies__convention</span> <span class="p">:</span> <span class="n">StaticContextSpecification</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="n">Container</span> <span class="n">_container</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Because</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">_container</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Container</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Scan</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="n">s</span><span class="p">.</span><span class="n">AssemblyContainingType</span><span class="p">&lt;</span><span class="n">IGuitarPlayerService</span><span class="p">&gt;();</span>
</span><span class='line'>      <span class="n">s</span><span class="p">.</span><span class="n">With</span><span class="p">&lt;</span><span class="n">ServicesAreSingletonsAndProxies</span><span class="p">&gt;();</span>
</span><span class='line'>    <span class="p">}));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="na">  </span>
</span><span class='line'><span class="na">  [Observation]</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">Should_register_all_classes_ending_with__Service__which_also_have_a_contract_interface</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">_container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IGuitarPlayerService</span><span class="p">&gt;().</span><span class="n">ShouldNotBeNull</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="na">  </span>
</span><span class='line'><span class="na">  [Observation]</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">Should_register_services_as_singletons_by_default</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">_container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IGuitarPlayerService</span><span class="p">&gt;().</span><span class="n">ShouldBeEqualTo</span><span class="p">(</span><span class="n">_container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">());</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">  [Observation]</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">Should_wrapp_a_service_in_a_dynamic_proxy_in_order_to_perform_AOPish_stuff</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="n">var</span> <span class="n">instance</span> <span class="p">=</span> <span class="n">_container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IGuitarPlayerService</span><span class="p">&gt;();</span>
</span><span class='line'>    <span class="n">instance</span><span class="p">.</span><span class="n">GetType</span><span class="p">().</span><span class="n">ShouldNotBeEqualTo</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">GuitarPlayerService</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#region Test helpers </span>
</span><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IGuitarPlayerService</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">GuitarPlayerService</span> <span class="p">:</span> <span class="n">IGuitarPlayerService</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'><span class="cp">#endregion </span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is the full code for this convention. Feel free to play with it / use it. That&#8217;s all for today.</p>

<p>Read you soon &#8230;</p>

<figure class='code'><figcaption><span>The full convention</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ServicesAreSingletonsAndProxies</span> <span class="p">:</span> <span class="n">TypeRules</span><span class="p">,</span> <span class="n">ITypeScanner</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="cp">#region ITypeScanner Members</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Process</span><span class="p">(</span><span class="n">Type</span> <span class="n">type</span><span class="p">,</span> <span class="n">PluginGraph</span> <span class="n">graph</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(!</span><span class="n">IsConcrete</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">||</span> <span class="p">!</span><span class="n">IsService</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">||</span> <span class="p">!</span><span class="n">Constructor</span><span class="p">.</span><span class="n">HasConstructors</span><span class="p">(</span><span class="n">type</span><span class="p">))</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">var</span> <span class="n">pluginType</span> <span class="p">=</span> <span class="n">FindPluginType</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">pluginType</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">var</span> <span class="n">family</span> <span class="p">=</span> <span class="n">GetFamiliy</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">pluginType</span><span class="p">);</span>
</span><span class='line'>        <span class="n">var</span> <span class="n">instance</span> <span class="p">=</span> <span class="n">CreateInstance</span><span class="p">(</span><span class="n">pluginType</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">family</span><span class="p">.</span><span class="n">AddInstance</span><span class="p">(</span><span class="n">instance</span><span class="p">);</span>
</span><span class='line'>        <span class="n">family</span><span class="p">.</span><span class="n">SetScopeTo</span><span class="p">(</span><span class="n">InstanceScope</span><span class="p">.</span><span class="n">Singleton</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#endregion</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">static</span> <span class="n">Instance</span> <span class="nf">CreateInstance</span><span class="p">(</span><span class="n">Type</span> <span class="n">pluginType</span><span class="p">,</span> <span class="n">Type</span> <span class="n">concreteType</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">ConfiguredInstance</span><span class="p">(</span><span class="n">concreteType</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">Interceptor</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DynamicProxyInterceptor</span><span class="p">(</span><span class="n">pluginType</span><span class="p">)</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">static</span> <span class="n">PluginFamily</span> <span class="nf">GetFamiliy</span><span class="p">(</span><span class="n">PluginGraph</span> <span class="n">graph</span><span class="p">,</span> <span class="n">Type</span> <span class="n">pluginType</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(!</span><span class="n">graph</span><span class="p">.</span><span class="n">ContainsFamily</span><span class="p">(</span><span class="n">pluginType</span><span class="p">))</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">graph</span><span class="p">.</span><span class="n">CreateFamily</span><span class="p">(</span><span class="n">pluginType</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">graph</span><span class="p">.</span><span class="n">FindFamily</span><span class="p">(</span><span class="n">pluginType</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">IsService</span><span class="p">(</span><span class="n">Type</span> <span class="n">type</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">type</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="n">EndsWith</span><span class="p">(</span><span class="s">&quot;Service&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">static</span> <span class="n">Type</span> <span class="nf">FindPluginType</span><span class="p">(</span><span class="n">Type</span> <span class="n">concreteType</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">var</span> <span class="n">interfaceName</span> <span class="p">=</span> <span class="s">&quot;I&quot;</span> <span class="p">+</span> <span class="n">concreteType</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">concreteType</span>
</span><span class='line'>            <span class="p">.</span><span class="n">GetInterfaces</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="kt">string</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">interfaceName</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">Ordinal</span><span class="p">))</span>
</span><span class='line'>            <span class="p">.</span><span class="n">FirstOrDefault</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">DynamicProxyInterceptor</span> <span class="p">:</span> <span class="n">InstanceInterceptor</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">ProxyGenerator</span> <span class="n">ProxyGenerator</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ProxyGenerator</span><span class="p">();</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Type</span> <span class="n">_pluginType</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">DynamicProxyInterceptor</span><span class="p">(</span><span class="n">Type</span> <span class="n">pluginType</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">_pluginType</span> <span class="p">=</span> <span class="n">pluginType</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#region InstanceInterceptor Members</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="kt">object</span> <span class="nf">Process</span><span class="p">(</span><span class="kt">object</span> <span class="n">target</span><span class="p">,</span> <span class="n">IContext</span> <span class="n">context</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">ProxyGenerator</span><span class="p">.</span><span class="n">CreateInterfaceProxyWithTargetInterface</span><span class="p">(</span>
</span><span class='line'>            <span class="n">_pluginType</span><span class="p">,</span>
</span><span class='line'>            <span class="n">target</span><span class="p">,</span>
</span><span class='line'>            <span class="k">new</span> <span class="nf">LoggingInterceptor</span><span class="p">());</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#endregion</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">[Concern(typeof (ServicesAreSingletonsAndProxies))]</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">When_applying_the__ServicesAreSingletonsAndProxies__convention_for_a_particular_interface</span> <span class="p">:</span> <span class="n">StaticContextSpecification</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="n">Container</span> <span class="n">_container</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Because</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">_container</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Container</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Scan</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">s</span><span class="p">.</span><span class="n">AssemblyContainingType</span><span class="p">&lt;</span><span class="n">IGuitarPlayerService</span><span class="p">&gt;();</span>
</span><span class='line'>            <span class="n">s</span><span class="p">.</span><span class="n">With</span><span class="p">&lt;</span><span class="n">ServicesAreSingletonsAndProxies</span><span class="p">&gt;();</span>
</span><span class='line'>        <span class="p">}));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">    [Observation]</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Should_register_all_classes_ending_with__Service__which_also_have_a_contract_interface</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">_container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IGuitarPlayerService</span><span class="p">&gt;().</span><span class="n">ShouldNotBeNull</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">    [Observation]</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Should_register_services_as_singletons_by_default</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">_container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IGuitarPlayerService</span><span class="p">&gt;().</span><span class="n">ShouldBeEqualTo</span><span class="p">(</span><span class="n">_container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IGuitarPlayerService</span><span class="p">&gt;());</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">    [Observation]</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Should_wrapp_a_service_in_a_dynamic_proxy_in_order_to_perform_AOPish_stuff</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">var</span> <span class="n">instance</span> <span class="p">=</span> <span class="n">_container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">IGuitarPlayerService</span><span class="p">&gt;();</span>
</span><span class='line'>        <span class="n">instance</span><span class="p">.</span><span class="n">GetType</span><span class="p">().</span><span class="n">ShouldNotBeEqualTo</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">GuitarPlayerService</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#region Test helpers</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IGuitarPlayerService</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">GuitarPlayerService</span> <span class="p">:</span> <span class="n">IGuitarPlayerService</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#endregion</span>
</span></code></pre></td></tr></table></div></figure>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">BjRo</span></span>

      





  



<time datetime="2009-07-24T18:46:07+02:00" pubdate  data-updated="true" >Jul 24<span>th</span>, 2009</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/structuremap/'>StructureMap</a>, <a class='category' href='/blog/categories/dotnet/'>dotnet</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.bjoernrochel.de/2009/07/24/cutting-the-fluff-from-service-registration-or-how-to-do-funky-stuff-with-coc-castledynamicproxy-structuremap/" data-via="bjoernrochel" data-counturl="http://www.bjoernrochel.de/2009/07/24/cutting-the-fluff-from-service-registration-or-how-to-do-funky-stuff-with-coc-castledynamicproxy-structuremap/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
</div>

    
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
	<h1>About me</h1>
  <p><br/><img src="/images/bjro-eyes.jpg" alt="portrait" /></p>
	<p>
  My name is <strong>Björn Rochel</strong>.  I'm a 32 year old geek, who's crazy about software development, living in Cologne and
  currently working for <a href="http://www.intercomponentware.com">ICW</a> as a Developer / Architect.
	</p>
	<ul id="badges">
    <li><a id="xing" href="http://www.xing.com/profile/Bjoern_Rochel"><span>XING</span></a></li>
    <li><a id="github" href="http://www.github.com/BjRo"><span>Github</span></a></li>
    <li><a id="twitter" href="http://www.twitter.com/bjoernrochel"><span>Twitter</span></a></li>
    <li><a id="rss" href="/atom.xml"><span>Rss</span></a></li>
	</ul>
</section>

<section>
  <h1>Categories</h1>
  <ul id='categories'>
<li><a href='blog/categories/Conferences/'>Conferences (8)</a></li>
<li><a href='blog/categories/FSharp/'>FSharp (3)</a></li>
<li><a href='blog/categories/Katas/'>Katas (2)</a></li>
<li><a href='blog/categories/StoryTeller/'>StoryTeller (14)</a></li>
<li><a href='blog/categories/StructureMap/'>StructureMap (9)</a></li>
<li><a href='blog/categories/Testing/'>Testing (20)</a></li>
<li><a href='blog/categories/Uncategorized/'>Uncategorized (8)</a></li>
<li><a href='blog/categories/dotnet/'>dotnet (65)</a></li>
<li><a href='blog/categories/ruby/'>ruby (3)</a></li>
<li><a href='blog/categories/sw-design/'>sw-design (13)</a></li>
<li><a href='blog/categories/xUnitBDDExtensions/'>xUnitBDDExtensions (15)</a></li>
</ul>

</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("bjoernrochel", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/bjoernrochel" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @bjoernrochel</a>
  
</section>

<section>
<h1>Disclaimer</h1>
<p>
The opinions expressed herein are my own personal opinions and do not necessarily represent the opinion of any other organization or person, including (but not limited to) my fellow employees, my employer, its clients or their agents. 
</p>
<p>
 Copyright &copy; 2011 - Björn Rochel
</p>
<section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2011 - Björn Rochel -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'bjro';
      
        

				//var disqus_developer = 1;
				var disqus_identifier = 'http://www.bjoernrochel.de/2009/07/24/cutting-the-fluff-from-service-registration-or-how-to-do-funky-stuff-with-coc-castledynamicproxy-structuremap/';
				var disqus_url = 'http://www.bjoernrochel.de/2009/07/24/cutting-the-fluff-from-service-registration-or-how-to-do-funky-stuff-with-coc-castledynamicproxy-structuremap/';
        var disqus_script = 'embed.js';
      

    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>







</body>
</html>
