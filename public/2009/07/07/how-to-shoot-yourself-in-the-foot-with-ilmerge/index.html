
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>How to shoot yourself in the foot with ILMerge - Dude, where's my Kaizen?</title>
  <meta name="author" content="Björn Rochel">

  
  <meta name="description" content="xUnit.BDDExtensions and is now completely merged into a single assembly.However, getting to that state wasn&#8217;t as straight forward as &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.bjoernrochel.de/2009/07/07/how-to-shoot-yourself-in-the-foot-with-ilmerge/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Dude, where's my Kaizen?" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

</head>

<body   >
  <header role="banner"><div id="logo">
</div>
<hgroup>
  <h1><a href="/">Dude, where's my Kaizen?</a></h1>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.bjoernrochel.de" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">How to Shoot Yourself in the Foot With ILMerge</h1>
    
    
      <p class="meta">
        





  



<time datetime="2009-07-07T18:48:04+02:00" pubdate  data-updated="true" >Jul 7<span>th</span>, 2009</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>xUnit.BDDExtensions and is now completely merged into a single assembly.
However, getting to that state wasn&#8217;t as straight forward as I
originally expected.</p>

<h2>The initial problem</h2>

<p>xUnit.BDDExtensions internally depends on StructureMap,
StructureMap.AutoMocking and Rhino.Mocks. However, I don&#8217;t like the need
to carry around 3 extra assemblies with me, especially if I don&#8217;t use
them directly in the xUnit.BDDExtensions API. So I decided to give
<a href="http://research.microsoft.com/en-us/people/mbarnett/ilmerge.aspx">ILMerge</a>
a try and started with this: \</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ILMerge.exe /t:library /out:<span class="s1">&#39;Deploy/xUnit.BDDExtensions.dll&#39;</span>
</span><span class='line'>  <span class="s1">&#39;xUnit.BDDExtensions.dll&#39;</span>
</span><span class='line'>  <span class="s1">&#39;StructureMap.dll&#39;</span>
</span><span class='line'>  <span class="s1">&#39;StructureMap.AutoMocking.dll&#39;</span>
</span><span class='line'>  <span class="s1">&#39;Rhino.Mocks.dll&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Initial merging went fine, but when I tried to actually use the merged
assembly in a solution also containing a StructureMap binary, I received
a lot of build errors indicating duplicate types. The solution simply
didn&#8217;t compile any more. Crap !</p>

<h2>What went wrong</h2>

<p>The way I merged the assemblies, all public types of the dependent
assemblies stayed public (although they&#8217;re only internally used). The
merged assembly exposed all public APIs of the merged-in assemblies.
When using the assembly in conjunction with one of the original
assemblies (for instance StructureMap) the compiler basically didn&#8217;t
know which type my code was actually referring to. Hence the error.</p>

<p>Besides the observed effect those APIs can clearly be confusing to a
developer with no knowledge that the assembly at hand is actually a
merged one. So imho definitely a situation which needed to be fixed.</p>

<h2>How to fix it</h2>

<p>What needed to be done is to internalize the all public types of the
merged-in assemblies. The related switch for this in ILMerge is <code>/internalize</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ILMerge.exe /t:library /internalize
</span><span class='line'>      /out:<span class="s1">&#39;Deploy/xUnit.BDDExtensions.dll&#39;</span>
</span><span class='line'>      <span class="s1">&#39;xUnit.BDDExtensions.dll&#39;</span>
</span><span class='line'>      <span class="s1">&#39;StructureMap.dll&#39;</span>
</span><span class='line'>      <span class="s1">&#39;StructureMap.AutoMocking.dll&#39;</span>
</span><span class='line'>      <span class="s1">&#39;Rhino.Mocks.dll&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>`
The solution using both xUnit.BDDExtensions and StructureMap now
compiled without errors. Duplicate type issue solved. Everything fine
now? Nope, obviously internalization created some other problems: Specs
driven by xUnit.BDDExtensions showed that neither the auto-mocking
feature nor the mock support worked anymore. Nearly every test failed
due to an internal exception.</p>

<h2>How to fix it (Take 2) </h2>

<p>The problem with the internalization of all public types is that
sometimes the merged APIs somehow depend on several types being public.
If you take that away, you effectively break their functionality. In my
case my problems where created by Castle.DynamicProxy2 (which is used by
Rhino.Mocks internally) and StructureMap. Both tools are doing dynamic
type generation internally and the generated types wanted to implement
some interfaces which were formally public but now weren&#8217;t accessible
any more. To my luck ILMerge provides a workaround for situations like
that: You can exclude types from being internalized. Here&#8217;s what I did
in order to make it work:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ILMerge.exe /t:library
</span><span class='line'>  /internalize:<span class="s1">&#39;Build/ILMergeIncludes.txt&#39;</span>
</span><span class='line'>  /out:<span class="s1">&#39;Deploy/xUnit.BDDExtensions.dll&#39;</span>
</span><span class='line'>  <span class="s1">&#39;xUnit.BDDExtensions.dll&#39;</span>
</span><span class='line'>  <span class="s1">&#39;StructureMap.dll&#39;</span>
</span><span class='line'>  <span class="s1">&#39;StructureMap.AutoMocking.dll&#39;</span>
</span><span class='line'>  <span class="s1">&#39;Rhino.Mocks.dll&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice the modified <code>/internalize</code> switch. A file now specifies the
types to exclude from the internalization. ILMerge expects the file to
contain a regular expression per line. Every line is evaluated against
each type name and automatically excluded from the internalization
process in case the regular expression matches. My exclude file looks
like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">StructureMap</span><span class="p">.</span><span class="n">InstanceBuilder</span>
</span><span class='line'><span class="n">StructureMap</span><span class="p">.</span><span class="n">Pipeline</span><span class="p">.</span><span class="err">\</span><span class="p">*</span>
</span><span class='line'><span class="n">Rhino</span><span class="p">.</span><span class="n">Mocks</span><span class="p">.</span><span class="n">Interfaces</span><span class="p">.</span><span class="n">IMockedObject</span>
</span><span class='line'><span class="n">Castle</span><span class="p">.</span><span class="n">Core</span><span class="p">.</span><span class="n">Interceptor</span><span class="p">.</span><span class="n">IProxyTargetAccessor</span>
</span><span class='line'><span class="n">Castle</span><span class="p">.</span><span class="n">DynamicProxy</span><span class="p">.</span><span class="n">AbstractInvocation</span>
</span><span class='line'><span class="n">Castle</span><span class="p">.</span><span class="n">DynamicProxy</span><span class="p">.</span><span class="n">Generators</span><span class="p">.</span><span class="n">AttributesToAvoidReplicating</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Lessons learned </h2>

<p>Merging for deployment isn&#8217;t that hard, but you have to be careful
that everything works as expected after you&#8217;ve created the merged
assembly. A successful ILMerge call doesn&#8217;t necessarily mean that
everything&#8217;s fine and works as expected. On the other hand the ILMerge
documentation is very good and provided me with a simple solution to the
problem. I&#8217;ve shot myself in the foot, but it&#8217;s bandaged and I can walk
again, so to say. If you&#8217;re interested in doing something similar (not
the shooting part) I highly suggest that you should give ILMerge a try .
. .</p>

<h2>Sidenotes</h2>

<p>Is it possible that ILMerge fails to merge WPF based assemblies? I&#8217;m
currently experiencing strange effects when trying to merge them. Anyone?</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">BjRo</span></span>

      





  



<time datetime="2009-07-07T18:48:04+02:00" pubdate  data-updated="true" >Jul 7<span>th</span>, 2009</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/testing/'>Testing</a>, <a class='category' href='/blog/categories/dotnet/'>dotnet</a>, <a class='category' href='/blog/categories/xunitbddextensions/'>xUnitBDDExtensions</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.bjoernrochel.de/2009/07/07/how-to-shoot-yourself-in-the-foot-with-ilmerge/" data-via="bjoernrochel" data-counturl="http://www.bjoernrochel.de/2009/07/07/how-to-shoot-yourself-in-the-foot-with-ilmerge/" >Tweet</a>
  
  
</div>

    
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
	<h1>About me</h1>
  <p><br/><img src="/images/bjro-eyes.jpg" alt="portrait" /></p>
	<p>
  My name is <strong>Björn Rochel</strong>.  I'm a 32 year old geek, who's crazy about software development, living in Cologne and
  currently working for <a href="http://www.intercomponentware.com">ICW</a> as a Developer / Architect.
	</p>
	<ul id="badges">
    <li><a id="xing" href="http://www.xing.com/profile/Bjoern_Rochel"><span>XING</span></a></li>
    <li><a id="github" href="http://www.github.com/BjRo"><span>Github</span></a></li>
    <li><a id="twitter" href="http://www.twitter.com/bjoernrochel"><span>Twitter</span></a></li>
    <li><a id="rss" href="/atom.xml"><span>Rss</span></a></li>
	</ul>
</section>

<section>
  <h1>Categories</h1>
  <ul id='categories'>
<li><a href='http://www.bjoernrochel.de/blog/categories/Conferences/'>Conferences (8)</a></li>
<li><a href='http://www.bjoernrochel.de/blog/categories/FSharp/'>FSharp (3)</a></li>
<li><a href='http://www.bjoernrochel.de/blog/categories/Katas/'>Katas (2)</a></li>
<li><a href='http://www.bjoernrochel.de/blog/categories/StoryTeller/'>StoryTeller (14)</a></li>
<li><a href='http://www.bjoernrochel.de/blog/categories/StructureMap/'>StructureMap (9)</a></li>
<li><a href='http://www.bjoernrochel.de/blog/categories/Testing/'>Testing (20)</a></li>
<li><a href='http://www.bjoernrochel.de/blog/categories/Uncategorized/'>Uncategorized (8)</a></li>
<li><a href='http://www.bjoernrochel.de/blog/categories/dotnet/'>dotnet (65)</a></li>
<li><a href='http://www.bjoernrochel.de/blog/categories/ruby/'>ruby (3)</a></li>
<li><a href='http://www.bjoernrochel.de/blog/categories/sw-design/'>sw-design (13)</a></li>
<li><a href='http://www.bjoernrochel.de/blog/categories/xUnitBDDExtensions/'>xUnitBDDExtensions (15)</a></li>
</ul>

</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("bjoernrochel", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/bjoernrochel" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @bjoernrochel</a>
  
</section>

<section>
<h1>Disclaimer</h1>
<p>
The opinions expressed herein are my own personal opinions and do not necessarily represent the opinion of any other organization or person, including (but not limited to) my fellow employees, my employer, its clients or their agents. 
</p>
<p>
 Copyright &copy; 2011 - Björn Rochel
</p>
<section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2011 - Björn Rochel -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'bjro';
      
        

				//var disqus_developer = 1;
				var disqus_identifier = 'http://www.bjoernrochel.de/2009/07/07/how-to-shoot-yourself-in-the-foot-with-ilmerge/';
				var disqus_url = 'http://www.bjoernrochel.de/2009/07/07/how-to-shoot-yourself-in-the-foot-with-ilmerge/';
        var disqus_script = 'embed.js';
      

    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>







</body>
</html>
