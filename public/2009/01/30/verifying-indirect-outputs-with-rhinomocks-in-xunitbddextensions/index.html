
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Verifying indirect outputs with Rhino.Mocks in xUnit.BDDExtensions - Dude, where's my Kaizen?</title>
  <meta name="author" content="Björn Rochel">

  
  <meta name="description" content="This post by Sean Feldman was kind of an eye opener to me. It introduced meto a feature of Rhino.Mocks I wasn&#8217;t really aware of and helped to &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.bjoernrochel.de/2009/01/30/verifying-indirect-outputs-with-rhinomocks-in-xunitbddextensions/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Dude, where's my Kaizen?" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

</head>

<body   >
  <header role="banner"><div id="logo">
	<img src="/images/kaizen.png" alt="Kaizen" title="Kaizen" />
</div>
<hgroup>
  <h1><a href="/">Dude, where's my Kaizen?</a></h1>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.bjoernrochel.de" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Verifying Indirect Outputs With Rhino.Mocks in xUnit.BDDExtensions</h1>
    
    
      <p class="meta">
        





  



<time datetime="2009-01-30T23:51:31+01:00" pubdate  data-updated="true" >Jan 30<span>th</span>, 2009</time>
        
      </p>
    
  </header>


<div class="entry-content"><p><a href="http://weblogs.asp.net/sfeldman/archive/2009/01/29/factory-per-dto.aspx">This</a> post by Sean Feldman was kind of an eye opener to me. It introduced me
to a feature of Rhino.Mocks I wasn&#8217;t really aware of and helped to solve a problem I was never able to solve in a really satisfying way.</p>

<p>As you might know xUnit.BDDExtensions is using Rhino.Mocks behind the scenes, but hides a lot of the mechanics of the library. This was done
in order to eliminate a lot of the ceremony in a specification, so that a writer of a specification could focus on its essence (Quote MASHUP
from JP and Jeremy D. Miller :-) ). However, especially when configuring and verifying behaviors Rhino.Mocks still shines through (with all its power).</p>

<p>So let&#8217;s take a closer look at the problem I&#8217;m referring to. It has to do with specifications which observe indirect outputs. The following
code is part of a little object-to-object-mapper I wrote some months ago.</p>

<figure class='code'><figcaption><span>An class with indirect outputs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ExpressionBasedWriter</span><span class="p">&lt;</span><span class="n">Target</span><span class="p">,</span> <span class="n">PropertyType</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IWriteStrategy</span><span class="p">&lt;</span><span class="n">Target</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">IExpressionHandler</span> <span class="n">expressionHandler</span><span class="p">;</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">MemberExpression</span> <span class="n">memberExpression</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="nf">ExpressionBasedWriter</span><span class="p">(</span><span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&gt;</span> <span class="n">memberSelector</span><span class="p">,</span> <span class="n">IExpressionHandler</span> <span class="n">expressionHandler</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="n">memberExpression</span> <span class="p">=</span> <span class="p">(</span><span class="n">MemberExpression</span><span class="p">)</span> <span class="n">memberSelector</span><span class="p">.</span><span class="n">Body</span><span class="p">;</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="n">expressionHandler</span> <span class="p">=</span> <span class="n">expressionHandler</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">WriteTo</span><span class="p">(</span><span class="n">Target</span> <span class="n">instance</span><span class="p">,</span> <span class="kt">object</span> <span class="k">value</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">expressionHandler</span><span class="p">.</span><span class="n">Handle</span><span class="p">(</span><span class="k">new</span> <span class="n">HandlerContext</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>              <span class="n">TargetInstanceType</span> <span class="p">=</span> <span class="n">instance</span><span class="p">.</span><span class="n">GetType</span><span class="p">(),</span>
</span><span class='line'>              <span class="n">TargetInstance</span> <span class="p">=</span> <span class="n">instance</span><span class="p">,</span>
</span><span class='line'>              <span class="n">ValueToWrite</span> <span class="p">=</span> <span class="k">value</span><span class="p">,</span>
</span><span class='line'>              <span class="n">MemberSelector</span> <span class="p">=</span> <span class="n">memberExpression</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&#8217;s not so important to understand the full context of the code. The important part is in the body of the <code>WriteTo()</code> method. Do you see it? It
constructs an instance and passes it into an internal dependency. The interesting question now is how to verify the indirect output passed to
the dependeny in a spec&#8230;</p>

<h2>Take 1: Overriding Equals and GetHashcode() in the indirect output class</h2>

<p>In case you correctly implemented both of these methods you could write
a spec, that looks like somewhat like this.</p>

<figure class='code'><figcaption><span>Overriding GetHashcode()</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="na">[Concern(typeof(ExpressionBasedWriter&lt;,&gt;))]</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">When_something_is_about_to_be_written</span> <span class="p">:</span> <span class="n">InstanceContextSpecification</span><span class="p">&lt;</span><span class="n">IWriteStrategy</span><span class="p">&lt;</span><span class="n">TestDto1</span><span class="p">&gt;&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="n">IExpressionHandler</span> <span class="n">expressionHandler</span><span class="p">;</span>
</span><span class='line'>  <span class="k">private</span> <span class="n">Expression</span> <span class="n">targetExpression</span><span class="p">;</span>
</span><span class='line'>  <span class="k">private</span> <span class="n">TestDto1</span> <span class="n">target</span><span class="p">;</span>
</span><span class='line'>  <span class="k">private</span> <span class="kt">string</span> <span class="n">valueToWrite</span><span class="p">;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">EstablishContext</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">targetExpression</span> <span class="p">=</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">StringProperty</span><span class="p">;</span>
</span><span class='line'>      <span class="n">expressionHandler</span> <span class="p">=</span> <span class="n">Dependency</span><span class="p">&lt;</span><span class="n">IExpressionHandler</span><span class="p">&gt;();</span>
</span><span class='line'>      <span class="n">target</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TestDto1</span><span class="p">();</span>
</span><span class='line'>      <span class="n">valueToWrite</span> <span class="p">=</span> <span class="s">&quot;uninteresting value&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">protected</span> <span class="k">override</span> <span class="n">IWriteStrategy</span> <span class="nf">CreateSut</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">new</span> <span class="nf">ExpressionBasedWriter</span><span class="p">(</span><span class="n">targetExpression</span><span class="p">,</span> <span class="n">expressionHandler</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Because</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">Sut</span><span class="p">.</span><span class="n">WriteTo</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">valueToWrite</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="na"> </span>
</span><span class='line'><span class="na"> [Observation]</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">should_form_a_context_and_pass_it_to_the_actual_expression_handler</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">expressionHandler</span><span class="p">.</span><span class="n">WasToldTo</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Handle</span><span class="p">(</span><span class="k">new</span> <span class="n">HandlerContext</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">MemberSelector</span> <span class="p">=</span> <span class="p">(</span><span class="n">MemberExpression</span><span class="p">)</span><span class="n">targetExpression</span><span class="p">.</span><span class="n">Body</span><span class="p">,</span>
</span><span class='line'>          <span class="n">TargetInstance</span> <span class="p">=</span> <span class="n">target</span><span class="p">,</span>
</span><span class='line'>          <span class="n">TargetInstanceType</span> <span class="p">=</span> <span class="n">target</span><span class="p">.</span><span class="n">GetType</span><span class="p">(),</span>
</span><span class='line'>          <span class="n">ValueToWrite</span> <span class="p">=</span> <span class="n">valueToWrite</span>
</span><span class='line'>      <span class="p">}));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This works. Ok, but what I don&#8217;t like about this solution is that I expose the concrete HandlerContext class to the spec. Test isolation is
broken here. Besides I have to be very carefully with my implementation of Equals in this case, although it might only be needed in the
specification.</p>

<h2>Take 2: Introduce a factory</h2>

<p>You can prevent the direct exposure of the specification to the concrete HandlerContext by introducing a factory which abstacts the creation of
the HandlerContext class away.</p>

<figure class='code'><figcaption><span>Handling creation via a factory</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ExpressionBasedWriter</span> <span class="p">:</span> <span class="n">IWriteStrategy</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">IExpressionHandler</span> <span class="n">expressionHandler</span><span class="p">;</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">IHandlerContextFactory</span> <span class="n">handleContextFactory</span><span class="p">;</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">readonly</span> <span class="n">MemberExpression</span> <span class="n">memberExpression</span><span class="p">;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="nf">ExpressionBasedWriter</span><span class="p">(</span> <span class="n">Expression</span> <span class="n">memberSelector</span><span class="p">,</span> <span class="n">IExpressionHandler</span> <span class="n">expressionHandler</span><span class="p">,</span> <span class="n">IHandlerContextFactory</span> <span class="n">handleContextFactory</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="n">memberExpression</span> <span class="p">=</span> <span class="p">(</span><span class="n">MemberExpression</span><span class="p">)</span> <span class="n">memberSelector</span><span class="p">.</span><span class="n">Body</span><span class="p">;</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="n">expressionHandler</span> <span class="p">=</span> <span class="n">expressionHandler</span><span class="p">;</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="n">handleContextFactory</span> <span class="p">=</span> <span class="n">handleContextFactory</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">WriteTo</span><span class="p">(</span><span class="n">Target</span> <span class="n">instance</span><span class="p">,</span> <span class="kt">object</span> <span class="k">value</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">var</span> <span class="n">context</span> <span class="p">=</span> <span class="n">handleContextFactory</span><span class="p">.</span><span class="n">CreateContext</span><span class="p">(</span><span class="n">memberExpression</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="k">value</span><span class="p">);</span>
</span><span class='line'>      <span class="n">expressionHandler</span><span class="p">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">[Concern(typeof (ExpressionBasedWriter&lt;,&gt;))]</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">When_something_is_about_to_be_written</span> <span class="p">:</span> <span class="n">InstanceContextSpecification</span><span class="p">&lt;</span><span class="n">IWriteStrategy</span><span class="p">&lt;</span><span class="n">TestDto1</span><span class="p">&gt;&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="n">IExpressionHandler</span> <span class="n">expressionHandler</span><span class="p">;</span>
</span><span class='line'>  <span class="k">private</span> <span class="n">IHandlerContext</span> <span class="n">handlerContext</span><span class="p">;</span>
</span><span class='line'>  <span class="k">private</span> <span class="n">IHandlerContextFactory</span> <span class="n">handlerContextFactory</span><span class="p">;</span>
</span><span class='line'>  <span class="k">private</span> <span class="n">TestDto1</span> <span class="n">target</span><span class="p">;</span>
</span><span class='line'>  <span class="k">private</span> <span class="n">Expression</span> <span class="n">targetExpression</span><span class="p">;</span>
</span><span class='line'>  <span class="k">private</span> <span class="kt">string</span> <span class="n">valueToWrite</span><span class="p">;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">EstablishContext</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">targetExpression</span> <span class="p">=</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">StringProperty</span><span class="p">;</span>
</span><span class='line'>      <span class="n">expressionHandler</span> <span class="p">=</span> <span class="n">Dependency</span><span class="p">&lt;</span><span class="n">IExpressionHandler</span><span class="p">&gt;();</span>
</span><span class='line'>      <span class="n">handlerContextFactory</span> <span class="p">=</span> <span class="n">Dependency</span><span class="p">&lt;</span><span class="n">IHandlerContextFactory</span><span class="p">&gt;();</span>
</span><span class='line'>      <span class="n">handlerContext</span> <span class="p">=</span> <span class="n">Dependency</span><span class="p">&lt;</span><span class="n">IHandlerContext</span><span class="p">&gt;();</span>
</span><span class='line'>      <span class="n">target</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TestDto1</span><span class="p">();</span>
</span><span class='line'>      <span class="n">valueToWrite</span> <span class="p">=</span> <span class="s">&quot;uninteresting value&quot;</span><span class="p">;</span>
</span><span class='line'>      <span class="n">handlerContextFactory</span>
</span><span class='line'>          <span class="p">.</span><span class="n">WhenToldTo</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">CreateContext</span><span class="p">((</span><span class="n">MemberExpression</span><span class="p">)</span><span class="n">targetExpression</span><span class="p">.</span><span class="n">Body</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">valueToWrite</span><span class="p">))</span>
</span><span class='line'>          <span class="p">.</span><span class="n">Return</span><span class="p">(</span><span class="n">handlerContext</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">protected</span> <span class="k">override</span> <span class="n">IWriteStrategy</span> <span class="nf">CreateSut</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">new</span> <span class="nf">ExpressionBasedWriter</span><span class="p">(</span><span class="n">targetExpression</span><span class="p">,</span> <span class="n">expressionHandler</span><span class="p">,</span> <span class="n">handlerContextFactory</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Because</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">Sut</span><span class="p">.</span><span class="n">WriteTo</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">valueToWrite</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="na"> </span>
</span><span class='line'><span class="na"> [Observation]</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">should_call_the_context_handler_factory_in_order_to_create_a_context</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">handlerContextFactory</span><span class="p">.</span><span class="n">WasToldTo</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">CreateContext</span><span class="p">((</span><span class="n">MemberExpression</span><span class="p">)</span><span class="n">targetExpression</span><span class="p">.</span><span class="n">Body</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">valueToWrite</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na"> [Observation]</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">should_call_the_expression_handler_in_order_to_handle_the_created_context</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">expressionHandler</span><span class="p">.</span><span class="n">WasToldTo</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">handlerContext</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Again, this works too. But is that really a path one should go?  Introducing an additional factory + interface everytime one encounters
an indirect output? Besides that, did you notice how the specification kind of degraded? So much additional noise now in there. This one causes
me actually more pain than Take 1, which takes me to &#8230;</p>

<h2>Take 3: A neat Rhino.Mocks feature</h2>

<p>Leave the code from Take 1 as it is. Here&#8217;s how you can write the specification, without exposing it to the concrete HandlerContext class and without causing to much noise in the specification itself.</p>

<figure class='code'><figcaption><span>Using RhinoMocks argument constraints</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="na">[Concern(typeof(ExpressionBasedWriter&lt;,&gt;))]</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">When_something_is_about_to_be_written</span> <span class="p">:</span> <span class="n">InstanceContextSpecification</span><span class="p">&lt;</span><span class="n">IWriteStrategy</span><span class="p">&lt;</span><span class="n">TestDto1</span><span class="p">&gt;&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="n">IExpressionHandler</span> <span class="n">expressionHandler</span><span class="p">;</span>
</span><span class='line'>  <span class="n">Expression</span> <span class="n">targetExpression</span><span class="p">;</span>
</span><span class='line'>  <span class="k">private</span> <span class="n">TestDto1</span> <span class="n">target</span><span class="p">;</span>
</span><span class='line'>  <span class="k">private</span> <span class="kt">string</span> <span class="n">valueToWrite</span><span class="p">;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">EstablishContext</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">targetExpression</span> <span class="p">=</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">StringProperty</span><span class="p">;</span>
</span><span class='line'>      <span class="n">expressionHandler</span> <span class="p">=</span> <span class="n">Dependency</span><span class="p">&lt;</span><span class="n">IExpressionHandler</span><span class="p">&gt;();</span>
</span><span class='line'>      <span class="n">target</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TestDto1</span><span class="p">();</span>
</span><span class='line'>      <span class="n">valueToWrite</span> <span class="p">=</span> <span class="s">&quot;uninteresting value&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">protected</span> <span class="k">override</span> <span class="n">IWriteStrategy</span> <span class="nf">CreateSut</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">new</span> <span class="nf">ExpressionBasedWriter</span><span class="p">(</span><span class="n">targetExpression</span><span class="p">,</span> <span class="n">expressionHandler</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Because</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">Sut</span><span class="p">.</span><span class="n">WriteTo</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">valueToWrite</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="na"> </span>
</span><span class='line'><span class="na"> [Observation]</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">void</span> <span class="nf">should_form_a_context_and_pass_it_to_the_actual_expression_handler</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">expressionHandler</span><span class="p">.</span><span class="n">WasToldTo</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">Arg</span><span class="p">.</span><span class="n">Matches</span><span class="p">(</span><span class="n">matcher</span> <span class="p">=&gt;</span>
</span><span class='line'>          <span class="n">matcher</span><span class="p">.</span><span class="n">MemberSelector</span> <span class="p">==</span> <span class="n">targetExpression</span><span class="p">.</span><span class="n">Body</span> <span class="p">&amp;&amp;</span>
</span><span class='line'>          <span class="n">matcher</span><span class="p">.</span><span class="n">TargetInstance</span> <span class="p">==</span> <span class="n">target</span> <span class="p">&amp;&amp;</span>
</span><span class='line'>          <span class="n">matcher</span><span class="p">.</span><span class="n">TargetInstanceType</span> <span class="p">==</span> <span class="n">target</span><span class="p">.</span><span class="n">GetType</span><span class="p">()</span> <span class="p">&amp;&amp;</span>
</span><span class='line'>          <span class="n">matcher</span><span class="p">.</span><span class="n">ValueToWrite</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">valueToWrite</span><span class="p">))));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The interesting stuff happens around the generic Arg class. You can use it to specify a callback with which the indirect output can be verified.</p>

<h2>Conclusion</h2>

<p>In the past I mostly did what I demonstrated with Take 1 when I encountered a situation where I needed to verify indirect outputs.
Introducing a factory for this was never really an option for me. I don&#8217;t see a real benefit there. The generic argument matching
capabilities of Rhino.Mocks really close a gap for me and they&#8217;re what I&#8217;m going to use for solving similar situations from now on.</p>

<p>I hope I&#8217;m not the only kid on the street who didn&#8217;t know that this feature exists &#8230;</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">BjRo</span></span>

      





  



<time datetime="2009-01-30T23:51:31+01:00" pubdate  data-updated="true" >Jan 30<span>th</span>, 2009</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/testing/'>Testing</a>, <a class='category' href='/blog/categories/dotnet/'>dotnet</a>, <a class='category' href='/blog/categories/xunitbddextensions/'>xUnitBDDExtensions</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.bjoernrochel.de/2009/01/30/verifying-indirect-outputs-with-rhinomocks-in-xunitbddextensions/" data-via="bjoernrochel" data-counturl="http://www.bjoernrochel.de/2009/01/30/verifying-indirect-outputs-with-rhinomocks-in-xunitbddextensions/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
</div>

    
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
	<h1>About me</h1>
  <p><br/><img src="/images/bjro-eyes.jpg" alt="portrait" /></p>
	<p>
  My name is <strong>Björn Rochel</strong>.  I'm a 32 year old geek, who's crazy about software development, living in Cologne and
  currently working for <a href="http://www.intercomponentware.com">ICW</a> as a Developer / Architect.
	</p>
	<ul class="badges">
		<li><a href="http://www.xing.com/profile/Bjoern_Rochel"><img src="/images/badges/xing2-small.png" alt="Xing" /></a></li>
		<li><a href="http://www.github.com/BjRo"><img src="/images/badges/github-small.png" alt="Github" /></a></li>
		<li><a href="http://www.twitter.com/bjoernrochel"><img src="/images/badges/twitter-square-small.png" alt="Twitter" /></a></li>
		<li><a href="/atom.xml"><img src="/images/badges/rss-circle-small.png" alt="Rss" /></a></li>
	</ul>
</section>

<section>
  <h1>Categories</h1>
  <ul id="categories">
    <li class='category'><a href='/blog/categories/Conferences/'>Conferences (8)</a></li>
<li class='category'><a href='/blog/categories/FSharp/'>FSharp (3)</a></li>
<li class='category'><a href='/blog/categories/Katas/'>Katas (2)</a></li>
<li class='category'><a href='/blog/categories/StoryTeller/'>StoryTeller (14)</a></li>
<li class='category'><a href='/blog/categories/StructureMap/'>StructureMap (9)</a></li>
<li class='category'><a href='/blog/categories/Testing/'>Testing (20)</a></li>
<li class='category'><a href='/blog/categories/Uncategorized/'>Uncategorized (8)</a></li>
<li class='category'><a href='/blog/categories/dotnet/'>dotnet (65)</a></li>
<li class='category'><a href='/blog/categories/ruby/'>ruby (3)</a></li>
<li class='category'><a href='/blog/categories/sw-design/'>sw-design (13)</a></li>
<li class='category'><a href='/blog/categories/xUnitBDDExtensions/'>xUnitBDDExtensions (15)</a></li>

  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("bjoernrochel", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/bjoernrochel" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @bjoernrochel</a>
  
</section>

<section>
<h1>Disclaimer</h1>
<p>
The opinions expressed herein are my own personal opinions and do not necessarily represent the opinion of any other organization or person, including (but not limited to) my fellow employees, my employer, its clients or their agents. 
</p>
<p>
 Copyright &copy; 2011 - Björn Rochel
</p>
<section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2011 - Björn Rochel -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'bjro';
      
        

				//var disqus_developer = 1;
				var disqus_identifier = 'http://www.bjoernrochel.de/2009/01/30/verifying-indirect-outputs-with-rhinomocks-in-xunitbddextensions/';
				var disqus_url = 'http://www.bjoernrochel.de/2009/01/30/verifying-indirect-outputs-with-rhinomocks-in-xunitbddextensions/';
        var disqus_script = 'embed.js';
      

    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>







</body>
</html>
