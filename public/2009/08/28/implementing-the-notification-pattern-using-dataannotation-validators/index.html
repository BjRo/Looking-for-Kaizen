
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Implementing the Notification Pattern using DataAnnotation Validators - Dude, where's my Kaizen?</title>
  <meta name="author" content="Björn Rochel">

  
  <meta name="description" content="Some weeks ago a friend of mine told me aboutSystem.ComponentModel.DataAnnotations. It&#8217;s a relatively new addition tothe framework, mainly Asp. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.bjoernrochel.de/2009/08/28/implementing-the-notification-pattern-using-dataannotation-validators/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Dude, where's my Kaizen?" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

</head>

<body   >
  <header role="banner"><div id="logo">
	<img src="/images/kaizen.png" alt="Kaizen" title="Kaizen" />
</div>
<hgroup>
  <h1><a href="/">Dude, where's my Kaizen?</a></h1>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.bjoernrochel.de" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Implementing the Notification Pattern Using DataAnnotation Validators</h1>
    
    
      <p class="meta">
        





  



<time datetime="2009-08-28T15:38:24+02:00" pubdate  data-updated="true" >Aug 28<span>th</span>, 2009</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Some weeks ago a friend of mine told me about
<code>System.ComponentModel.DataAnnotations</code>. It&#8217;s a relatively new addition to
the framework, mainly Asp.net related (mh, was it Mvc or Asp.net Dynamic
Data? I&#8217;m sure he told me, but I can&#8217;t remember). Although I&#8217;m more
focussed on client side development (WinForms + WPF), what he told me
made me curious enough to spend some time with it in order to
investigate whether the DataAnnotation framework could be reused for
validation in a desktop app.</p>

<h2>Background</h2>

<p>What I was particulary interested in was whether I could use it in order to implement some sort
of declarative validation (for most of the standard cases) on my WPF
ViewModels. The usage I wanted to achieve was something similar to the
code shown in the next listing.</p>

<figure class='code'><figcaption><span>A ViewModel with valiation annotations</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">CustomerViewModel</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>     <span class="k">private</span> <span class="n">IValidator</span><span class="p">&lt;</span><span class="n">CustomerViewModel</span><span class="p">&gt;</span> <span class="n">_validator</span><span class="p">;</span>
</span><span class='line'>     <span class="k">private</span> <span class="n">NotificationCollection</span> <span class="n">_notifications</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="na">     [Required]</span>
</span><span class='line'><span class="na">     [MinLenght(3)]</span>
</span><span class='line'><span class="na">     [DisplayName(&quot;First name&quot;)]</span>
</span><span class='line'>     <span class="k">public</span> <span class="kt">string</span> <span class="n">FirstName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">     [Required]</span>
</span><span class='line'><span class="na">     [MinLenght(3)]</span>
</span><span class='line'><span class="na">     [DisplayName(&quot;Last name&quot;)]</span>
</span><span class='line'>     <span class="k">public</span> <span class="kt">string</span> <span class="n">LastName</span>  <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">     [Required(ErrorMessage=&quot;The field Email address is mandatory&quot;)]</span>
</span><span class='line'><span class="na">     [ValidEmail]</span>
</span><span class='line'><span class="na">     [DisplayName(&quot;Email address&quot;)]</span>
</span><span class='line'>     <span class="k">public</span> <span class="kt">string</span> <span class="n">EmailAddress</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">public</span> <span class="nf">CustomerViewModel</span><span class="p">(</span><span class="n">IValidator</span><span class="p">&lt;</span><span class="n">CustomerViewModel</span><span class="p">&gt;</span> <span class="n">validator</span><span class="p">)</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>            <span class="n">_validator</span> <span class="p">=</span> <span class="n">validator</span><span class="p">;</span>
</span><span class='line'>            <span class="n">_notifications</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NotificationCollection</span><span class="p">();</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">public</span> <span class="n">NotificationCollection</span> <span class="n">Notifications</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_notifications</span><span class="p">;}}</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">public</span> <span class="kt">bool</span> <span class="nf">IsValid</span><span class="p">()</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>            <span class="n">_notifications</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
</span><span class='line'>            <span class="n">_validator</span><span class="p">.</span><span class="n">Validate</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">_notifications</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">_notifications</span><span class="p">.</span><span class="n">ContainsErrors</span><span class="p">;</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Here is what I came up with in order to use the DataAnnotation Validators for this</h2>

<p>First of all, some basics. I&#8217;m going to demonstrate a (very simple)
implementation of the <code>Notification pattern</code> in this post. A detailed
explanation this pattern is a bit out of scope for this post, but
here&#8217;re some excellent resources for that:</p>

<ul>
<li><a href="http://martinfowler.com/eaaDev/Notification.html">The Notification Pattern</a> by Martin
Fowler</li>
<li><a href="http://codebetter.com/blogs/jeremy.miller/archive/2007/06/13/build-your-own-cab-part-9-domain-centric-validation-with-the-notification-pattern.aspx">Domain centric validation with the Notification Pattern</a> by Jeremy D. Miller</li>
</ul>


<p>We&#8217;re starting with a base class for our Notifications. It&#8217;s a simple
abstract class containing a message and a Source property. Besides that
it contains an implicit conversion to string.</p>

<figure class='code'><figcaption><span>Our notification abstraction</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">Notification</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>     <span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">_message</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">protected</span> <span class="nf">Notification</span><span class="p">()</span> <span class="p">:</span> <span class="k">this</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">,</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">)</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">protected</span> <span class="nf">Notification</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">)</span> <span class="p">:</span> <span class="k">this</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>            <span class="n">_message</span> <span class="p">=</span> <span class="n">message</span><span class="p">;</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">protected</span> <span class="nf">Notification</span><span class="p">(</span><span class="kt">string</span> <span class="n">source</span><span class="p">,</span> <span class="kt">string</span> <span class="n">message</span><span class="p">)</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>            <span class="n">Require</span><span class="p">.</span><span class="n">ArgumentNotNull</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s">&quot;source&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="n">Require</span><span class="p">.</span><span class="n">ArgumentNotNull</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">_message</span> <span class="p">=</span> <span class="n">message</span><span class="p">;</span>
</span><span class='line'>            <span class="n">Source</span> <span class="p">=</span> <span class="n">source</span><span class="p">;</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">public</span> <span class="kt">string</span> <span class="n">Source</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">protected</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">public</span> <span class="k">override</span> <span class="kt">string</span> <span class="nf">ToString</span><span class="p">()</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">_message</span><span class="p">;</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">public</span> <span class="k">static</span> <span class="k">implicit</span> <span class="k">operator</span> <span class="nf">string</span><span class="p">(</span><span class="n">Notification</span> <span class="n">notification</span><span class="p">)</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">notification</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Error is a simple class derived from Notification, which
contains no additional code.</p>

<figure class='code'><figcaption><span>Representing an error as a class</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">Error</span> <span class="p">:</span> <span class="n">Notification</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>     <span class="k">public</span> <span class="nf">Error</span><span class="p">(</span><span class="kt">string</span> <span class="n">source</span><span class="p">,</span> <span class="kt">string</span> <span class="n">message</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">public</span> <span class="nf">Error</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&#8217;ve seen some people implementing the Notification
pattern with a single Notification class and an enumeration specifying
the type of the Notification (Error, Warning, Info, etc.) but I prever
using classes for this. I think readability is way better (and shorter)
using classes. Decide for yourself:</p>

<figure class='code'><figcaption><span>Class based vs enumeration based implementation</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">bool</span> <span class="n">isError</span> <span class="p">=</span> <span class="n">notification</span> <span class="k">is</span> <span class="n">Error</span><span class="p">;</span>
</span><span class='line'><span class="c1">//versus</span>
</span><span class='line'><span class="kt">bool</span> <span class="n">isError</span> <span class="p">=</span> <span class="n">notification</span><span class="p">.</span><span class="n">Severity</span> <span class="p">==</span> <span class="n">Severity</span><span class="p">.</span><span class="n">Error</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&#8217;s very rare that you only have to validate one element / property. Mostly we&#8217;re
dealing with more than one elment beeing validated. Because of that it&#8217;s
useful to have a container or collection for Notifications. This gives
you a nice place for some additional functionality.</p>

<figure class='code'><figcaption><span>A container for Notifications</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">NotificationCollection</span> <span class="p">:</span> <span class="n">ObservableCollection</span><span class="p">&lt;</span><span class="n">Notification</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>     <span class="k">public</span> <span class="kt">bool</span> <span class="n">ContainsErrors</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>            <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">notification</span> <span class="p">=&gt;</span> <span class="n">notification</span><span class="p">.</span><span class="n">IsOfType</span><span class="p">&lt;</span><span class="n">Error</span><span class="p">&gt;());</span> <span class="p">}</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">public</span> <span class="kt">bool</span> <span class="n">ContainsWarnings</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>            <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">notification</span> <span class="p">=&gt;</span> <span class="n">notification</span><span class="p">.</span><span class="n">IsOfType</span><span class="p">&lt;</span><span class="n">Warning</span><span class="p">&gt;());</span> <span class="p">}</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Notification</span><span class="p">&gt;</span> <span class="n">AllNotificationsFor</span><span class="p">(</span><span class="kt">string</span> <span class="n">nameOfSource</span><span class="p">)</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">notification</span> <span class="p">=&gt;</span> <span class="kt">string</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">notification</span><span class="p">.</span><span class="n">Source</span><span class="p">,</span> <span class="n">nameOfSource</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">Ordinal</span><span class="p">));</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>While the first properties are pretty obvious, the last method probably needs some
explanation. It finds all notifications for a given source name. The
source in my implementation is the name of the property on the ViewModel
that was validated. Im currently using a little convention here.
Properties in WPF views have the same name as the ViewModel properties
they&#8217;re bound to. This makes it relatively easy to correlate those two
things (meaning deciding which Notification belongs to which UIElement).
Having set this up, let me walk you through the validator
implementation.</p>

<h2>A Validator<T> using DataAnnotations</h2>

<figure class='code'><figcaption><span>A dedicated Validator</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">Validator</span><span class="p">&lt;</span><span class="n">TElement</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IValidator</span><span class="p">&lt;</span><span class="n">TElement</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>     <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">PropertyValidator</span><span class="p">&gt;</span> <span class="n">Validators</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">static</span> <span class="nf">Validator</span><span class="p">()</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>            <span class="n">var</span> <span class="n">properties</span> <span class="p">=</span> <span class="k">typeof</span> <span class="p">(</span><span class="n">TElement</span><span class="p">).</span><span class="n">GetProperties</span><span class="p">(</span><span class="n">BindingFlags</span><span class="p">.</span><span class="n">Instance</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Public</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">Validators</span> <span class="p">=</span> <span class="n">from</span> <span class="n">property</span> <span class="k">in</span> <span class="n">properties</span>
</span><span class='line'>                   <span class="n">where</span> <span class="n">property</span><span class="p">.</span><span class="n">IsMarkedWith</span><span class="p">&lt;</span><span class="n">ValidationAttribute</span><span class="p">&gt;()</span>
</span><span class='line'>                   <span class="n">select</span> <span class="k">new</span> <span class="nf">PropertyValidator</span><span class="p">(</span><span class="n">property</span><span class="p">);</span>
</span><span class='line'>     <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The static constructor of the <code>Validator&lt;TElement&gt;</code> class uses
reflection to find all marked properties of the target type specified
via the generic type argument <code>TElement</code>. It searches for properties
marked at least with one derivate of the <code>System.ComponentModel.DataAnnotations.ValidationAttribute</code> and creates a
<code>PropertyValidator</code> for each match.</p>

<figure class='code'><figcaption><span>Validating an element</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="cp">#region IValidator&lt;TElement&gt; Members</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">Validate</span><span class="p">(</span><span class="n">TElement</span> <span class="n">element</span><span class="p">,</span> <span class="n">NotificationCollection</span> <span class="n">notifications</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>     <span class="n">Validators</span><span class="p">.</span><span class="n">Each</span><span class="p">(</span><span class="n">entry</span> <span class="p">=&gt;</span> <span class="n">entry</span><span class="p">.</span><span class="n">Validate</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">notifications</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#endregion</span>
</span></code></pre></td></tr></table></div></figure>


<p>The actual validation happens inside the Validate method. This method simply
uses all known <code>PropertyValidators</code> in order to validate the target
object.</p>

<figure class='code'><figcaption><span>The PropertyValidator class</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="cp">#region Nested type: PropertyValidator</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="k">class</span> <span class="nc">PropertyValidator</span> <span class="p">:</span> <span class="n">IValidator</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>     <span class="k">private</span> <span class="k">readonly</span> <span class="n">PropertyInfo</span> <span class="n">_property</span><span class="p">;</span>
</span><span class='line'>     <span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">_propertyDisplayName</span><span class="p">;</span>
</span><span class='line'>     <span class="k">private</span> <span class="k">readonly</span> <span class="n">IEnumerable</span> <span class="n">_propertyValidators</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">public</span> <span class="nf">PropertyValidator</span><span class="p">(</span><span class="n">PropertyInfo</span> <span class="n">property</span><span class="p">)</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>            <span class="n">_property</span> <span class="p">=</span> <span class="n">property</span><span class="p">;</span>
</span><span class='line'>            <span class="n">_propertyDisplayName</span> <span class="p">=</span> <span class="n">GetDisplayName</span><span class="p">(</span><span class="n">_property</span><span class="p">);</span>
</span><span class='line'>            <span class="n">_propertyValidators</span> <span class="p">=</span> <span class="n">GetValidators</span><span class="p">(</span><span class="n">property</span><span class="p">);</span>
</span><span class='line'>     <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>A <code>PropertyValidator</code> does some things internally when it&#8217;s created. First it determines the name for
the validated element which should be used in the UI. Since you probably
don&#8217;t want the user to see something like &#8220;FirstName is required&#8221; or
&#8220;SelectedCountry is required&#8221; I&#8217;m using <code>System.ComponentModel.Design.DisplayNameAttribute</code> here which can be used
to specify a UI-friendly name. If no <code>DisplayNameAttribute</code> is specified
on a property the validator uses the property name instead.</p>

<figure class='code'><figcaption><span>Getting the name that is displayed for a property</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">GetDisplayName</span><span class="p">(</span><span class="n">PropertyInfo</span> <span class="n">property</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>     <span class="k">if</span> <span class="p">(</span><span class="n">property</span><span class="p">.</span><span class="n">IsMarkedWith</span><span class="p">&lt;</span><span class="n">DisplayNameAttribute</span><span class="p">&gt;())</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">property</span><span class="p">.</span><span class="n">GetAttribute</span><span class="p">&lt;</span><span class="n">DisplayNameAttribute</span><span class="p">&gt;().</span><span class="n">DisplayName</span><span class="p">;</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="k">return</span> <span class="n">property</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>After it has determined the UI friendly display name it extracts all DataAnnotations <code>ValidationAttributes</code> from the property.
(Note: GetAttributes is an ExtensionMethod. Same applies to <code>IsMarkedWith</code> and <code>GetAttribute</code>)</p>

<figure class='code'><figcaption><span>Extracting all DataAnnotation validators</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">ValidationAttribute</span><span class="p">&gt;</span> <span class="n">GetValidators</span><span class="p">(</span><span class="n">PropertyInfo</span> <span class="n">property</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>     <span class="k">return</span> <span class="n">property</span><span class="p">.</span><span class="n">GetAttributes</span><span class="p">&lt;</span><span class="n">ValidationAttribute</span><span class="p">&gt;();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And here is the rest, which brings the whole thing to life. This code simply extracts the value from
the property, iterates over all known ValidationAttributes and checks
the value with them. When a <code>ValidationAttribute</code> signals that a value is
not valid, an error message is formatted with the UI-friendly name I
talked earlier about and the whole thing is stored as an Error.</p>

<figure class='code'><figcaption><span>Validating an element</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="cp">#region IValidator Members</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">void</span> <span class="nf">Validate</span><span class="p">(</span><span class="n">TElement</span> <span class="n">element</span><span class="p">,</span> <span class="n">NotificationCollection</span> <span class="n">notifications</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>     <span class="n">var</span> <span class="k">value</span> <span class="p">=</span> <span class="n">_property</span><span class="p">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="k">new</span> <span class="kt">object</span><span class="p">[]</span> <span class="p">{});</span>
</span><span class='line'>
</span><span class='line'>     <span class="n">_propertyValidators</span><span class="p">.</span><span class="n">Each</span><span class="p">(</span><span class="n">validator</span> <span class="p">=&gt;</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(!</span><span class="n">validator</span><span class="p">.</span><span class="n">IsValid</span><span class="p">(</span><span class="k">value</span><span class="p">))</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                   <span class="kt">string</span> <span class="n">formmattedErrorMessage</span> <span class="p">=</span> <span class="n">validator</span><span class="p">.</span><span class="n">FormatErrorMessage</span><span class="p">(</span><span class="n">_propertyDisplayName</span><span class="p">);</span>
</span><span class='line'>                   <span class="n">notifications</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">Error</span><span class="p">(</span><span class="n">_property</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">formmattedErrorMessage</span><span class="p">));</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>     <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#endregion</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Bottom line</h2>

<p>It&#8217;s pretty easy to combine the existing functionality provided by DataAnnotations with the
Notification Pattern. It just took me an hour to get to a working
solution which I consider pretty fast and which imho indicates an easy
to use framework. As you can imagine the hard part isn&#8217;t getting the
Notifications out of the model, but rather finding an unrepetative,
intuitive way to display them in the UI. In the past I&#8217;ve missed several
times the pit of success regarding this aspect. However I&#8217;m really
confident that my current solution is really Dry AND easy to use. In one
of the next posts I&#8217;m going to show how to combine Attached Behavior,
Styles and Templates in order to bring the Notifications described in
this post to the applications front door, the UI &#8230;</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">BjRo</span></span>

      





  



<time datetime="2009-08-28T15:38:24+02:00" pubdate  data-updated="true" >Aug 28<span>th</span>, 2009</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/dotnet/'>dotnet</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.bjoernrochel.de/2009/08/28/implementing-the-notification-pattern-using-dataannotation-validators/" data-via="bjoernrochel" data-counturl="http://www.bjoernrochel.de/2009/08/28/implementing-the-notification-pattern-using-dataannotation-validators/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
</div>

    
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
	<h1>About me</h1>
  <p><br/><img src="/images/bjro-eyes.jpg" alt="portrait" /></p>
	<p>
  My name is <strong>Björn Rochel</strong>.  I'm a 32 year old geek, who's crazy about software development, living in Cologne and
  currently working for <a href="http://www.intercomponentware.com">ICW</a> as a .NET Developer / Architect.
	</p>
	<ul class="badges">
		<li><a href="http://www.xing.com/profile/Bjoern_Rochel"><img src="/images/badges/xing2-small.png" alt="Xing" /></a></li>
		<li><a href="http://www.github.com/BjRo"><img src="/images/badges/github-small.png" alt="Github" /></a></li>
		<li><a href="http://www.twitter.com/bjoernrochel"><img src="/images/badges/twitter-square-small.png" alt="Twitter" /></a></li>
		<li><a href="/atom.xml"><img src="/images/badges/rss-circle-small.png" alt="Rss" /></a></li>
	</ul>
</section>

<section>
  <h1>Categories</h1>
  <ul id="categories">
    <li class='category'><a href='/blog/categories/Conferences/'>Conferences (8)</a></li>
<li class='category'><a href='/blog/categories/FSharp/'>FSharp (3)</a></li>
<li class='category'><a href='/blog/categories/Katas/'>Katas (2)</a></li>
<li class='category'><a href='/blog/categories/StoryTeller/'>StoryTeller (14)</a></li>
<li class='category'><a href='/blog/categories/StructureMap/'>StructureMap (9)</a></li>
<li class='category'><a href='/blog/categories/Testing/'>Testing (20)</a></li>
<li class='category'><a href='/blog/categories/Uncategorized/'>Uncategorized (7)</a></li>
<li class='category'><a href='/blog/categories/dotnet/'>dotnet (65)</a></li>
<li class='category'><a href='/blog/categories/ruby/'>ruby (3)</a></li>
<li class='category'><a href='/blog/categories/sw-design/'>sw-design (13)</a></li>
<li class='category'><a href='/blog/categories/xUnitBDDExtensions/'>xUnitBDDExtensions (15)</a></li>

  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("bjoernrochel", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/bjoernrochel" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @bjoernrochel</a>
  
</section>

<section>
<h1>Disclaimer</h1>
<p>
The opinions expressed herein are my own personal opinions and do not necessarily represent the opinion of any other organization or person, including (but not limited to) my fellow employees, my employer, its clients or their agents. 
</p>
<p>
 Copyright &copy; 2011 - Björn Rochel
</p>
<section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2011 - Björn Rochel -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'bjro';
      
        

				//var disqus_developer = 1;
				var disqus_identifier = 'http://www.bjoernrochel.de/2009/08/28/implementing-the-notification-pattern-using-dataannotation-validators/';
				var disqus_url = 'http://www.bjoernrochel.de/2009/08/28/implementing-the-notification-pattern-using-dataannotation-validators/';
        var disqus_script = 'embed.js';
      

    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>







</body>
</html>
